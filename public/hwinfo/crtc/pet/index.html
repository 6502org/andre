<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="author" content="André  Fachat">

<meta name="description" content="PET CRTC 6545 test programs">
<meta name="keywords" content="PET CRTC 6545">
<link rev="made" href="mailto:afachat@gmx.de">
<LINK REL="stylesheet" TITLE="Default" TYPE="text/css" HREF="../../../style.css">
<LINK REL="alternate stylesheet" TITLE="Advanced" TYPE="text/css" HREF="../../../advanced.css">
<script src="../../../jquery-1.4.2.min.js"></script><script src="../../../myscripts.js"></script><script>myUp="../../../";</script>

<title>PET CRTC 6545 Test Programs</title>
</head>
<body>
<div id="leftcol">
<DIV class="top" ID="menu">
<a class="m_homepage" href="../../../index.html">Homepage</a>
<ul class="menu0" >
<li class="separator">Commodore</li>
<li class="dir" id="m_petindex"><img src="../../../imgs/dir.png"/><a href="../../../petindex/index.html">CBM PETindex</a>

</li>
<li class="dir" id="m_cbmhw"><img src="../../../imgs/dir.png"/><a href="../../../cbmhw/index.html">CBM hardware and mods</a>
</li>
<li class="separator">Hardware</li>
<li class="dir" id="m_csa"><img src="../../../imgs/dir.png"/><a href="../../../csa/index.html">CS/A65 Caspaer and Gecko computer</a>
</li>
<li class="dir" id="m_hwinfo"><img src="../../../imgs/dir.png"/><a href="../../../hwinfo/index.html">ICs and Standards Info</a>
<ul class="menu1" >
<li class="dir" id="m_hwinfo_crtc"><img src="../../../imgs/dir.png"/><a href="../../crtc/index.html">CRTC 6545/6845</a>
<ul class="menu2" >
<li class="file"><img src="../../../imgs/file.png"/><a href="../internals/index.html">CRTC internals</a>
</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../pet/index.html">CBM PET test programs</a>
</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../crtc.html">CRTC operation</a></li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../diffs.html">Differences between models</a></li>
</ul>
</li>
<li class="dir" id="m_hwinfo_ls610"><img src="../../../imgs/dir.png"/><a href="../../ls610/index.html">74LS610 MMU</a>
</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../scsi.html">SCSI</a></li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../i2c.html">I2C</a></li>
</ul>
</li>
<li class="dir" id="m_mischw"><img src="../../../imgs/dir.png"/><a href="../../../mischw/index.html">Other hardware (e.g. tools)</a>
</li>
<li class="separator">Software</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../../osa/index.html">GeckOS operating system</a>
</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../../lib6502/index.html">Lib6502 standard</a>
</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../../o65/index.html">O65 file format</a>
</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../../misc/index.html">Misc software</a>
</li>
<li class="separator">Knowledge Bits</li>
<li class="dir" id="m_icapos"><img src="../../../imgs/dir.png"/><a href="../../../icapos/index.html">Computer/OS Architecture</a>
</li>
<li class="dir" id="m_icaphw"><img src="../../../imgs/dir.png"/><a href="../../../icaphw/index.html">6502 Hardware Bits</a>
</li>
<li class="separator">Misc</li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../../contact.html">Contact</a></li>
<li class="file"><img src="../../../imgs/file.png"/><a href="../../../sneak.html">Sneak preview</a></li>
</ul>

</DIV>
		<div class="top" id="browser">
			Site has been tested with Firefox 3.6, IE6, IE8 and Google Chrome 5 on Windows XP, as well as Firefox 3.5, Google Chrome 5 and konqueror 4.3.5 on (SuSE) Linux 11.2
		</div>
</div>
<div id="rightcol">
<div class="top" id="google"><form method="get" action="http://www.google.com/search">
<input type="text" name="q" size="20" maxlength="255" value=""><input type="submit" value="Google Search my site"><input type="hidden" name="sitesearch" value="www.6502.org/users/andre">
</form></div>
<div class="top" id="twitter">
		            Follow my 8-bit tweets on
		            <a href="http://search.twitter.com/search?q=&amp;ands=&amp;phrase=&amp;ors=&amp;nots=&amp;tag=8bit&amp;lang=all&amp;from=afachat&amp;to=&amp;ref=&amp;near=&amp;within=15&amp;units=mi&amp;since=&amp;until=&amp;rpp=15"><img src="http://twitter-badges.s3.amazonaws.com/twitter-b.png" alt="twitter"></a>
</div>
<div class="top" id="forum">
<p>Discuss my site on <a href="http://forum.6502.org/viewtopic.php?t=956">this 6502.org forum thread</a></p>
<p>(Forum registration required to post)</p>
</div>
</div>
<div id="midcol">
<DIV class="top" ID="breadcrumbs">
<a href="../../../index.html">Homepage</a>
&gt;&gt; <a href="../../index.html">ICs and Standards Info
</a>&gt;&gt; <a href="../index.html">CRTC 6545/6845
</a>&gt;&gt; CBM PET test programs
</DIV>
<DIV class="top" ID="content">
<h1>PET CRTC 6545 Test Programs</h1>
<p class="copyright">(C)
1999-2006 André  Fachat</p> 
<div class="overview">
	<p>
The programs in this directory are a number of test programs for the CRTC in the Commodore PET computers. Well, "test program" is probably a bit to much. In fact they demonstrate some timing issues and how the internal registers can be used to produce some effects.
	</p>
<p>
The files with the ending ".a65" are the source files. They are used for my own xa65 crossassembler, but should be pretty standard anyway.
	</p>
<p>
The programs have been tested with my european CBM 8296D. The ROMs set the CRTC to 59 cycles/rasterline and 339 rasterlines, which makes 20001 cycles/frame, or 50Hz frame rate. The vertical sync position changes, though, between upper/lower case mode and graphics mode. (A dump of the editor ROM - for the VICE (&gt; 1.0) emulator for example - is found in the file <a href="edit">edit</a>).
	</p>
<p>
The PET screens are sensitive to the timing. If they get the wrong one, it might break the screen!!! Currently there is no test done for the ROM version, the program does not check whether what it does is ok!
	</p>
<p>
DO NOT RUN those programs! They are provided for educational purposes only! There is NO WARRANTY attached to those programs. You are warned.
	</p>
  </div>
<DIV ID="toc">
<H2>Table of content</H2>
<dir>
<li><a href="#crtc1">Vertical Retrace</a></li>
<li><a href="#crtc3">Uncompensated HSync</a></li>
<li><a href="#crtc4">Compensated HSync</a></li>
<li><a href="#crtc6">Chars per line</a></li>
<li><a href="#crtc10">Character Height</a></li>
<li><a href="#crtc13">Vertical boarders</a></li>
</dir>
</DIV>
<h2><a name="crtc1">Vertical Retrace</a></h2>
<p>
<p>
Those two programs demonstrate the timing of the vertical retrace
for upper/lowercase and graphics modes respectively.
</p><p>
The PET standard mode sets PIA1, CA1 to trigger the IRQ at the high-low
transistion of the vertical drive signal. This is the inverted 
CRTC VSync signal. This signal thus generates the system interrupt.
As there is no other way to synchronize the CPU with the CRTC,
this interrupt is used. The standard mode then triggers the IRQ at
the leading edge of the vertical sync signal of the CRTC.
</p><p>
The programs invert the top character line of the screen around the
time when the CRTC reads this line for display. When the screen changes
from inverted to not-inverted at least on my screen there is a 
very small vertical line in the scanline. This way it can be seen
when the CRTC reads the inverted char and when not.
</p><p>
The timings, that are explained in the source files, show that
the IRQ cycle is stable across the time and can reliably be computed
- in relation to the first screen cycle - as:
</p><p><pre>
IRQcycle = cycles/rasterline * rasterlines/char * vsync_position
where 
	cycles/rasterline = CRTCreg[0] + 1
	rasterlines/char = CRTCreg[9] + 1
	vsync_position = CRTCreg[7] 
</pre>
Substract that from the total number of 
<pre>
cycles/frame = cycles/rasterline * 
		(characterlines * rasterlines/char + vertical_adjust)
</pre>where<pre>
	characterlines = CRTCreg[4]
	vertical_adjust = CRTCreg[5]
</pre>
and you get the number of cycles the raster interrupt is triggered
_before_ the first screen cycle.
</p>
    </p>
<h3>Files</h3>
<table>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc1.a65">crtc1.a65</A></TD>
</TR>
<TR CLASS="R0">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc2.a65">crtc2.a65</A></TD>
</TR>
</table>
<ul></ul>
<h2><a name="crtc3">Uncompensated HSync</a></h2>
<p>
<p>
This program moves the next-to-last line two character to the right.
It does this by setting the VIA interrupt to somewhere in the
last rasterline of the 22nd character line. Then the position of the
HSync is changed. The program then busy-loops to the last rasterline
of the 23rd charline and resets the hsync value.
</p><p>
Unfortunately the CRT electronics does not cope very well with the
changed Hsync position. The position overshoots in the first changed
rasterline, goes back to far in the second, and forwards again.
This happens at both changes. The characters are disturbed
in the 23rd and the 22nd character line.
This means that this effect is probably not very useful. 
</p><p>
A screen shot shows the cursor in the 22nd line as well as the diagonal
line of digits with the distortion.
</p><p>
<a href="crtc3.png"><img src="crtc3.png" alt="crtc3.png" width="30%"></a>
</p>
    </p>
<h3>Files</h3>
<table>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc3.a65">crtc3.a65</A></TD>
</TR>
</table>
<ul></ul>
<h2><a name="crtc4">Compensated HSync</a></h2>
<p>
<p>
Those two programs implement the side-shift by adjusting the 
line length of the line before the shift, such that the hsync
timing does not change for the CRT:
</p><p>
The line before the shift is lengthened by one cycle.
The first shifted line is set to standard length again, but
hsync is now set one cycle earlier.
The last shifted line is then shortened by one cycle to adjust
for the total number of cycles, and the first again unshifted
line is set to standard hsync position and length again.
</p><p>
This way the hsync timing shows no phase shift to the CRT electronics,
thus no real disturbance.
</p><p>
crtc4 (see below) moves the line to the right, crtc5 to the left. Also crtc5 
uses VIA T2 instead of VIA T1, but this did not help with the 
use of IEEE488 during the demo (crashes :-(
</p><p>
<a href="crtc4.png"><img src="crtc4.png" alt="crtc4.png" width="30%"></a>
</p>
    </p>
<h3>Files</h3>
<table>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc4.a65">crtc4.a65</A></TD>
</TR>
<TR CLASS="R0">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc5.a65">crtc5.a65</A></TD>
</TR>
</table>
<ul></ul>
<h2><a name="crtc6">Chars per line</a></h2>
<p>
<p>
Those test programs demonstrate the rasterline timing with 
respect to the number of visible chars/line. One first remark:
The memory pointer where to read the character data from is
increased by the number of visible characters in each line.
Thus changing the length of the charline changes the position
of the first char of a line in memory.
</p><p>
crtc6 and crtc7 set the number of visible chars to 20 (by setting 
register 1 to 10), but _after_ the 20th char has been displayed.
This means that in this rasterline the current column never becomes
the value of register 1. Thus after the 80th column the display
continues, even during the horizontal retrace. The data is taken
from the next charline, as the memory pointer is still increased.
crtc6 does so at the last rasterline of the 23rd charline.
This has another consequence, as the memory pointer for the 
start of the next charline is not updated! The charline is repeated, 
but this time only 20 chars long.
</p><p>
Therefore in this picture the cursor is two characters high.
</p><p>
<a href="crtc6.png"><img src="crtc6.png" alt="crtc6.png" width="30%"></a>
</p><p>
crtc7 does so at the first rasterline of the 24th charline. So only
the first rasterline of the 24th charline is displayed over the 
horizontal retrace.
</p><p>
crtc8 limits the number of columns to 60, by writing 30 to register
1. This time the register is updated before the position is reached
by the raster beam. However, this time it is done one rasterline 
early. Thus the 24th charline repeats the last 20 char of the 23rd 
charline, where the last rasterline is missing for the last 20 chars.
The last rasterline of the 24th charline is then 80 cols long.
Of those chars only the last rasterline is seen, as the next line
continues where the last rasterline of the previous line ends.
crtc9 then does the correct timing.
</p>
    </p>
<h3>Files</h3>
<table>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc6.a65">crtc6.a65</A></TD>
</TR>
<TR CLASS="R0">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc7.a65">crtc7.a65</A></TD>
</TR>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc8.a65">crtc8.a65</A></TD>
</TR>
<TR CLASS="R0">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc9.a65">crtc9.a65</A></TD>
</TR>
</table>
<ul></ul>
<h2><a name="crtc10">Character Height</a></h2>
<p>
<p>
Those three programs try to change the character height in the next 
to last character line. The first attempt sets the character height
at the first rasterline of the 24th charline to the height 4.
After 8 rasterlines the height is set back to 8, then it adjusts the 
vertical rasterline adjust to get back to the right timing. 
But due to this adjustment the position of the vertical sync changes.
Thus the position of the IRQ in the frame changes 
and in the next frame the height changes to 4  between the 
4th and the 8th rasterline. It is set back to 8 after the 8th
rasterline. This means that the compare between the current 
rasterline and the register is never reached - the charline
is then expanded to 32 rasterline, the maximum value. 
Because the compare is not reached, the next charline displays
the enlarged rasterline again!
</p><p>
In the "normal" PET, i.e. 8032 all rasterlines above the 8th
are set to blank by the hardware. 
In the 8296 board the RA4 line is used as an additional RAM address 
line. Only RA3 is used to blank the rasterline, thus rasterlines
0-7 show the normal characters, 8-15 are blank, 16-23 show
the contents of some other part of the RAM, and rasterlines
24-31 of a char are blank again.
</p><p>
<a href="crtc10.png"><img src="crtc10.png" alt="crtc10.png" width="30%"></a>
</p><p>
In this picture of crtc10 the RA4 line used as in the 8296 (only the memory adress
during the single character line (with the middle "2") is wrong - a bug
in VICE...). On a normal 8032 this single line would be blank too.
What seems to be a short vertical blanked line is the cursor, that is
displayed in three lines here.
</p><p>
crtc11 gets the interrupt one rasterline earlier, and with the 
4 rasterline adjust the height change takes place before the 
4th rasterline is reached. I.e. the compare is reached and the 
next charline then has a height of 4.
</p><p>
crtc12 gets the interrupt again at the first rasterline of the 
charline. It changes only one charline to 4 rasterline by waiting
4 rasterlines to set the height to 8 again. It does not
adjust the vertical timing, though, so the total frame
timing is different (4 rasterlines short). However, the 
interrupt timing is not changed, so this works.
</p>
    </p>
<h3>Files</h3>
<table>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc10.a65">crtc10.a65</A></TD>
</TR>
<TR CLASS="R0">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc11.a65">crtc11.a65</A></TD>
</TR>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc12.a65">crtc12.a65</A></TD>
</TR>
</table>
<ul></ul>
<h2><a name="crtc13">Vertical boarders</a></h2>
<p>
<p>
This test one opens the vertical borders by writing a value into
the vertical displayed rows register that is lower than the 
row counter. After the counter has passed the original value,
this original value is set to the register again.
</p><p>
<a href="crtc13.png"><img src="crtc13.png" alt="crtc13.png" width="30%"></a>
</p><p>
What is not seen here is the display during the vertical retrace.
This retrace display can disturb the normal screen because it
is overlayed over the original picture (this is not emulated in the VICE 
emulator that is used to capture these pictures at this time).
</p><p>
This effect can actually much easier be done by 
a POKE 59520, 6: POKE 59521, 64 :-)
(If you use VICE, do a PRINT CHR$(142) before the pokes).
</p>
    </p>
<h3>Files</h3>
<table>
<TR CLASS="R1">
<TD><IMG SRC="../../../imgs/file_src.gif" ALT="src"></TD>
<TD><A HREF="crtc13.a65">crtc13.a65</A></TD>
</TR>
</table>
<ul></ul>
<h2>Disclaimer</h2>
<p>
All Copyrights are acknowledged.
The information here is provided under the terms of the
GNU Public License version 2 unless noted otherwise.
  </p>
<hr>
<p>Return to <a href="../../../index.html">Homepage</a></p>
	
  </DIV>
</div>
</body>
</html> 

