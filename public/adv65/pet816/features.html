<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="author" content="André  Fachat">

<meta name="description" content="Commodore PET 65816 CPU replacement board explained">
<meta name="keywords" content="Commodore PET 6502 65816 cpu replacement board">
<link rev="made" href="mailto:afachat@gmx.de">
<LINK REL="stylesheet" TITLE="Default" TYPE="text/css" HREF="../../style.css">
<LINK REL="alternate stylesheet" TITLE="Advanced" TYPE="text/css" HREF="../../advanced.css">
<script src="../../jquery-1.4.2.min.js"></script><script src="../../myscripts.js"></script><script>myUp="../../";</script>

<title>65816 board features</title>
</head>
<body><div id="mainbox">
<div id="leftcol">
<div id="menu" class="top">
<div class="tophead">navigate</div>
<div id="filter"><form action="#">
<img id="expand" src="../../imgs/expand.png"><img id="collapse" src="../../imgs/collapse.png"><input size="8" name="filter" value="filter" type="text"><img id="cancel" src="../../imgs/cancel.png">
</form></div>
<div id="mtree">
<a class="m_homepage" href="../../index.html">Homepage</a>
<ul class="menu0" >
<li class="separator">Commodore</li>
<li class="dir" id="m_petindex"><img src="../../imgs/dir.png"/><a href="../../petindex/index.html">CBM PETindex</a>
</li>
<li class="dir" id="m_cbmhw"><img src="../../imgs/dir.png"/><a href="../../cbmhw/index.html">CBM hardware and mods</a>
<ul class="menu1" >
<li class="dir" id="m_cbmhw_pet816"><img src="../../imgs/dir.png"/><a href="../pet816/index.html">Speed up your PET!</a>
<ul class="menu2" >
<li class="file"><img src="../../imgs/file.png"/><a href="features.html" class="mcurrent">Board Features</a></li>
<li class="file"><img src="../../imgs/file.png"/><a href="works.html">How it works</a></li>
</ul>
</li>
<li class="dir" id="m_cbmhw_ryofat40"><img src="../../imgs/dir.png"/><a href="../ryofat40/index.html">Build your own PET replica!</a>
</li>
<li class="dir" id="m_cbmhw_ryo1581"><img src="../../imgs/dir.png"/><a href="../ryo1581/index.html">Build your own VC1581 replica!</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../c64csa/index.html">CS/A adapter for C64</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../petcsa/index.html">CS/A adapter for PETs</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../kernal/index.html">C64 kernal modifications</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../scsi/index.html">CBM SCSI interfaces</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../ieee488/index.html">IEEE488 interfaces</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../hwmods.html">My Hardware mods</a></li>
<li class="link"><img src="../../imgs/link.png"/><a href="../../icap/c64ser.html">UART serial interface</a></li>
</ul>
</li>
<li class="separator">Hardware</li>
<li class="dir" id="m_csa"><img src="../../imgs/dir.png"/><a href="../../csa/index.html">CS/A65 Caspaer and Gecko computer</a>
</li>
<li class="dir" id="m_hwinfo"><img src="../../imgs/dir.png"/><a href="../../hwinfo/index.html">ICs and Standards Info</a>
</li>
<li class="dir" id="m_mischw"><img src="../../imgs/dir.png"/><a href="../../mischw/index.html">Other hardware (e.g. tools)</a>
</li>
<li class="separator">Software</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../../osa/index.html">GeckOS operating system</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../../lib6502/index.html">Lib6502 standard</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../../o65/index.html">O65 file format</a>
</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../../misc/index.html">Misc software</a>
</li>
<li class="separator">Knowledge Bits</li>
<li class="dir" id="m_icapos"><img src="../../imgs/dir.png"/><a href="../../icapos/index.html">Computer/OS Architecture</a>
</li>
<li class="dir" id="m_icaphw"><img src="../../imgs/dir.png"/><a href="../../icaphw/index.html">6502 Hardware Bits</a>
</li>
<li class="separator">Misc</li>
<li class="file"><img src="../../imgs/file.png"/><a href="../../contact.html">Contact</a></li>
<li class="file"><img src="../../imgs/file.png"/><a href="../../sneak.html">Sneak preview</a></li>
<li class="file"><img src="../../imgs/file.png"/><a href="../../design.html">Web design</a></li>
</ul>

</div>
		</div>
<div class="top" id="browser">
<div class="tophead">browser</div>
<div>
			Site has been tested with a number of browsers and systems. Javascript required for advanced menu, but degrades gracefully without Javascript.
			</div>
</div>
</div>
<div id="rightcol">
<div class="top" id="google">
<div class="tophead">search</div>
<div><form method="get" action="http://www.google.com/search" target="_blank">
<input type="text" name="q" size="10" maxlength="255" value=""><input class="advbutton" type="submit" value="Search my site"><br>(Google, in new window)
	                        <input type="hidden" name="sitesearch" value="www.6502.org/users/andre">
</form></div>
</div>
<div class="top" id="twitter">
<div class="tophead">follow</div>
<div>
		            Follow my 8-bit tweets on<br><a target="_blank" href="http://search.twitter.com/search?q=&amp;ands=&amp;phrase=&amp;ors=&amp;nots=&amp;tag=8bit&amp;lang=all&amp;from=afachat&amp;to=&amp;ref=&amp;near=&amp;within=15&amp;units=mi&amp;since=&amp;until=&amp;rpp=15"><img src="http://twitter-badges.s3.amazonaws.com/twitter-b.png" alt="twitter"></a><br> (In new window)
		</div>
</div>
<div class="top" id="forum">
<div class="tophead">discuss</div>
<div>
<p>Discuss my site on <a class="extlink" target="_blank" href="http://forum.6502.org/viewtopic.php?t=956">this 6502.org forum thread</a></p>
<p>(Forum registration required to post)</p>
</div>
</div>
<div class="top" id="hot">
<div class="tophead">Hot!</div>
<div>
<p>Dive into the retro feeling and build yourself a <a href="../../cbmhw/ryofat40/index.html">Commodore PET replica</a></p>
<p>Need more speed? Speed up your 6502 computer with this <a href="../../cbmhw/pet816/index.html">10&nbsp;MHz 6502 CPU replacement board</a></p>

		</div>
</div>
</div>
<div id="midcol">
<DIV class="top" ID="breadcrumbs">
<a href="../../index.html">Homepage</a>
&gt;&gt; <a href="../index.html">CBM hardware and mods</a>&gt;&gt;  <a href="index.html">Speed up your PET!
</a>&gt;&gt;  Board Features</DIV>
<DIV class="top" ID="content">
<a name="topanchor"></a><h1>65816 board features</h1>
<p class="copyright">(C)
2010-2010 André  Fachat</p> 
<div class="overview">
	<p>This page describes the features of the 65816 board,
	as well as the register settings in detail.
	</p>
<p>
	Please note that "system bus" refers to the 6502 bus connector.
	</p>
  </div>
<DIV ID="toc">
<h2>Table of content</h2>
<div class="toplink"><a href="#top">Top</a></div>
<dir>
<li><a href="#hw">Hardware Features</a></li>
<dir>
<li><a href="#ics">ICs</a></li>
<li><a href="#jumpers">Jumpers and Connectors</a></li>
</dir>
<li><a href="#sw">Software</a></li>
<dir>
<li><a href="#control">Control Register</a></li>
<li><a href="#memmap">Memory Map</a></li>
<li><a href="#speedmap">Speed Map</a></li>
<li><a href="#clock">Clock register</a></li>
</dir>
</dir>
</DIV>
<h2><a name="hw">Hardware Features</a></h2>
<div class="toplink"><a href="#top">Top</a></div>
<p>This section describes the hardware features of the board.
     </p>
<H3><a name="ics">ICs</a></H3>
<p><p>Looking at the board <a href="pet_cpu816-v1.2b-brd.png">layout</a> you can see that
	of course it has the 65816 CPU, but also 2 RAM ICs with 512k each, and a socket for a
	ROM chip of between 32k and 512k. A 50MHz oscillator gives the clocks.
	Also the board has three driver ICs (2 '273, 1 '245), one latch (a '573), and a comparator (a '688).
	The main glue of the board is of course the Xilinx CPLD. The functionality of this IC is not 
	fixed, but can be programmed using VHDL for example, a hardware description logic. It
	can contain the equivalent of a whole eurocard of standard logic ICs (depending on the ICs...)
	</p>
	<p>In the <a href="diagram.gif">block diagram</a> you can see how these ICs fit together.</p>
	<p>The two RAM chips of course implement the 1MByte RAM. The ROM is in-place-programmable
	(when using the correct Flash-PROM that is - I am currently using an Atmel 29C010 128k PROM).
	</p><p>
	The '573 is the "usual" latch to capture the upper 8 address bits A16-A23 from the
	65816's data bus during phi1. It is controlled by the CPLD to be transparent during phi1, 
	then latch the value and hold it constant during phi2.
	</p><p>
	The '273s implement the address driver between the 65816 bus and the slow system bus (the
	6502 connector). This has to be a '273 as this is the only IC that has a reset line to 
	set all outputs to low. I use this to read from address 0 as long as the CPU works in the
	on-board RAM or ROM.
	</p><p>
	The '245 is the data bus driver. It decouples the 65816 and the system data bus. 
	</p><p>
	The '688 finally is an address selector for address lines A4-A11 on the system bus.
	It is used to select two addresses in the I/O range for the CPLD's control and clock
	registers.
	</p>
	</p>
<H3><a name="jumpers">Jumpers and Connectors</a></H3>
<p><p>
	The board has a number of jumpers and connectors:</p>
	<ul>
	<li>JP1: BOOTROM - when set to on, the on-board ROM is mapped into the lowest 64k
		address space upon reset, so the board can take the system over</li>
	<li>JP2: NOROM - this jumper connects PIN 5 of the system (6502) bus connector
		to the CPLD. The Commodore PET uses this pin to disable the built-in ROMs.
		Currently not used in the CPLD.</li>
	<li>JP4: CA18 - allows to use a smaller ROM by connecting VCC to ROM pin 1</li>
	<li>JP5: CA17 - allows to use a smaller ROM by connecting VCC to ROM pin 30</li>
	<li>JP6: CA15 - allows to use a smaller ROM by connecting VCC to ROM pin 3</li>
	<li>JP7: IO1 - switches between $ExFF and $ExBF I/O for the CPLD</li>
	<li>JP8: IO2 - switches between $E(F/C)xF and $E(B/8)xF I/O for the CPLD</li>
	<li>JP9: IO3 - switches between $E(F/B)xF and $E(C/8)xF I/O for the CPLD</li>
	<li>JP10: AUXCONF - config input into CPLD, currently unused</li>
	<li>JP11: DIAG - single pin, output from CPLD - used for diagnostics signals</li>
	</ul>
	<ul>
	<li>P1: 6502 system bus</li>
	<li>JP3: pwr - additional power supply</li>
	<li>SV1: JTAG - programming connector for the CPLD</li>
	</ul>
	</p>
<h2><a name="sw">Software</a></h2>
<div class="toplink"><a href="#top">Top</a></div>
<p>This section describes the software-side features of the board. These features
	are implemented as part of the CPLD logic.
     </p>
<H3><a name="control">Control Register</a></H3>
<p><p>The CPLD implements a control register at the address $ExyF, where "xy" is determined
	by the jumper settings JP7/8/9. Unfortunately this register currently is write-only.
	Here is a description of the control register bits:</p>
	<table border="1" class="content" width="80%">
		<tr>
<th>Bit</th>
<th>Value</th>
<th>Name</th>
<th>Description</th>
<th>Init value</th>
<th>Notes</th>
</tr>
		<tr>
<td>7</td>
<td>128</td>
<td>PRGROM</td>
<td>When set, allows write access to the built-in ROM. Note that specific algorithms are required to do the programming, random access does not work</td>
<td>0</td>
</tr>
		<tr>
<td>6</td>
<td>64</td>
<td>BOOTROM</td>
<td>When set, the lowest 64k CPU address space are mapped to the built-in ROM (except video and I/O, see above)</td>
<td>Bootrom jumper</td>
<td>Note this allows to unmap the system ROM after boot by setting this bit to 0. Only the initial value is taken from the Bootrom jumper.</td>
</tr>
		<tr>
<td>5</td>
<td>32</td>
<td>SLOW64K</td>
<td>When set, the lowest 64k CPU address space are mapped to the system bus (6502 connector)</td>
<td>1</td>
</tr>
		<tr>
<td>4</td>
<td>16</td>
<td>SLOWCLK</td>
<td>When set, use the system clock even on fast memory</td>
<td>1</td>
</tr>
		<tr>
<td>3</td>
<td>8</td>
<td>HIDEBOGUS</td>
<td>When set, hide the CPU's bogus cycles - as indicated by VPA and VDA both 0 - from the system bus when possible.</td>
</tr>
		<tr>
<td>2</td>
<td>4</td>
<td>FASTVREAD</td>
<td>When set, read the video RAM area from the fast RAM (writes still go to the slow system RAM)</td>
</tr>
		<tr>
<td>1,0</td>
<td>2,1</td>
<td>WPROTECT</td>
<td>Write protect upper parts of the lowest 64k of FastRAM
			<table>
<tr>
<th>Value</th>
<th>Protected Area</th>
</tr>
				<tr>
<td>00</td>
<td>None</td>
</tr>
				<tr>
<td>01</td>
<td>$A000-$FFFF</td>
</tr>
				<tr>
<td>10</td>
<td>$C000-$FFFF</td>
</tr>
				<tr>
<td>11</td>
<td>$E000-$FFFF</td>
</tr>
			</table>
		</td>
<td>00</td>
</tr>
	</table>
	</p>
<ul><li>
<a href="http://www.zimmers.net/anonftp/pub/cbm/firmware/computers/pet/d/rom-1.html" target="_blank" class="extlink">Original ROMs disassembly</a> </li></ul>
<H3><a name="memmap">Memory Map</a></H3>
<p><p>This section describes the memory map of the system. As there are some jumper settings
		that influence the memory map, it is best shown in a table.</p>
		<table class="content" border="1">
<tr>
<th>Memory area</th>
<th>Range</th>
<th>no BOOTROM, no SLOW64k</th>
<th>BOOTROM, no SLOW64k</th>
<th>no BOOTROM, SLOW64k</th>
<th>Notes</th>
</tr>
			<tr>
<th>$000000-$007fff</th>
<td>32k</td>
<td>FastRAM</td>
<td>BootROM</td>
<td>system bus</td>
<td>Writes always also go to FastRAM (write through)</td>
</tr>
			<tr>
<th>$008000-$0087ff</th>
<td>2k</td>
<td colspan="3">system bus (video memory) $8000-$87ff</td>
<td>Note: If the FASTVREAD control register bit is set, only writes go to the system bus (and write through to FastRAM), but reads only go to FastRAM.</td>
</tr>
			<tr>
<th>$008800-$00e7ff</th>
<td>24k</td>
<td>FastRAM</td>
<td>BootROM</td>
<td>system bus</td>
<td>Writes always also go to FastRAM (write through)</td>
</tr>
			<tr>
<th>$00e800-$00efff</th>
<td>2k</td>
<td colspan="3">system bus (io) $e800-$efff</td>
<td>Writes always also go to FastRAM (write through)</td>
</tr>
			<tr>
<th>$00f000-$00ffff</th>
<td>4k</td>
<td>FastRAM</td>
<td>BootROM</td>
<td>system bus</td>
<td>Writes always also go to FastRAM (write through)</td>
</tr>
			<tr>
<th>$010000-$0fffff</th>
<td>960k (2*512k-64k)</td>
<td colspan="3">FastRAM</td>
</tr>
			<tr>
<th>$100000-$dfffff</th>
<td></td>
<td colspan="3">---</td>
</tr>
			<tr>
<th>$e00000-$efffff</th>
<td>1024k</td>
<td colspan="3">system bus (mirror)</td>
</tr>
			<tr>
<th>$f00000-$f7ffff</th>
<td>512k</td>
<td colspan="3">FastRAM mirror from $000000-$07ffff</td>
</tr>
			<tr>
<th>$f80000-$ffffff</th>
<td>512k</td>
<td colspan="3">ROM</td>
</tr>
		</table>
	<p>Some things should probably be explained:</p>
	<p>There is a FastRAM mirror in $f00000. This is used to copy the slow system bus memory 
	to FastRAM. Normally the FastRAM is written through when the system bus is written to. 
	But when copying the ROM from the 8296 to the FastRAM by copying the ROM in-place, the
	system hang: the 8296 has a write-only register at $fff0, writing the value read from the
	ROM there hangs the system. So to be sure you have to write to an unmirrored FastRAM - the
	mirror at $f00000.</p>
	<p>The system bus mirror is there to access the slow system bus even when the lowest 64k
	are running in FastRAM. I made the mirror 16 times the 64k system bus, for a total of 1MByte,
	to stay "compatible" with my CS/A65 65816 CPU card. This may also be good for future expansions.
	</p>
	</p>
<H3><a name="speedmap">Speed Map</a></H3>
<p><p>Although there is a dedicated "fast" and a dedicated "slow" bus (65816 vs. system bus), 
	the CPU speed does not completely align with these borders. There are two types of access,
	"slow" and "fast". Slow is always synchronized with the system bus PHI2 clock. Fast accesses
	are independent from the system bus clock and the actual speed is determined by the clock
	register.
	</p><p>
	If the system bus accessed, of course the CPU is slowed down and synchronized with the slow
	system bus PHI2 clock, to perform the access. But also the ROM is accessed with the slow
	access method - so ordinary PROMs can be used. 
	</p><p>
	The CPLD's control and clock registers are accessed from the CPU's fast bus, but the access
	is actually done slow, as the I/O address comparator is connected to the slow bus.
	</p><p>
	All that changes when SLOWCLK is set in the control register. Then all accesses, even to
	FastRAM, no matter what address are slow. This way you can easily use code that requires to
	runs at exactly the same clock than the original system.
	</p>
	</p>
<H3><a name="clock">Clock register</a></H3>
<p><p>The CPLD not only implements a control register, but also a clock register
	at the address $ExyE, where "xy" is determined
        by the jumper settings JP7/8/9. Unfortunately also this register currently is write-only.
	</p><p>
	This clock register determines the speed of the actual fast accesses.
	Speed is determined by the lowest 5 bit, that work as a counter latch.
	In general the speed can be determined by calculating:
	<pre>
	FClk = 50MHz / (clklatch + 1)
	</pre>
	where clklatch is the value of the lowest 5 bits in the control register. Here is a small
	comparison between register values and clock speeds (for the 50MHz oscillator used)
	for some latch values:</p>
	<table border="1">
	<tr>
<th>latch value</th>
<th>clock speed</th>
<th> </th>
</tr>
	<tr>
<td>15</td>
<td>3.1</td>
<td>Default</td>
</tr>
	<tr>
<td>9</td>
<td>5</td>
</tr>
	<tr>
<td>5</td>
<td>8.3</td>
</tr>
	<tr>
<td>4</td>
<td>10</td>
</tr>
	</table>
	<p>Please note that you should not make the fast clock slower than the system clock,
	otherwise the system will hang!</p>
	<p>Additionally the clock register contains the "fastmode" bit in bit 7.
	This bit is set by default. Its working is a bit difficult to explain.
	The board detects whether the next access is slow at a fixed point after 
	system bus PHI2 going low. If fastmode is set, this detection is done very quickly,
	so that at most one fast half cycle fits before the detection. This means
	that the system clock can be up to 2MHz without loss of speed. But it also means
	that bogus cycles cannot be hidden.
	If fastmode is not set, the detection is done
	later, so that one and a half cycle fit in from PHI2 going low to this detection.
	This allows to hide bogus cycles within PHI1 of the system bus - but 
	system clock can only be 1MHz, or the system will slow down (you can read
	more about it in the <a href="works.html">How it works</a> page).
	Just remember that fastmode should be set on a 2MHz host system bus, and not
	on a 1MHz bus.</p>
	</p>
<hr>
<p>Return to <a href="../../index.html">Homepage</a></p>

  </DIV>
</div>
</div></body>
</html> 

