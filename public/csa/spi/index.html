<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<META NAME="keywords" CONTENT="CSA65 6502 VIA 6522 SPI MMC SD-Card">
<TITLE>CS/A65 SPI Interface</TITLE>
<LINK REL="stylesheet" TITLE="Default" TYPE="text/css" HREF="../../style.css">
<LINK REL="alternate stylesheet" TITLE="Advanced" TYPE="text/css" HREF="../../advanced.css">
</HEAD>
<BODY>
<DIV ID="menu">
<ul><li class=homepage><a href=../../index.html>Homepage</a></li>
<ul class="menu0" >
<li class="separator">Commodore</li>
<li class="dir"><a href="../../petindex/index.html">CBM PETindex</a></li>
<li class="dir"><a href="../../cbmhw/index.html">CBM hardware and mods</a></li>
<li class="separator">Hardware</li>
<li class="dir"><a href="../../csa/index.html">CS/A65 Caspaer and Gecko computer</a></li>
<ul class="menu1" >
<li class="file"><a href="../memmap.html">Memory Map</a></li>
<li class="separator">Specifications</li>
<li class="file"><a href="../bus.html">Bus V1.0</a></li>
<li class="file"><a href="../bus-1.1.html">Bus V1.1</a></li>
<li class="separator">Main boards</li>
<li class="dir"><a href="../cpu/index.html">CS/A65 CPU</a></li>
<li class="dir"><a href="../bios/index.html">CS/A65 BIOS </a></li>
<li class="dir"><a href="../cpu816v2/index.html">65816 CPU V2</a></li>
<li class="dir"><a href="../petcpu/index.html">64k PET CPU</a></li>
<li class="dir"><a href="../gecko/index.html">Gecko</a></li>
<li class="dir"><a href="../auxcpu/index.html">Auxiliary CPU</a></li>
<li class="dir"><a href="../pwr/index.html">Power Supply</a></li>
<li class="separator">I/O boards</li>
<li class="dir"><a href="../vdc/index.html">Video board</a></li>
<li class="dir"><a href="../petio/index.html">CBM PET I/O</a></li>
<li class="dir"><a href="../shug/index.html">PC floppy</a></li>
<li class="dir"><a href="../drvio/index.html">DRVIO floppy and IEC</a></li>
<li class="dir"><a href="../duart/index.html">Double UART (RS232)</a></li>
<li class="dir"><a href="../scsi/index.html">SCSI/I2C board</a></li>
<li class="dir"><a href="../spi/index.html">MMC/SD-Card</a></li>

<li class="separator">Special purpose</li>
<li class="dir"><a href="../ramdisk/index.html">SIMM RAMDisk</a></li>
<li class="dir"><a href="../copro/index.html">Coprocessor board</a></li>
<li class="dir"><a href="../cpuemu/index.html">Emulate a 6502</a></li>
<li class="dir"><a href="../keyemu/index.html">Emulate a keyboard</a></li>
<li class="dir"><a href="../viaproto/index.html">VIA prototyping</a></li>
<li class="separator">Deprecated boards</li>
<li class="dir"><a href="../cpu816/index.html">65816 CPU V1</a></li>
<li class="dir"><a href="../cpu65b/index.html">64k CPU</a></li>
<li class="dir"><a href="../key/index.html">Keyboard and RS232</a></li>
<li class="dir"><a href="../iec/index.html">IEEE488 and CBM IEC</a></li>
<li class="separator">Other links</li>
<li class="dir"><a href="../gallery/index.html">Gallery</a></li>
<li class="dir"><a href="../emu/index.html">VICE emu of CS/A65</a></li>
<li class="link"><a href="../../cbmhw/c64csa/index.html">C64 CS/A adapter</a></li>
</ul>
<li class="dir"><a href="../../hwinfo/index.html">ICs and Standards Info</a></li>
<li class="dir"><a href="../../mischw/index.html">Other hardware (e.g. tools)</a></li>
<li class="separator">Software</li>
<li class="dir"><a href="../../osa/index.html">GeckOS operating system</a></li>
<li class="dir"><a href="../../lib6502/index.html">Lib6502 standard</a></li>
<li class="dir"><a href="../../o65/index.html">O65 file format</a></li>
<li class="dir"><a href="../../misc/index.html">Misc software</a></li>
<li class="separator">Knowledge Bits</li>
<li class="dir"><a href="../../icapos/index.html">Computer/OS Architecture</a></li>
<li class="dir"><a href="../../icaphw/index.html">6502 Hardware Bits</a></li>
<li class="separator">Misc</li>
<li class="file"><a href="../../contact.html">Contact</a></li>
</ul>
</ul>
</DIV>
<DIV ID="content">
<H1>CS/A65 SPI Interface</H1>

<div class="overview">
<p><p>This page is actually not about a complete board, but it 
		documents the ways I use to connect SPI devices
		to the 6502. The first part actually is the interface
		to the SPI interface of MMC and SD-Cards.</p>
	</p>
</div>
<DIV ID="toc">
<H2>Table of content</H2>
<dir>
<li><a href="#modes">SPI</a></li>
<dir>
<li><a href="#modes">SPI Modes</a></li>
<li><a href="#spilinks">Links</a></li>
</dir>
<li><a href="#mmcsdc">MMC and SD-Cards</a></li>
<dir><li><a href="#spimodes">MMC/SD SPI mode</a></li></dir>
<li><a href="#sdc65">MMC and SD-Cards in a 6502 system</a></li>
<dir>
<li><a href="#65volt">Operating Voltage</a></li>
<li><a href="#65clk">SPI Mode</a></li>
</dir>
<li><a href="#driver">Driver</a></li>
<dir><li><a href="#driver1">OS/A65 SPI driver</a></li></dir>
<li><a href="#boards">Board Revisions</a></li>
<dir><li>
<a href="#board1">1.0A</a> (prototype)</li></dir>
</dir>
</DIV>
<H2><a name="modes">SPI</a></H2>
<p>
                <p>SPI means "Serial Peripheral Interface Bus" and is a very
		simple four-wire protocol. Some of the advantages are:
		<ul>
		<li>Each signal is single direction, there are no bi-directional signals</li>
		<li>It is a synchronous bus and clock is controlled by a single source.</li>
		<li>It is byte-oriented</li>
		</ul>
		One of its disadvantages is: it is not exactly well specified:
		</p><p>
		There are these four lines:
		<table border="1">
<tr>
<th>Signal</th>
<th>Direction</th>
<th>Description</th>
</tr>
		<tr>
<td>/SEL</td>
<td>SPI Master -&gt; SPI Slave</td>
<td>If low, the selected device is selected. A master may have multiple of those outputs, but a slave has only one input</td>
</tr>
		<tr>
<td>CLK</td>
<td>SPI Master -&gt; SPI Slave</td>
<td>Clock for data transfers</td>
</tr>
		<tr>
<td>MOSI</td>
<td>SPI Master -&gt; SPI Slave</td>
<td>Data from master to slave</td>
</tr>
		<tr>
<td>MISO</td>
<td>SPI Slave -&gt; SPI Master</td>
<td>Data from slave to master</td>
</tr>
		</table>
		Beyond that the CLK levels and at which CLK transition the data
		is transferred is not defined!
                </p></p>
<H3><a name="modes">SPI Modes</a></H3>
<p>
                	<p>
			For this reason there are different possibilities:
			<ul>
<li>CPOL=0/1: base value of the clock. I.e. the level of the CLK signal when no data transfer is going on.</li>
			<li>CPHA=0/1: The transition of the clock (leading or trailing edge) on which the data is transferred</li>
			</ul>
			This results in the fact that there are four SPI modes,
			<table border="1">
<tr>
<th>Mode</th>
<th>CPOL</th>
<th>CPHA</th>
</tr>
			<tr>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
			<tr>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
			<tr>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
			<tr>
<td>3</td>
<td>1</td>
<td>1</td>
</tr>
			</table>
			Unfortunately some devices only understand a single 
			mode, and different from other devices, so a master
			should be able to handle all modes.
                	</p></p>
<H3><a name="spilinks">Links</a></H3>
<p>
			<ul>
<li>
<a href="http://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus">Wikipedia</a> has some more detailled info</li>
			</ul>
			</p>
<H2><a name="mmcsdc">MMC and SD-Cards</a></H2>
<p>
                <p>
		MMC-Card and SD-Cards are cheap means of getting large amounts
		of storage memory nowadays. And they are getting larger and
		cheaper every day. Those cards are based on flash memory
		and can be found in digital cameras, navigation systems, 
		and many more.
		</p>
		<p>Unfortunately the MMC- and SD-Card protocols are not free,
		 however a certain amount of intelligence has been gathered
		and is available on the web:
		<ul>
<li><a href="http://en.wikipedia.org/wiki/MultiMediaCard">Wikipedia on MMCs</a></li>
		<li><a href="http://en.wikipedia.org/wiki/Secure_Digital_card">Wikipedia on Secure Digital Cards</a></li>
		<li><a href="http://elm-chan.org/docs/mmc/mmc_e.html">How to use MMC/SDC</a></li>
		</ul>
		as well as in datasheets for MMC or SD-Cards found on the 
		producers homepages.
                </p></p>
<H3><a name="spimodes">MMC/SD SPI mode</a></H3>
<p><p>
			Newer MMC and especially SD-Cards use a mode
			where more than a single bit is transferred per
			clock. In fact the cards have four data lines that
			are used in native mode. This mode is however
			more complicated. But, we are lucky, all cards
			still support the SPI mode, that they can enter
			upon startup when instructed to do so. And this is
			what the driver does.
			</p><p>
			One problem I had in the beginning was that the
			datasheets mentioned the data transfer on the 
			rising edge of the clock, but not what 
			clock level would be correct. By experimentation
			I found that MMCs and SD-Cards use mode 0.
			</p></p>
<H2><a name="sdc65">MMC and SD-Cards in a 6502 system</a></H2>
<p>
	<p>
		In a 6502 system several issues have to be considered:
	</p>
	</p>
<H3><a name="65volt">Operating Voltage</a></H3>
<p><p>
			The MMC and SD-Cards can operate with different 
			operation voltages, but not with voltages as high as
			5 Volt. 
		</p><p>Fortunately I had, with my new PWR board, a 3.3V
			power supply I could use. Doing the signal voltage
			conversion was more difficult. As shown on
			<a href="http://www.cip.physik.uni-muenchen.de/~wwieser/elec/avr/usb/levelcv.html">USB-based Atmel/AVR Programmer: Level Converter</a>,
			a 74VHC04 could be used to handle 5 Volt inputs even
			when powered with 3.3V - and giving 3.3V to the output.
			This IC, however, is SMD and hard to get, so I went for
			the slower (in terms of operating frequency) solution
			with open collector drivers as you can see in the 
			schematics.
		</p><p>
			Fortunately the MMC boards are CMOS devices, and 
			CMOS devices have a higher "high level" compared to
			standard TTL (see for example <a href="http://www.interfacebus.com/voltage_threshold.html">Logic Voltage Thresholds for TTL, CMOS, ...</a>). 
			Thus an output of a 3.3V-driven CMOS IC can still drive
			3V, which for a 5V TTL chips easily is a high level.				Therefore a 74LS* IC should suffice. According to the
			Level converter page above I successfully used a 
			74HCT family IC.
		</p></p>
<H3><a name="65clk">SPI Mode</a></H3>
<p><p>The MMC and SD-Cards operate with SPI mode 0.
			First I thought I could use the VIA 6522 shift
			register (SR) to handle the SPI port. As it turned out,
			however, the VIA SR transfers data out at the 
			first (falling) transition of its clock, so it can be
			latched by the second (rising) edge by the receiver.
			This would be SPI mode 3. You could reverse clock,
			but you cannot make the VIA shift our earlier. So there
			is no way to use the VIA SR. Instead I now use a 
			bit-banging approach with CLK and MOSI.
			</p><p>
			For MISO, hoever, I decided to use an external shift
			register. This approach seemed to make sense 
			with the VIA SR, as transfers work in both directions
			at the same time. Now it is just a convenience.
		</p></p>
<H2><A NAME="driver">Driver</A></H2>
<H3><A NAME="driver1">OS/A65 SPI driver</A></H3>
<p><p>
			This is a test driver for the SPI schematics below.
			It initializes the card, reads the operations conditions
			register, the card id data, and can read and write
			a block.
			</p><p>Please note that it is clutterd with debug code.
			</p>
                </p>
<TABLE class="files">
<TR CLASS="R1">
<TD><IMG SRC="../../imgs/file_driver.gif" ALT="driver"></TD>
<TD><A HREF="sdcard.tar.gz">sdcard.tar.gz</A></TD>
</TR>
</TABLE>
<H2><A NAME="boards">Board revisions</A></H2>
<H3><A NAME="board1">Version: 1.0A</A></H3>
<P>Status: prototype</P>
<H4>Notes</H4>
<TABLE class="notes">
<TR>
<TD class="noteicon"><IMG SRC="../../imgs/note_msg.gif" ALT="msg"></TD>
<TD>
			I have built this schematics on a prototyping board,
			so there is no board layout for it.
		</TD>
</TR>
<TR>
<TD class="noteicon"><IMG SRC="../../imgs/note_msg.gif" ALT="msg"></TD>
<TD>
			You may not the input shift register. This is not 
			really necessary if you bit-bang the input as well.
			It is convenient, however, and a remainder of an 
			earlier approach using the VIA shift register
			(which did not work unfortunately).
		</TD>
</TR>
<TR>
<TD class="noteicon"><IMG SRC="../../imgs/note_msg.gif" ALT="msg"></TD>
<TD>
			For hot-plugging another capacitor may be needed
			in the power supply lines for the card.
		</TD>
</TR>
</TABLE>
<H4>Files</H4>
<TABLE class="files">
<TR CLASS="R1">
<TD><IMG SRC="../../imgs/file_schem.gif" ALT="schem"></TD>
<TD><A HREF="csa_viaspi-v1.0a.sch">csa_viaspi-v1.0a.sch</A></TD>
</TR>
<TR CLASS="R0">
<TD><IMG SRC="../../imgs/file_schem.gif" ALT="schem"></TD>
<TD><A HREF="csa_viaspi_v1.0a-sch.png">csa_viaspi_v1.0a-sch.png</A></TD>
</TR>
</TABLE>
<DIV ID="footer">
<P>Last modified: 2007-06-07.</P>
<p>Return to <a href="../../index.html">Homepage</a></p>

</DIV>
</DIV>
</BODY>
</HTML>
