<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
<meta name="author" content="" />

<meta name="description" content="" />
<meta name="keywords" content="CSA65 6502 VIA 6522 SPI MMC SD-Card" />
<link rev="made" href="mailto:" />
<link rel="stylesheet" title="Default" type="text/css" href="../../style2-min.css" /><link href="../../shariff.min.css" rel="stylesheet" />
<title>CS/A65 SPI Interface</title></head>
<body><div id="mainbox"><a name="top" id="top"></a><div id="topsearch"><form method="get" action="http://www.google.com/search" target="_blank" autocomplete="off"><input alt="search" name="q" size="10" maxlength="255" type="text" /><input class="advbutton" value="Search site" type="submit" /><div id="srchprov">(by Google)</div><input name="sitesearch" value="www.6502.org/users/andre" type="hidden" /></form><div id="topfind"><div id="topprogress"></div></div></div><div id="menubox">


<div id="menu1" class="mclose">
<div id="twist1" class="twisty"></div>
<div class="hdrtxt"><a href="../../index.html">Home&nbsp;&gt;</a></div>
<ul class="nav1">
<li>
<ul class="nav2">
<li class="navhdr"><a href="../../index.html">Home</a></li>
<li><a href="../../contact.html">Contact</a></li>
<li><a href="../../design.html">Web design</a></li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Hardware</span></li>
<li><ul class="nav2" >
<li><a href="../../65k/index.html">The 65k Project</a>
</li>
<li><a href="../../pet816/index.html">PET816 Accelerator</a>
</li>
<li><a href="../../csa/index.html">CS/A65</a>
</li>
<li><a href="../../cbmhw/index.html">CBM mods</a>
</li>
<li><a href="../../spi65b/index.html">SPI65B</a>
</li>
<li><a href="../../mischw/index.html">Other hardware</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Software</span></li>
<li><ul class="nav2" >
<li><a href="../../osa/index.html">GeckOS</a>
</li>
<li><a href="../../lib6502/index.html">lib6502 </a>
</li>
<li><a href="../../o65/index.html">o65</a>
</li>
<li><a href="../../usb65/index.html">usb65</a>
</li>
<li><a href="../../xd2031/index.html">XD2031</a>
</li>
<li><a href="../../misc/index.html">Misc</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Library</span></li>
<li><ul class="nav2" >
<li><a href="../../petindex/index.html">PETindex</a>
</li>
<li><a href="../../petindex/drives/index.html">PET drives</a>
</li>
<li><a href="../../adv65/index.html">Advanced 6502</a>
</li>
<li><a href="../../hwinfo/index.html">ICs and Standards</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Knowledge Bits</span></li>
<li><ul class="nav2" >
<li><a href="../../icapos/index.html">Computer/OS Architecture</a>
</li>
<li><a href="../../icaphw/index.html">6502 Hardware Bits</a>
</li>
<li><a href="../../emulation/index.html">Emulation</a>
</li>
</ul>
<div class="nend2"></div>
</li>
<div class="nend1"></div>
</ul>
</div>
<div id="menu2" class="%open%">
<div id="twist2" class="twisty"></div>
<div class="hdrtxt"><a href="../index.html">CS/A Computer&nbsp;&gt;</a></div>
<ul class="nav1">
<li>
<ul class="nav2">
<li class="navhdr"><a href="../index.html">CS/A Computer</a></li>
<li><a href="../memmap.html">Memory Map</a></li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Specifications</span></li>
<li><ul class="nav2" >
<li><a href="../bus.html">Bus V1.0</a></li>
<li><a href="../bus-1.1.html">Bus V1.1</a></li>
<div class="nend2"></div>
</ul>
</li>
<li><span>Main boards</span></li>
<li><ul class="nav2" >
<li><a href="../cpu/index.html">CS/A65 CPU</a>
</li>
<li><a href="../bios/index.html">CS/A65 BIOS </a>
</li>
<li><a href="../cpu816v2/index.html">65816 CPU V2</a>
</li>
<li><a href="../petcpu/index.html">64k PET CPU</a>
</li>
<li><a href="../gecko/index.html">Gecko</a>
</li>
<li><a href="../auxcpu/index.html">Auxiliary CPU</a>
</li>
<li><a href="../pwr/index.html">Power Supply</a>
</li>
<li><a href="../term/index.html">Bus terminators</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>I/O boards</span></li>
<li><ul class="nav2" >
<li><a href="../vdc/index.html">Video board</a>
</li>
<li><a href="../petio/index.html">CBM PET I/O</a>
</li>
<li><a href="../netusb/index.html">Net/USB/SD</a>
</li>
<li><a href="../etholi/index.html">Ethernet</a>
</li>
<li><a href="../usb/index.html">USB</a>
</li>
<li><a href="../shug/index.html">PC floppy</a>
</li>
<li><a href="../drvio/index.html">DRVIO floppy and IEC</a>
</li>
<li><a href="../duart/index.html">Double UART (RS232)</a>
</li>
<li><a href="../scsi/index.html">SCSI/I2C board</a>
</li>
<li><a href="../spi/index.html">MMC/SD-Card</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Special purpose</span></li>
<li><ul class="nav2" >
<li><a href="../blitter/index.html">Block transfer</a>
</li>
<li><a href="../ramdisk/index.html">SIMM RAMDisk</a>
</li>
<li><a href="../copro/index.html">Coprocessor board</a>
</li>
<li><a href="../cpuemu/index.html">Emulate a 6502</a>
</li>
<li><a href="../keyemu/index.html">Emulate a keyboard</a>
</li>
<li><a href="../viaproto/index.html">VIA prototyping</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Deprecated boards</span></li>
<li><ul class="nav2" >
<li><a href="../cpu816/index.html">65816 CPU V1</a>
</li>
<li><a href="../cpu65b/index.html">64k CPU</a>
</li>
<li><a href="../key/index.html">Keyboard and RS232</a>
</li>
<li><a href="../iec/index.html">IEEE488 and CBM IEC</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<li><span>Other links</span></li>
<li><ul class="nav2" >
<li><a href="../gallery/index.html">Gallery</a>
</li>
<li><a href="../emu/index.html">VICE emu of CS/A65</a>
</li>
<li><a href="../../cbmhw/c64csa/index.html">&gt;C64 CS/A adapter</a></li>
<li><a href="../../cbmhw/petcsa/index.html">&gt;PET CS/A adapter</a></li>
</ul>
<div class="nend2"></div>
</li>
<div class="nend1"></div>
</ul>
</div>
	</div><div id="midcol"><div class="top" id="content"><div id="minmax"></div>

<h1>CS/A65 SPI Interface</h1>

<div class="overview"><p>This page is actually not about a complete board, but it 
		documents the ways I use to connect SPI devices
		to the 6502. The first part actually is the interface
		to the SPI interface of MMC and SD-Cards.</p>
	
</div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="news" id="news">News:</a></h2></div><div class="h2c"><ul class="news"><li><div> </div><small>2013-01-13</small>
	Added a new revision - this time using the VIA shift register - YES it is possible! - to
	access the SD card.
      </li><li><div> </div><small>2011-03-06</small>
           Moved the SPI description from here to the <a href="../../hwinfo/spi.html">SPI page</a>.
      </li></ul></div></div><div id="toc" class="h2"><div class="h2h"><div class="h2t"> </div><h2>Table of content</h2></div><div class="h2c"><ul><li><a href="#sdc65">MMC and SD-Cards in a 6502 system</a></li><li style="list-style-type:none;"><ul><li><a href="#65volt">Operating Voltage</a></li><li><a href="#65clk">SPI Mode</a></li><li><a href="#srmagic">Shift register magic</a></li></ul></li><li><a href="#driver">Driver</a></li><li style="list-style-type:none;"><ul><li><a href="#driver1">OS/A65 SPI driver 1.1</a></li><li><a href="#driver2">OS/A65 SPI driver 1.0</a></li></ul></li><li><a href="#boards">Board Revisions</a></li><li style="list-style-type:none;"><ul><li><a href="#board1">1.1A</a> (prototype)</li><li><a href="#board2">1.0A</a> (prototype)</li></ul></li></ul></div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="sdc65" id="sdc65">MMC and SD-Cards in a 6502 system</a></h2></div><div class="h2c">
	<p>
		In a 6502 system several issues have to be considered:
	</p>
	<h3><a name="65volt" id="65volt">Operating Voltage</a></h3><p>
			The MMC and SD-Cards can operate with different 
			operation voltages, but not with voltages as high as
			5 Volt. 
		</p><p>Fortunately I had, with my new PWR board, a 3.3V
			power supply I could use. Doing the signal voltage
			conversion was more difficult. As shown on
			<a href="http://www.cip.physik.uni-muenchen.de/~wwieser/elec/avr/usb/levelcv.html">USB-based Atmel/AVR Programmer: Level Converter</a>,
			a 74VHC04 could be used to handle 5 Volt inputs even
			when powered with 3.3V - and giving 3.3V to the output.
			This IC, however, is SMD and hard to get, so I went for
			the slower (in terms of operating frequency) solution
			with open collector drivers as you can see in the 
			schematics.
		</p><p>
			Fortunately the MMC boards are CMOS devices, and 
			CMOS devices have a higher "high level" compared to
			standard TTL (see for example <a href="http://www.interfacebus.com/voltage_threshold.html">Logic Voltage Thresholds for TTL, CMOS, ...</a>). 
			Thus an output of a 3.3V-driven CMOS IC can still drive
			3V, which for a 5V TTL chips easily is a high level.				Therefore a 74LS* IC should suffice. According to the
			Level converter page above I successfully used a 
			74HCT family IC.
		</p><h3><a name="65clk" id="65clk">SPI Mode</a></h3><p>The MMC and SD-Cards operate with SPI mode 0.
			First I thought I could use the VIA 6522 shift
			register (SR) to handle the SPI port. As it turned out,
			however, the VIA SR transfers data out at the 
			first (falling) transition of its clock, so it can be
			latched by the second (rising) edge by the receiver.
			This would be SPI mode 3. You could reverse clock,
			but you cannot make the VIA shift our earlier. So - I thought - there
			is no way to use the VIA SR. Instead in version 1.0 I used a 
			bit-banging approach with CLK and MOSI.
			</p><p>
			For MISO, hoever, I decided to use an external shift
			register. This approach seemed to make sense 
			with the VIA SR, as transfers work in both directions
			at the same time. Now it is just a convenience.
		</p><h3><a name="srmagic" id="srmagic">Shift register magic</a></h3><p>
			For release 1.1 of the board I decided I would take on another try of using
			the VIA shift register. And indeed I found a neat trick, that only needed an 
			extra IC.
			</p><p>
			The VIA shift register with CB1 as clock output and CB2 as data output 
			directly implement SPI mode 3. Inverting the clock could make that an SPI mode 1.
			However, for SPI modes 0 and 2, not only need the clock be inverted for mode 0, 
			the first data bit needed to be available
			already before the start of the first clock pulse! The VIA cannot give this
			signal. So I though about setting the data line with the first bit manually.
			And that is actually easy with an extra XOR. The VIA keeps the data output CB2
			as the last valid bit of the previous shift, i.e. bit 0.
			Make sure the last bit of every shifted
			data is zero, then invert the data line when the highest bit of the <em>new</em> 
			data is set, and shift
			out the rest of the data.:</p>
			<pre>
SD_SENDBYTEW
        ; mode 0
        ; make sure last bit is 0, shifting bit 7 into carry
        asl
        bcs invert
        ; last bit was 0, nothing to do but send the byte
        sta SD_VIA+VIA_SR
        ; wait to finish
        lda #%00000100
wait0   bit SD_VIA+VIA_IFR
        beq wait0
        bne end

invert  ; invert the current bit (which is last bit from prev. 
        ; data byte, which we set to zero
        inc SD_VIA+VIA_DRA
        ; compensate for the inversion
        eor #$fe
        ; send out the data
        sta SD_VIA+VIA_SR
        ; wait to finish
        lda #%00000100
wait1   bit SD_VIA+VIA_IFR
        beq wait1
        ; reset inverter
        dec SD_VIA+VIA_DRA
end     ; clear int
        sta SD_VIA+VIA_IFR
        ; read read data
        lda SD_VIA+VIA_DRB      ; load from external shift reg
        rts
			</pre>
			<p>This way the VIA can actually do SPI mode 0!</p>
			<p>Note: I kept it simple. This schematics can only do mode 0 and mode 3. 
			If I had to enable mode 1 and 2, then the inverter for the clock need to be
			separated for an inverter for the clock going to the SPI bus, and an inverter
			for the input shift register. Why that is is kept as excercise to the reader.
		</p></div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="driver" id="driver">Driver</a></h2></div><div class="h2c"><div class="driver"><h3><a name="driver1" id="driver1">OS/A65 SPI driver 1.1</a></h3><div class="driverdesc"><p>
			This is a test driver for the SPI 1.1 schematics below.
			I uses the VIA shift register to access the SD card.
			</p><p>
			It initializes the card, reads the operations conditions
			register, the card id data, and can read and write
			a block.
			</p><p>Please note that it is clutterd with debug code.
			</p><p>Also note that the driver is "conservative". It actually
				waits even when sending a byte, to undo the inverter.
				It could just "fire-and-forget" and check on the next
				call whether the previous byte is done.
			</p>
                </div><div class="driverfiles"><table class="files">
<tr class="R1"><td><div class="i_driver"> </div></td>
<td><a href="sdcard-viaspi.tar.gz">sdcard-viaspi.tar.gz</a></td>
</tr></table></div><div class="driverend"></div></div><div class="driver"><h3><a name="driver2" id="driver2">OS/A65 SPI driver 1.0</a></h3><div class="driverdesc"><p>
			This is a test driver for the SPI 1.0 schematics below.
			It initializes the card, reads the operations conditions
			register, the card id data, and can read and write
			a block.
			</p><p>Please note that it is clutterd with debug code.
			</p>
                </div><div class="driverfiles"><table class="files">
<tr class="R1"><td><div class="i_driver"> </div></td>
<td><a href="sdcard.tar.gz">sdcard.tar.gz</a></td>
</tr></table></div><div class="driverend"></div></div></div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="boards" id="boards">Board revisions</a></h2></div><div class="h2c"><div class="rev"><h3><a name="board1" id="board1">Version: 1.1A</a></h3>
<div class="revdesc"><p>Status: prototype</p>
</div><div class="revnotes"><h4>Notes</h4><table class="notes"><tr><td class="noteicon"><div class="i_msg"> </div></td>
<td>
			I have built this schematics on a prototyping board,
			so there is no board layout for it.
		</td></tr>
<tr><td class="noteicon"><div class="i_msg"> </div></td>
<td>
			This approach uses the VIA shift register, which allows
			you much faster speed than bit-banging!
		</td></tr>
<tr><td class="noteicon"><div class="i_msg"> </div></td>
<td>
			For hot-plugging a capacitor and inductor have been added
			in the power supply lines for the card (this is untested though).
		</td></tr>
</table></div><div class="revfiles"><h4>Files</h4><table class="files">
<tr class="R1"><td><div class="i_schem"> </div></td>
<td><a href="csa_viaspi-v1.1a.sch">csa_viaspi-v1.1a.sch</a></td>
</tr>
<tr class="R0"><td><div class="i_schem"> </div></td>
<td><a href="csa_viaspi_v1.1a-sch.png">csa_viaspi_v1.1a-sch.png</a></td>
</tr></table>
</div><div class="revend"></div></div><div class="rev"><h3><a name="board2" id="board2">Version: 1.0A</a></h3>
<div class="revdesc"><p>Status: prototype</p>
</div><div class="revnotes"><h4>Notes</h4><table class="notes"><tr><td class="noteicon"><div class="i_msg"> </div></td>
<td>
			I have built this schematics on a prototyping board,
			so there is no board layout for it.
		</td></tr>
<tr><td class="noteicon"><div class="i_msg"> </div></td>
<td>
			You may not need the input shift register. This is not 
			really necessary if you bit-bang the input as well.
			It is convenient, however, and a remainder of an 
			earlier approach using the VIA shift register
			(which did not work unfortunately).
		</td></tr>
<tr><td class="noteicon"><div class="i_msg"> </div></td>
<td>
			For hot-plugging another capacitor may be needed
			in the power supply lines for the card.
		</td></tr>
</table></div><div class="revfiles"><h4>Files</h4><table class="files">
<tr class="R1"><td><div class="i_schem"> </div></td>
<td><a href="csa_viaspi-v1.0a.sch">csa_viaspi-v1.0a.sch</a></td>
</tr>
<tr class="R0"><td><div class="i_schem"> </div></td>
<td><a href="csa_viaspi_v1.0a-sch.png">csa_viaspi_v1.0a-sch.png</a></td>
</tr></table>
</div><div class="revend"></div></div></div></div><div id="contentfooter"><p>Last modified: 2007-06-07.</p>
<p>Return to <a href="../../index.html">Homepage</a></p>

</div></div></div><div id="rightcol"><div class="top" id="share"><div class="tophead">share</div><div><div class="shariff" data-backend-url="/users/andre/shariff/index.php" data-theme="grey" data-orientation="vertical"></div></div></div><div class="top" id="twitter"><div class="tophead">follow</div><div><p>Follow my 8-bit tweets on
		            <a class="extlink" target="_blank" href="https://twitter.com/#!/search/realtime/afachat%20%238bit">Twitter</a> (In new window)</p></div></div><div class="top" id="forum"><div class="tophead">discuss</div><div><p>Discuss my site on <a class="extlink" target="_blank" href="http://forum.6502.org/viewtopic.php?t=956">this 6502.org forum thread</a></p><p>(Forum registration required to post)</p></div></div><div class="top" id="hot"><div class="tophead">hot!</div><div>
<p>Dive into the retro feeling and build yourself a <a href="../../cbmhw/ryofat40/index.html">Commodore PET replica</a></p>
<p>Need more speed? Speed up your 6502 computer with this <a href="../../pet816/index.html">10&nbsp;MHz 6502 CPU accelerator board</a></p>
<p>Interested in electronics design? Look at the <a href="../../icaphw/design.html">design lesson</a> I got from Bil Herd, the hardware designer of the C128</p>
<p>Want 64bit? - pimp the 6502 with the <a href="../../65k/index.html">65k processor design!</a></p>

		</div></div></div><div id="footer"> </div></div><script type="text/javascript">myUp="../../";</script><script type="text/javascript" src="../../scripts2-all.js"></script><script type="text/javascript" src="../../shariff.min.js"></script></body></html>
