<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
<LINK REV=MADE HREF="mailto:fachat@newton"><TITLE>dos1</TITLE>
</HEAD>
<!-- recomment 4.08 15 May 2005. -->
<!-- Formatted to HTML for fachat  Sun May 15 20:12:14 CEST 2005. -->
<BODY>
<H1>Automatic Generated Disassembly of `dos1'</H1>
<HR><PRE>

; *** text follows ***

 *=$E000



; This is a commented disassembly of the DOS V1 as used
; in the Commodore 2040 dual disk drive. The disassembly
; is taken from the images of the ROM chips named 
; "901468-06.bin" and "901468-07.bin".
; ;
; Technically the disassembly was produced and merged
; with the comments using the "recomment" utility
; (version 4.08 at least).
; ;
; To create the comments, I compared the ROM source code
; of the 4040 dual disk drive with DOS V2. The uppercase
; comments are copied from the 4040 DOS. I have added the
; (few) lowercase comments myself.
; ;
; In general there is only littel code that remains unchanged,
; if any at all. A lot of code only has minor changes, though.
; Some code has major changes.
; ;
; I found an interesting comment for routine "USER" in the 4040
; ROM. The comment is "ROM 1.1 ADDITIONS" and seems to indicate
; that there was a version before the 2040 DOS version, 
; because the USER command already exists in the 2040.
; ;
; I was unable to completely relate the code to the new version
; as used in the 4040. I could not relate the following methods:
; ED53
; F482
; F67A, F80F, F851
; ;
; 15. May 2005 Andre Fachat (afachat@gmx.de)
; ;
; INIT-DRIVE VEIFY-DIR DUPLICATE MEMORY-OP BLOCK-OP USER POSITION DSKCPY RENAME SCRATCH NEW

 E000  <A NAME="E000">CMDTBL</A>     .byte $49, $56, $44, $4D, $42, $55, $43, $52  ;ivdmbucr
 E008             .byte $53, $4E                                ;sn


; &lt;INTDRV, &lt;VERDIR, &lt;DUPLCT, &lt;MEM, &lt;BLOCK, &lt;USER, &lt;DSKCPY, &lt;RENAME, &lt;SCRTCH, &lt;NEW

 E00A  <A NAME="E00A">CJUMPL</A>     .byte $A8, $37, $ED, $ED, $E5, $43, $47, $D3  ;(7...cgS
 E012             .byte $73, $C8                                ;SH


; &gt;INTDRV, &gt;VERDIR, &gt;DUPLCT, &gt;MEM, &gt;BLOCK, &gt;USER, &gt;DSKCPY, &gt;RENAME, &gt;SCRTCH, &gt;NEW

 E014  <A NAME="E014">CJUMPH</A>     .byte $E8, $FC, $F9, $FC, $FD, $FD, $FB, $FB  ;........
 E01C             .byte $F9, $F8
; ;
; original 4040 comment for the next bytes
; the bytes for RENAMEi ($dd), SCRATCH ($1c) and NEW ($9e) seem to be the same at the 
; same place, but DSKCPY is different (here $d9, in 4040 it's $51)
; and LOAD is missing here.
; e
; ; STRUCTURE IMAGES FOR CMDS
; PCMD =8
; .BYT %01010001 ; DSKCPY
; STRUCT  =*-PCMD ; CMDS NOT PARSED
; .BYT %11011101 ; RENAME
; .BYT %00011100 ; SCRATCH
; .BYT %10011110 ; NEW
; LDCMD   =*-STRUCT ; LOAD CMD IMAGE
; .BYT %00011100 ; LOAD
; ;            --- ---
; ;            PGDRPGDR
; ;            FS1 FS2
; ;
; ;   BIT REPS:  NOT PATTERN
; ;              NOT GREATER THAN ONE FILE
; ;              NOT DEFAULT DRIVE(S)
; ;              REQUIRED FILENAME

, $D9, $DD, $1C, $9E            ;..Y.\.

; number of sectors per track (from hi to lo)

 E022  <A NAME="E022">TRKTBL</A>     .byte $15, $14, $12, $11                      ;utrq


; highest track of each speed zone

 E026  <A NAME="E026">CHGTRACKS</A>  .byte $11, $18, $1E, $23                      ;qx^#


; last byte of a BAM track entry per speed zone

 E02A  <A NAME="E02A">BAMEND</A>     .byte $1F, $0F, $03, $01                      ;_oca


; list of file modes

 E02E  <A NAME="E02E">MODLST</A>     .byte $52, $57, $4D                           ;rwm


; filetypes available "DEL", "SEQ", "PRG", "USR". Note: no "REL"!

 E031  <A NAME="E031">TYPLST</A>     .byte $44, $53, $50, $55                      ;dspu
 E035  <A NAME="E035">TP1LST</A>     .byte $45, $45, $52, $53                      ;eers
 E039  <A NAME="E039">TP2LST</A>     .byte $4C, $51, $47, $52                      ;lqgr


; ;

 E03D             .byte $AA, $AA, $DA                           ;**Z



; start of special routine to be copied to controller buffer

 E040  <A NAME="E040">CODE</A>       .byte $A5, $1B, $10, $3A, $78, $A9, $C1, $95  ;%[p:X)A.
 E048             .byte $03, $A9, $0F, $3D, $EF, $FF, $05, $40  ;c)o=..e@
 E050             .byte $85, $40, $A9, $8C, $95, $05, $58, $B5  ;.@)..ex5
 E058             .byte $05, $D0, $FC, $98, $0A, $0A, $0A, $18  ;eP..jjjx
 E060             .byte $69, $21, $85, $18, $A0, $00, $84, $1F  ;I!.x .._
 E068             .byte $C8, $84, $1B, $C8, $B1, $18, $29, $C0  ;H.[H1x).
 E070             .byte $09, $01, $91, $18, $A4, $1A, $29, $3F  ;ia.x$z)?
 E078             .byte $99, $12, $04, $4C, $47, $FC, $D9, $12  ;.rdlg.Yr
 E080             .byte $04, $D0, $F5, $78, $A9, $19, $85, $0A  ;dP.X)y.j
 E088             .byte $A0, $03, $A9, $00, $91, $18, $A9, $10  ; c)..x)p
 E090             .byte $85, $4E, $A9, $DC, $85, $4C, $A9, $08  ;.n)..l)h
 E098             .byte $25, $82, $F0, $05, $A9, $08, $4C, $C3  ;%..e)hlC
 E0A0             .byte $FE, $A0, $03, $A9, $00, $51, $18, $88  ;. c).qx.
 E0A8             .byte $10, $FB, $A0, $04, $91, $18, $A2, $FF  ;p. d.x".
 E0B0             .byte $86, $81, $84, $08, $E8, $A0, $00, $20  ;...h. . 
 E0B8             .byte $7C, $FF, $88, $D0, $FA, $C6, $08, $D0  ;|..P.FhP
 E0C0             .byte $F6, $A2, $00, $A0, $00, $20, $7C, $FF  ;.". . |.
 E0C8             .byte $88, $D0, $FA, $A9, $DE, $86, $08, $CA  ;.P.)..hJ
 E0D0             .byte $20, $7C, $FF, $85, $4C, $20, $7C, $FF  ; |..l |.
 E0D8             .byte $A9, $DC, $A2, $08, $20, $7C, $FF, $85  ;)."h |..
 E0E0             .byte $4C, $A0, $04, $B1, $18, $24, $4D, $10  ;l d1x$mp
 E0E8             .byte $FC, $85, $80, $24, $41, $88, $10, $F3  ;...$a.p.
 E0F0             .byte $A4, $0A, $20, $7C, $FF, $88, $D0, $FA  ;$j |..P.
 E0F8             .byte $A0, $03, $B1, $18, $85, $08, $18, $69  ; c1x.hxI
 E100             .byte $01, $91, $18, $C5, $15, $F0, $0A, $C8  ;a.xEu.jH
 E108             .byte $45, $08, $51, $18, $91, $18, $4C, $81  ;ehqx.xl.
 E110             .byte $05, $20, $59, $FF, $A2, $FA, $20, $2D  ;e y.". -
 E118             .byte $FF, $70, $06, $C6, $0A, $F0, $1C, $D0  ;.PfFj.\P
 E120             .byte $0F, $A2, $28, $20, $2D, $FF, $50, $0B  ;o"( -.pk
 E128             .byte $E6, $0A, $A5, $0A, $C9, $30, $F0, $0B  ;.j%jI0.k
 E130             .byte $4C, $48, $05, $A5, $1F, $C9, $30, $D0  ;lhe%_I0P
 E138             .byte $0B, $06, $1E, $A9, $FF, $85, $1B, $A9  ;kf^)..[)
 E140             .byte $0C, $4C, $F9, $FE, $A9, $80, $85, $1E  ;ll..)..^
 E148             .byte $A9, $00, $A0, $03, $91, $18, $20, $CE  ;). c.x N
 E150             .byte $FE, $A0, $03, $B1, $18, $18, $69, $01  ;. c1xxIa
 E158             .byte $91, $18, $C5, $15, $D0, $F0, $06, $1E  ;.xEuP.f^
 E160             .byte $E6, $1B, $A5, $1B, $C9, $24, $F0, $12  ;.[%[I$.r
 E168             .byte $A0, $02, $B1, $18, $29, $C0, $05, $1B  ; b1x).e[
 E170             .byte $91, $18, $A6, $12, $FE, $12, $04, $4C  ;.x&r.rdl
 E178             .byte $47, $FC, $A9, $FF, $85, $1B, $4C, $C1  ;g.)..[lA
 E180             .byte $FE                                     ;.


; test for diagnostic ROM


 E181  A2 00     <A NAME="E181">DROMTS</A>     LDX #$00       ; test for diagnostic ROM
 E183  A9 55                LDA #$55      
 E185  CD 00 D0  <A NAME="E185">iE185</A>      CMP DIAGROM   
 E188  D0 03                BNE <A HREF="#E18D">iE18D</A>     
 E18A  CA                   DEX <A HREF="#E18D"></A>          
 E18B  D0 F8                BNE <A HREF="#E185">iE185</A>     
 E18D  60        <A NAME="E18D">iE18D</A>      RTS <A HREF="#E185"></A>          

 E18E  D8        <A NAME="E18E">DSKINT</A>     CLD <A HREF="#E185"></A>           ; RESET drive
 E18F  78                   SEI <A HREF="#E185"></A>          
 E190  A2 FF                LDX #$FF      
 E192  9A                   TXS           
 E193  8E 02 02             STX RIOT1IEEEDO
 E196  8E 03 02             STX RIOT1PBDD 
 E199  A9 1C                LDA #$1C       ; DAVO+EOIO+RFDO
 E19B  8D 80 02             STA RIOT2PAD  
 E19E  A9 1F                LDA #$1F      
 E1A0  8D 81 02             STA RIOT2PADD 
 E1A3  A9 38                LDA #$38       ; ERRLED+ACTLDB+ACTLDA
 E1A5  8D 82 02             STA RIOT2PBD  
 E1A8  8D 83 02             STA RIOT2PBDD 
 E1AB  A2 00                LDX #$00       ; test zeropage
 E1AD  8A                   TXA           
 E1AE  A0 55     <A NAME="E1AE">iE1AE</A>      LDY #$55      
 E1B0  94 00                STY CMDBUF,X  
 E1B2  CA                   DEX           
 E1B3  D0 F9                BNE <A HREF="#E1AE">iE1AE</A>     
 E1B5  AA                   TAX <A HREF="#E1AE"></A>          
 E1B6  A9 AA     <A NAME="E1B6">iE1B6</A>      LDA #$AA      
 E1B8  16 00                ASL CMDBUF,X  
 E1BA  55 00                EOR CMDBUF,X  
 E1BC  95 00                STA CMDBUF,X  
 E1BE  D0 1E                BNE <A HREF="#E1DE">ZPBAD</A>     
 E1C0  CA                   DEX <A HREF="#E1DE"></A>          
 E1C1  D0 F3                BNE <A HREF="#E1B6">iE1B6</A>     
 E1C3  20 81 E1             JSR <A HREF="#E181">DROMTS</A>     ; check for diagnostic ROM
 E1C6  D0 1C                BNE <A HREF="#E1E4">EROMCHK</A>    ; not here, goto E-ROM test
 E1C8  4C 05 D0             JMP DIAGROM+5  ; diagnostic hook
 E1CB  A2 10     <A NAME="E1CB">ROMTST</A>     LDX #$10      
 E1CD  A0 00                LDY #$00      
 E1CF  98                   TYA           
 E1D0  18                   CLC           
 E1D1  71 30     <A NAME="E1D1">iE1D1</A>      ADC (IP),Y    
 E1D3  C8                   INY           
 E1D4  D0 FB                BNE <A HREF="#E1D1">iE1D1</A>     
 E1D6  CA                   DEX <A HREF="#E1D1"></A>          
 E1D7  F0 04                BEQ <A HREF="#E1DD">iE1DD</A>     
 E1D9  E6 31                INC IP+1      
 E1DB  D0 F4                BNE <A HREF="#E1D1">iE1D1</A>     
 E1DD  60        <A NAME="E1DD">iE1DD</A>      RTS <A HREF="#E1D1"></A>          
 E1DE  A9 FF     <A NAME="E1DE">ZPBAD</A>      LDA #$FF       ; zeropage bad
 E1E0  95 00                STA CMDBUF,X  
 E1E2  D0 FA                BNE <A HREF="#E1DE">ZPBAD</A>      ; endless loop
 E1E4  A9 30     <A NAME="E1E4">EROMCHK</A>    LDA #$30      
 E1E6  8D 82 02             STA RIOT2PBD  
 E1E9  A9 E0                LDA #$E0      
 E1EB  85 31                STA IP+1      
 E1ED  A9 00                LDA #$00      
 E1EF  85 30                STA IP        
 E1F1  20 CB E1             JSR <A HREF="#E1CB">ROMTST</A>    
 E1F4  C9 00                CMP #$00      
 E1F6  F0 06                BEQ <A HREF="#E1FE">FROMCHK</A>    ; ok, goto F-ROM check
 E1F8  8D 00 E0  <A NAME="E1F8">BADE</A>       STA <A HREF="#E000">CMDTBL</A>     ; this stores into ROM?
 E1FB  4C F8 E1             JMP <A HREF="#E1F8">BADE</A>       ; endless loop
 E1FE  A9 28     <A NAME="E1FE">FROMCHK</A>    LDA #$28      
 E200  8D 82 02             STA RIOT2PBD  
 E203  A9 F0                LDA #$F0      
 E205  85 31                STA IP+1      
 E207  20 CB E1             JSR <A HREF="#E1CB">ROMTST</A>    
 E20A  C9 00                CMP #$00      
 E20C  F0 06                BEQ <A HREF="#E214">DIAGOK</A>    
 E20E  8D 00 F0  <A NAME="E20E">BADF</A>       STA <A HREF="#F000">xF000</A>      ; this stores into ROM?
 E211  4C 0E E2             JMP <A HREF="#E20E">BADF</A>       ; endless loop
 E214  A9 00     <A NAME="E214">DIAGOK</A>     LDA #$00      
 E216  8D 82 02             STA RIOT2PBD  
 E219  AD 82 02             LDA RIOT2PBD   ; compute primary IEEE address
 E21C  29 07                AND #$07      
 E21E  09 48                ORA #$48      
 E220  85 33                STA TLKADR    
 E222  49 60                EOR #$60      
 E224  85 32                STA LSNADR    
 E226  A9 81                LDA #$81       ; init command channel
 E228  85 C4                STA CHNRDY+6  
 E22A  A9 30                LDA #$30      
 E22C  8D DF 10             STA CHNDAT+6  
 E22F  20 D6 ED             JSR <A HREF="#EDD6">INTTAB</A>    
 E232  A9 FF                LDA #$FF      
 E234  A2 21                LDX #$21      
 E236  9D B7 10  <A NAME="E236">iE236</A>      STA LINTAB,X  
 E239  CA                   DEX           
 E23A  10 FA                BPL <A HREF="#E236">iE236</A>     
 E23C  A9 07                LDA #$07       ; CMDRD
 E23E  8D D5 10             STA LINTAB+30 
 E241  A9 06                LDA #$06       ; CMDWRT
 E243  8D D6 10             STA LINTAB+31 
 E246  A9 3F                LDA #$3F      
 E248  85 3C                STA LINUSE    
 E24A  A9 0F                LDA #$0F      
 E24C  85 6B                STA BUFNUM+12 
 E24E  A9 10                LDA #$10      
 E250  85 6D                STA BUFNUM+14 
 E252  A9 FF                LDA #$FF      
 E254  85 6C                STA BUFNUM+13 
 E256  85 6E                STA BUFNUM+15 
 E258  A9 88                LDA #$88      
 E25A  85 C5                STA CHNRDY+7  
 E25C  A9 01                LDA #$01      
 E25E  85 C4                STA CHNRDY+6  
 E260  A9 00                LDA #$00      
 E262  85 8B                STA BUFUSE    
 E264  A9 E0                LDA #$E0      
 E266  85 8C                STA BUFUSE+1  
 E268  20 49 FD             JSR <A HREF="#FD49">USRINT</A>     ; init user jump
 E26B  A9 0A                LDA #$0A       ; setup sector offset
 E26D  85 92                STA SECINC    
 E26F  8D 87 02             STA RIOT2ATNPE ; allow ATN to interrupt
 E272  A5 3A     <A NAME="E272">IDLE</A>       LDA CMDWAT    
 E274  F0 08                BEQ <A HREF="#E27E">IDLE2</A>     
 E276  A9 00                LDA #$00      
 E278  85 3A                STA CMDWAT    
 E27A  78                   SEI           
 E27B  20 44 F0             JSR <A HREF="#F044">PARSXQ</A>     ; parse and execute command
 E27E  58        <A NAME="E27E">IDLE2</A>      CLI <A HREF="#F044"></A>           ; test for drive running or openfile
 E27F  A9 1D                LDA #$1D      
 E281  85 2D                STA TEMP+3    
 E283  A9 00                LDA #$00      
 E285  85 2A                STA TEMP      
 E287  85 2B                STA TEMP+1    
 E289  A6 2D     <A NAME="E289">iE289</A>      LDX TEMP+3     ; look thru LINTAB
 E28B  BD B7 10             LDA LINTAB,X  
 E28E  C9 FF                CMP #$FF       ; for active file
 E290  F0 0E                BEQ <A HREF="#E2A0">iE2A0</A>     
 E292  85 83                STA LINDX     
 E294  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 E297  AA                   TAX <A HREF="#E89D"></A>          
 E298  BD 99 10             LDA LSTJOB,X   ; determine which drv is on
 E29B  29 01                AND #$01      
 E29D  AA                   TAX           
 E29E  F6 2A                INC TEMP,X    
 E2A0  C6 2D     <A NAME="E2A0">iE2A0</A>      DEC TEMP+3     ; set flag indicating drive
 E2A2  10 E5                BPL <A HREF="#E289">iE289</A>      ; has file open
 E2A4  A0 0E                LDY #$0E       ; look through job queue
 E2A6  B9 03 10  <A NAME="E2A6">iE2A6</A>      LDA JOBS,Y     ; for jobs still running
 E2A9  10 05                BPL <A HREF="#E2B0">iE2B0</A>     
 E2AB  29 01                AND #$01      
 E2AD  AA                   TAX           
 E2AE  F6 2A                INC TEMP,X     ; set flag indicating drive
 E2B0  88        <A NAME="E2B0">iE2B0</A>      DEY            ; is active
 E2B1  10 F3                BPL <A HREF="#E2A6">iE2A6</A>     
 E2B3  AD 82 02             LDA RIOT2PBD  
 E2B6  29 E7                AND #$E7       ; 255-ACTLDA-ACTLDB
 E2B8  8D 82 02             STA RIOT2PBD  
 E2BB  A5 2A                LDA TEMP      
 E2BD  F0 08                BEQ <A HREF="#E2C7">iE2C7</A>     
 E2BF  AD 82 02             LDA RIOT2PBD   ; turn on LED if drive flag
 E2C2  09 10                ORA #$10       ; ACTLDB if not 0
 E2C4  8D 82 02             STA RIOT2PBD  
 E2C7  A5 2B     <A NAME="E2C7">iE2C7</A>      LDA TEMP+1    
 E2C9  F0 08                BEQ <A HREF="#E2D3">iE2D3</A>     
 E2CB  AD 82 02             LDA RIOT2PBD  
 E2CE  09 08                ORA #$08       ; ACTLDA
 E2D0  8D 82 02             STA RIOT2PBD  
 E2D3  4C 7E E2  <A NAME="E2D3">iE2D3</A>      JMP <A HREF="#E27E">IDLE2</A>     

 E2D6  A2 FF     <A NAME="E2D6">ATNIRQ</A>     LDX #$FF       ; IRQ routine (triggered by ATN), listen to PET
 E2D8  9A                   TXS            ; clear stack
 E2D9  AD 87 02             LDA RIOT2ATNPE ; clear IRQ flag
 E2DC  A9 18                LDA #$18       ; DAVO+EOIO
 E2DE  0D 80 02             ORA RIOT2PAD   ; free control lines
 E2E1  8D 80 02             STA RIOT2PAD  
 E2E4  A9 FF                LDA #$FF      
 E2E6  8D 02 02             STA RIOT1IEEEDO ; clear data lines
 E2E9  A9 07     <A NAME="E2E9">iE2E9</A>      LDA #$07       ; DACO+RFDO+ATNA
 E2EB  0D 80 02             ORA RIOT2PAD  
 E2EE  8D 80 02             STA RIOT2PAD  
 E2F1  2C 80 02  <A NAME="E2F1">iE2F1</A>      BIT RIOT2PAD  
 E2F4  50 04                BVC <A HREF="#E2FA">iE2FA</A>      ; DAV LO
 E2F6  30 F9                BMI <A HREF="#E2F1">iE2F1</A>      ; ATN LO ATNI HI
 E2F8  10 7B                BPL <A HREF="#E375">iE375</A>      ; ATN HI
 E2FA  A9 FB     <A NAME="E2FA">iE2FA</A>      LDA #$FB       ; 255-RFDO; NRFD LO
 E2FC  2D 80 02             AND RIOT2PAD  
 E2FF  8D 80 02             STA RIOT2PAD  
 E302  29 20                AND #$20       ; save EOI
 E304  85 88                STA EOIFLG    
 E306  AD 00 02             LDA RIOT1IEEEDI
 E309  49 FF                EOR #$FF      
 E30B  85 87                STA DATA       ; save command
 E30D  A9 FD                LDA #$FD       ; 255-DACO; NDAC HI
 E30F  2D 80 02             AND RIOT2PAD  
 E312  8D 80 02             STA RIOT2PAD  
 E315  A0 00                LDY #$00      
 E317  A5 87                LDA DATA      
 E319  29 60                AND #$60      
 E31B  C9 40                CMP #$40       ; TALK?
 E31D  F0 29                BEQ <A HREF="#E348">iE348</A>     
 E31F  C9 20                CMP #$20       ; LISTEN?
 E321  F0 06                BEQ <A HREF="#E329">iE329</A>     
 E323  C9 60                CMP #$60       ; SECONDARY?
 E325  F0 2F                BEQ <A HREF="#E356">iE356</A>     
 E327  D0 44                BNE <A HREF="#E36D">iE36D</A>      ; OTHER
 E329  A5 87     <A NAME="E329">iE329</A>      LDA DATA      
 E32B  C5 32                CMP LSNADR    
 E32D  F0 0B                BEQ <A HREF="#E33A">iE33A</A>      ; my listen address
 E32F  C9 3F                CMP #$3F       ; UNLISTEN
 E331  D0 02                BNE <A HREF="#E335">iE335</A>     
 E333  84 34                STY LSNACT    
 E335  84 36     <A NAME="E335">iE335</A>      STY ADRSED     ; not primary ADDRSED
 E337  4C 6D E3             JMP <A HREF="#E36D">iE36D</A>     
 E33A  85 34     <A NAME="E33A">iE33A</A>      STA LSNACT    
 E33C  84 35                STY TLKACT    
 E33E  A9 20     <A NAME="E33E">iE33E</A>      LDA #$20      
 E340  85 84                STA SA         ; default SA
 E342  85 85                STA ORGSA     
 E344  85 36                STA ADRSED     ; PRIMARY ADDRESSED
 E346  D0 25                BNE <A HREF="#E36D">iE36D</A>     
 E348  84 35     <A NAME="E348">iE348</A>      STY TLKACT    
 E34A  A5 87                LDA DATA      
 E34C  C5 33                CMP TLKADR    
 E34E  D0 E5                BNE <A HREF="#E335">iE335</A>     
 E350  85 35                STA TLKACT    
 E352  84 34                STY LSNACT    
 E354  F0 E8                BEQ <A HREF="#E33E">iE33E</A>     
 E356  A5 36     <A NAME="E356">iE356</A>      LDA ADRSED    
 E358  F0 13                BEQ <A HREF="#E36D">iE36D</A>     
 E35A  A5 87                LDA DATA      
 E35C  85 85                STA ORGSA      ; NOT ADDRESSED
 E35E  48                   PHA           
 E35F  29 0F                AND #$0F      
 E361  85 84                STA SA        
 E363  68                   PLA           
 E364  29 F0                AND #$F0       ; CLOSE?
 E366  C9 E0                CMP #$E0      
 E368  D0 03                BNE <A HREF="#E36D">iE36D</A>     
 E36A  20 0F EC             JSR <A HREF="#EC0F">CLOSE</A>     
 E36D  2C 80 02  <A NAME="E36D">iE36D</A>      BIT RIOT2PAD  
 E370  50 FB                BVC <A HREF="#E36D">iE36D</A>     
 E372  4C E9 E2             JMP <A HREF="#E2E9">iE2E9</A>     
 E375  A5 34     <A NAME="E375">iE375</A>      LDA LSNACT    
 E377  F0 0F                BEQ <A HREF="#E388">iE388</A>     
 E379  A9 FA                LDA #$FA       ; 255-RFDO-ATNA
 E37B  2D 80 02             AND RIOT2PAD  
 E37E  8D 80 02             STA RIOT2PAD  
 E381  58                   CLI           
 E382  20 9B E3             JSR <A HREF="#E39B">LISTEN</A>    
 E385  4C 72 E2             JMP <A HREF="#E272">IDLE</A>      
 E388  A9 FC     <A NAME="E388">iE388</A>      LDA #$FC       ; 255-RFDO-ATNA
 E38A  2D 80 02             AND RIOT2PAD  
 E38D  8D 80 02             STA RIOT2PAD  
 E390  58                   CLI           
 E391  A5 35                LDA TLKACT    
 E393  F0 03                BEQ <A HREF="#E398">iE398</A>     
 E395  20 2B E4             JSR <A HREF="#E42B">TALK</A>      
 E398  4C 72 E2  <A NAME="E398">iE398</A>      JMP <A HREF="#E272">IDLE</A>      

 E39B  A9 04     <A NAME="E39B">LISTEN</A>     LDA #$04       ; RFD HI
 E39D  0D 80 02             ORA RIOT2PAD  
 E3A0  8D 80 02             STA RIOT2PAD  
 E3A3  2C 80 02  <A NAME="E3A3">iE3A3</A>      BIT RIOT2PAD   ; DAV LO
 E3A6  70 FB                BVS <A HREF="#E3A3">iE3A3</A>     
 E3A8  20 AD E9             JSR <A HREF="#E9AD">FNDWCH</A>     ; WAS LDX SA
 E3AB  B0 05                BCS <A HREF="#E3B2">iE3B2</A>     
 E3AD  B5 BE                LDA CHNRDY,X  
 E3AF  6A                   ROR            ; ok, open for LISTEN
 E3B0  B0 49                BCS <A HREF="#E3FB">iE3FB</A>     
 E3B2  A5 85     <A NAME="E3B2">iE3B2</A>      LDA ORGSA      ; WAS TXA
 E3B4  29 F0                AND #$F0       ; SA=OPEN?
 E3B6  C9 F0                CMP #$F0      
 E3B8  F0 41                BEQ <A HREF="#E3FB">iE3FB</A>     
 E3BA  A5 84                LDA SA        
 E3BC  C9 01                CMP #$01       ; save?
 E3BE  F0 0E                BEQ <A HREF="#E3CE">iE3CE</A>     
 E3C0  2C 80 02  <A NAME="E3C0">iE3C0</A>      BIT RIOT2PAD  
 E3C3  50 FB                BVC <A HREF="#E3C0">iE3C0</A>     
 E3C5  A9 FD                LDA #$FD       ; 255-DACO
 E3C7  2D 80 02             AND RIOT2PAD  
 E3CA  8D 80 02             STA RIOT2PAD  
 E3CD  60                   RTS           
 E3CE  A9 FB     <A NAME="E3CE">iE3CE</A>      LDA #$FB       ; 255-RFDO, ACCEPT ALL DATA
 E3D0  2D 80 02             AND RIOT2PAD  
 E3D3  8D 80 02             STA RIOT2PAD   ; RFD LOW
 E3D6  A9 FD                LDA #$FD       ; 255-DACO
 E3D8  2D 80 02             AND RIOT2PAD  
 E3DB  8D 80 02             STA RIOT2PAD   ; DAC HI
 E3DE  2C 80 02  <A NAME="E3DE">iE3DE</A>      BIT RIOT2PAD   ; DAV HI
 E3E1  50 FB                BVC <A HREF="#E3DE">iE3DE</A>     
 E3E3  A9 02                LDA #$02       ; DACO
 E3E5  0D 80 02             ORA RIOT2PAD  
 E3E8  8D 80 02             STA RIOT2PAD   ; DAC LOW
 E3EB  A9 04                LDA #$04       ; RFDO, RFD HI
 E3ED  0D 80 02             ORA RIOT2PAD  
 E3F0  8D 80 02             STA RIOT2PAD  
 E3F3  2C 80 02  <A NAME="E3F3">iE3F3</A>      BIT RIOT2PAD   ; WAIT DAV LOW
 E3F6  50 FB                BVC <A HREF="#E3F3">iE3F3</A>     
 E3F8  4C CE E3             JMP <A HREF="#E3CE">iE3CE</A>      ; Do UNTIL ATn PULLED
 E3FB  A9 FB     <A NAME="E3FB">iE3FB</A>      LDA #$FB       ; 255-RFDO
 E3FD  2D 80 02             AND RIOT2PAD  
 E400  8D 80 02             STA RIOT2PAD  
 E403  29 20                AND #$20      
 E405  85 88                STA EOIFLG    
 E407  AD 00 02             LDA RIOT1IEEEDI
 E40A  49 FF                EOR #$FF      
 E40C  85 87                STA DATA      
 E40E  78                   SEI           
 E40F  A9 FD                LDA #$FD       ; 255-DACO
 E411  2D 80 02             AND RIOT2PAD  
 E414  8D 80 02             STA RIOT2PAD  
 E417  2C 80 02  <A NAME="E417">iE417</A>      BIT RIOT2PAD  
 E41A  50 FB                BVC <A HREF="#E417">iE417</A>     
 E41C  A9 02                LDA #$02       ; DACO
 E41E  0D 80 02             ORA RIOT2PAD  
 E421  8D 80 02             STA RIOT2PAD  
 E424  20 FE E7             JSR <A HREF="#E7FE">PUT</A>       
 E427  58                   CLI <A HREF="#E7FE"></A>          
 E428  4C 9B E3             JMP <A HREF="#E39B">LISTEN</A>    

 E42B  20 B0 E9  <A NAME="E42B">TALK</A>       JSR <A HREF="#E9B0">FNDRCH</A>    
 E42E  B0 06                BCS <A HREF="#E436">NOTLK</A>      ; TEST IF CHANNEL READY
 E430  A6 83     <A NAME="E430">iE430</A>      LDX LINDX     
 E432  B5 BE                LDA CHNRDY,X  
 E434  30 01                BMI <A HREF="#E437">iE437</A>     
 E436  60        <A NAME="E436">NOTLK</A>      RTS <A HREF="#E437"></A>          
 E437  2C 82 02  <A NAME="E437">iE437</A>      BIT RIOT2PBD   ; RFD HI
 E43A  10 FB                BPL <A HREF="#E437">iE437</A>     
 E43C  BD D9 10             LDA CHNDAT,X  
 E43F  49 FF                EOR #$FF      
 E441  8D 02 02             STA RIOT1IEEEDO
 E444  B5 BE                LDA CHNRDY,X  
 E446  09 E7                ORA #$E7       ; 255-EOIO-DAVO, DAV LO
 E448  2D 80 02             AND RIOT2PAD  
 E44B  8D 80 02             STA RIOT2PAD  
 E44E  2C 82 02  <A NAME="E44E">iE44E</A>      BIT RIOT2PBD  
 E451  10 0D                BPL <A HREF="#E460">iE460</A>     
 E453  50 F9                BVC <A HREF="#E44E">iE44E</A>     
 E455  A9 18                LDA #$18       ; DAVO+EOIO
 E457  0D 80 02             ORA RIOT2PAD  
 E45A  8D 80 02             STA RIOT2PAD  
 E45D  4C 72 E2             JMP <A HREF="#E272">IDLE</A>      
 E460  20 D6 EC  <A NAME="E460">iE460</A>      JSR <A HREF="#ECD6">GET</A>       
 E463  2C 82 02  <A NAME="E463">iE463</A>      BIT RIOT2PBD  
 E466  50 FB                BVC <A HREF="#E463">iE463</A>     
 E468  A9 FF                LDA #$FF      
 E46A  8D 02 02             STA RIOT1IEEEDO
 E46D  A9 18                LDA #$18       ; DAVO+EOIO
 E46F  0D 80 02             ORA RIOT2PAD  
 E472  8D 80 02             STA RIOT2PAD  
 E475  2C 82 02  <A NAME="E475">iE475</A>      BIT RIOT2PBD  
 E478  70 FB                BVS <A HREF="#E475">iE475</A>     
 E47A  50 B4                BVC <A HREF="#E430">iE430</A>      ; END OF IEEE

; NEXT TRACK &amp; SECTOR
; RETURNS NEXT AVAILABLE TRACK &amp; SECTOR
; GIVEN CURRENT T &amp; S
; ;
; ALLOCATION IS FROM TRACK 18
; TOWARDS 1 &amp; 35, BY FULL TRACKS

 E47C  20 9D E8  <A NAME="E47C">NXTTS</A>      JSR <A HREF="#E89D">GETACT</A>    
 E47F  0A                   ASL <A HREF="#E89D"></A>          
 E480  0A                   ASL <A HREF="#E89D"></A>          
 E481  0A                   ASL <A HREF="#E89D"></A>          
 E482  AA                   TAX <A HREF="#E89D"></A>          
 E483  BD 23 10             LDA HDRS+2,X  
 E486  85 81                STA TRACK     
 E488  BD 24 10             LDA HDRS+3,X  
 E48B  85 82                STA SECTOR    
 E48D  A9 02                LDA #$02      
 E48F  85 2A                STA TEMP      
 E491  A6 80     <A NAME="E491">NXTDS</A>      LDX DRVNUM    
 E493  BD 40 E5             LDA <A HREF="#E540">IPBM,X</A>    
 E496  85 29                STA BMPNT+1   
 E498  A9 00                LDA #$00      
 E49A  85 28                STA BMPNT     
 E49C  A5 81     <A NAME="E49C">iE49C</A>      LDA TRACK     
 E49E  0A                   ASL           
 E49F  0A                   ASL           
 E4A0  A8                   TAY           
 E4A1  B1 28                LDA (BMPNT),Y 
 E4A3  D0 33                BNE <A HREF="#E4D8">FNDNXT</A>    
 E4A5  A5 81                LDA TRACK     
 E4A7  C9 12                CMP #$12      
 E4A9  F0 16                BEQ <A HREF="#E4C1">iE4C1</A>     
 E4AB  90 19                BCC <A HREF="#E4C6">iE4C6</A>     
 E4AD  E6 81                INC TRACK     
 E4AF  A5 81                LDA TRACK     
 E4B1  C9 24                CMP #$24      
 E4B3  D0 E7                BNE <A HREF="#E49C">iE49C</A>     
 E4B5  A9 11                LDA #$11      
 E4B7  85 81                STA TRACK     
 E4B9  A9 00                LDA #$00      
 E4BB  85 82                STA SECTOR    
 E4BD  C6 2A                DEC TEMP      
 E4BF  D0 DB                BNE <A HREF="#E49C">iE49C</A>     
 E4C1  A9 72     <A NAME="E4C1">iE4C1</A>      LDA #$72       ; DSKFUL
 E4C3  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 E4C6  C6 81     <A NAME="E4C6">iE4C6</A>      DEC TRACK     
 E4C8  D0 D2                BNE <A HREF="#E49C">iE49C</A>     
 E4CA  A9 13                LDA #$13      
 E4CC  85 81                STA TRACK     
 E4CE  A9 00                LDA #$00      
 E4D0  85 82                STA SECTOR    
 E4D2  C6 2A                DEC TEMP      
 E4D4  D0 C6                BNE <A HREF="#E49C">iE49C</A>     
 E4D6  F0 E9                BEQ <A HREF="#E4C1">iE4C1</A>     

; FIND THE NEXT OPTIMUM SECTOR
; NEXT SECTOR=CURRENT SECTOR+N

 E4D8  A5 82     <A NAME="E4D8">FNDNXT</A>     LDA SECTOR    
 E4DA  18                   CLC           
 E4DB  65 92                ADC SECINC    
 E4DD  85 82                STA SECTOR    
 E4DF  A5 81                LDA TRACK     
 E4E1  20 B1 E5             JSR <A HREF="#E5B1">MAXSEC</A>    
 E4E4  85 8A                STA LSTSEC    
 E4E6  85 89                STA CMD       
 E4E8  C5 82                CMP SECTOR    
 E4EA  B0 11                BCS <A HREF="#E4FD">iE4FD</A>     
 E4EC  38                   SEC <A HREF="#E4FD"></A>          
 E4ED  A5 82                LDA SECTOR    
 E4EF  E5 8A                SBC LSTSEC    
 E4F1  85 82                STA SECTOR    
 E4F3  F0 08                BEQ <A HREF="#E4FD">iE4FD</A>     
 E4F5  C6 82                DEC SECTOR    
 E4F7  D0 04                BNE <A HREF="#E4FD">iE4FD</A>     
 E4F9  A9 00     <A NAME="E4F9">iE4F9</A>      LDA #$00      
 E4FB  85 82                STA SECTOR    
 E4FD  20 6B E5  <A NAME="E4FD">iE4FD</A>      JSR <A HREF="#E56B">AVAIL</A>     
 E500  20 87 E5  <A NAME="E500">iE500</A>      JSR <A HREF="#E587">AV2</A>       
 E503  B0 13                BCS <A HREF="#E518">iE518</A>     
 E505  C6 89                DEC CMD       
 E507  10 05                BPL <A HREF="#E50E">iE50E</A>     
 E509  A9 71                LDA #$71      
 E50B  4C D4 E6             JMP <A HREF="#E6D4">CMDER2</A>    
 E50E  A5 82     <A NAME="E50E">iE50E</A>      LDA SECTOR    
 E510  E6 82                INC SECTOR    
 E512  C5 8A                CMP LSTSEC    
 E514  D0 EA                BNE <A HREF="#E500">iE500</A>     
 E516  F0 E1                BEQ <A HREF="#E4F9">iE4F9</A>     
 E518  4C A0 E7  <A NAME="E518">iE518</A>      JMP <A HREF="#E7A0">USEDTS</A>    

; RETURNS OPTIMUM INITIAL TRACK, SECTOR

 E51B  A9 11     <A NAME="E51B">INTTS</A>      LDA #$11      
 E51D  85 81                STA TRACK     
 E51F  20 5F E5             JSR <A HREF="#E55F">SETBMP</A>    
 E522  A5 81     <A NAME="E522">iE522</A>      LDA TRACK     
 E524  0A                   ASL           
 E525  0A                   ASL           
 E526  A8                   TAY           
 E527  B1 28                LDA (BMPNT),Y 
 E529  D0 17                BNE <A HREF="#E542">FNDSEC</A>    
 E52B  A9 24                LDA #$24      
 E52D  38                   SEC           
 E52E  E5 81                SBC TRACK     
 E530  0A                   ASL           
 E531  0A                   ASL           
 E532  A8                   TAY           
 E533  B1 28                LDA (BMPNT),Y 
 E535  D0 0B                BNE <A HREF="#E542">FNDSEC</A>    
 E537  C6 81                DEC TRACK     
 E539  D0 E7                BNE <A HREF="#E522">iE522</A>     
 E53B  A9 72                LDA #$72       ; DSKFUL
 E53D  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 E540  <A NAME="E540">IPBM</A>       .byte $42, $43                                ;bc

 E542  98        <A NAME="E542">FNDSEC</A>     TYA <A HREF="#F090"></A>          
 E543  4A                   LSR <A HREF="#F090"></A>          
 E544  4A                   LSR <A HREF="#F090"></A>          
 E545  85 81                STA TRACK     
 E547  A9 00                LDA #$00      
 E549  85 82                STA SECTOR    
 E54B  20 6B E5             JSR <A HREF="#E56B">AVAIL</A>     
 E54E  20 87 E5  <A NAME="E54E">iE54E</A>      JSR <A HREF="#E587">AV2</A>       
 E551  B0 09                BCS <A HREF="#E55C">iE55C</A>     
 E553  E6 82                INC SECTOR    
 E555  D0 F7                BNE <A HREF="#E54E">iE54E</A>     
 E557  A9 71                LDA #$71       ; DIRERR
 E559  4C D4 E6             JMP <A HREF="#E6D4">CMDER2</A>    
 E55C  4C A0 E7  <A NAME="E55C">iE55C</A>      JMP <A HREF="#E7A0">USEDTS</A>    

; SET (INDIRECT) BAM PNTR BY DRVNUM

 E55F  A6 80     <A NAME="E55F">SETBMP</A>     LDX DRVNUM    
 E561  BD 40 E5             LDA <A HREF="#E540">IPBM,X</A>    
 E564  85 29                STA BMPNT+1   
 E566  A9 00                LDA #$00      
 E568  85 28                STA BMPNT     
 E56A  60                   RTS           

; LOAD TRACK BAM INTO TEMP AND FINDS
; AVAILABLE SECTOR ON THE TRACK

 E56B  A5 81     <A NAME="E56B">AVAIL</A>      LDA TRACK     
 E56D  0A                   ASL           
 E56E  0A                   ASL           
 E56F  A8                   TAY           
 E570  B1 28                LDA (BMPNT),Y 
 E572  85 2D                STA TEMP+3    
 E574  A2 02                LDX #$02      
 E576  C8        <A NAME="E576">iE576</A>      INY           
 E577  B1 28                LDA (BMPNT),Y 
 E579  95 2A                STA TEMP,X    
 E57B  CA                   DEX           
 E57C  10 F8                BPL <A HREF="#E576">iE576</A>     
 E57E  20 93 E5             JSR <A HREF="#E593">AVCK</A>      
 E581  A4 82                LDY SECTOR    
 E583  F0 0D                BEQ <A HREF="#E592">iE592</A>     
 E585  D0 02                BNE <A HREF="#E589">iE589</A>     
 E587  A0 01     <A NAME="E587">AV2</A>        LDY #$01      
 E589  66 2A     <A NAME="E589">iE589</A>      ROR TEMP      
 E58B  66 2B                ROR TEMP+1    
 E58D  66 2C                ROR TEMP+2    
 E58F  88                   DEY           
 E590  D0 F7                BNE <A HREF="#E589">iE589</A>     
 E592  60        <A NAME="E592">iE592</A>      RTS <A HREF="#E589"></A>          

; BIT MAP VALIDITY CHECK

 E593  A2 00     <A NAME="E593">AVCK</A>       LDX #$00      
 E595  A0 03                LDY #$03      
 E597  D0 06                BNE <A HREF="#E59F">iE59F</A>      ; (BRANCH)
 E599  E8        <A NAME="E599">iE599</A>      INX <A HREF="#E59F"></A>          
 E59A  4A        <A NAME="E59A">iE59A</A>      LSR <A HREF="#E59F"></A>          
 E59B  B0 FC                BCS <A HREF="#E599">iE599</A>     
 E59D  D0 FB                BNE <A HREF="#E59A">iE59A</A>     
 E59F  B9 29 00  <A NAME="E59F">iE59F</A>      LDA BMPNT+1,Y 
 E5A2  88                   DEY           
 E5A3  10 F5                BPL <A HREF="#E59A">iE59A</A>     
 E5A5  E4 2D                CPX TEMP+3    
 E5A7  F0 07                BEQ <A HREF="#E5B0">iE5B0</A>     
 E5A9  A9 71                LDA #$71       ; DIRERR
 E5AB  A0 00                LDY #$00      
 E5AD  4C D4 E6             JMP <A HREF="#E6D4">CMDER2</A>    
 E5B0  60        <A NAME="E5B0">iE5B0</A>      RTS <A HREF="#E6D4"></A>          

; .A=TRACK # ,RETURNS #SECTORS ON THIS TRACK

 E5B1  A2 04     <A NAME="E5B1">MAXSEC</A>     LDX #$04      
 E5B3  DD BC E5  <A NAME="E5B3">iE5B3</A>      CMP <A HREF="#E5BD">TRKNUM-1,X</A>
 E5B6  CA                   DEX <A HREF="#E5BD"></A>          
 E5B7  B0 FA                BCS <A HREF="#E5B3">iE5B3</A>     
 E5B9  BD C1 E5             LDA <A HREF="#E5C1">NUMSEC,X</A>  
 E5BC  60        <A NAME="E5BC">xE5BC</A>      RTS <A HREF="#E5C1"></A>          

 E5BD  <A NAME="E5BD">TRKNUM</A>     .byte $24, $1F, $19, $12                      ;$_yr
 E5C1  <A NAME="E5C1">NUMSEC</A>     .byte $11, $12, $14, $15                      ;qrtu

; ;
; this is the original comment on the error table in the 4040
; of course the table here is similar, but still different.
; ;
; ; CONTROLLER ERRORS
; ;  0  (1)  NO ERROR
; ; 20  (2)  CAN'T FIND BLOCK HEADER
; ; 21  (3)  NO SYNCH CHARACTER
; ; 22  (4)  DATA BLOCK NOT PRESENT
; ; 23  (5)  CHECKSUM ERROR IN DATA
; ; 24  (16) BYTE DECODING ERROR
; ; 25  (7)  WRITE-VERIFY ERROR
; ; 26  (8)  WRITE W/ WRITE PROTECT ON
; ; 27  (9)  CHECKSUM ERROR IN HEADER
; ; 28  (10) DATA EXTENDS INTO NEXT BLOCK
; ; 29  (11) DISK I.D. MISMATCH
; .SKIP
; ; COMMAND ERRORS
; ; 30  GENERAL SYNTAX
; ; 31  INVALID COMMAND
; ; 32  LONG LINE
; ; 33  INVALID FILNAME
; ; 34  NO FILE GIVEN
; .SKIP
; ; 50  RECORD NOT PRESENT
; ; 51  OVERFLOW IN RECORD
; ; 52  FILE TOO LARGE
; .SKIP
; ; 60  FILE OPEN FOR WRITE
; ; 61  FILE NOT OPEN
; ; 62  FILE NOT FOUND
; ; 63  FILE EXISTS
; ; 64  FILE TYPE MISMATCH
; ; 65  NO BLOCK
; ; 66  ILLEGAL TRACK OR SECTOR
; ; 67  ILLEGAL SYSTEM T OR S
; .SKIP
; ; 70  NO CHANNELS AVAILABLE
; ; 71  DIRECTORY ERROR
; ; 72  DISK FULL
; ; 73  CBM DOS V2
; .SKIP
; ;  1  FILES SCRATCHED RESPONSE
; .SKIP2
; BADSYN =$30
; BADCMD =$31
; LONGLN =$32
; BADFN =$33
; NOFILE =$34
; NOREC =$50
; RECOVF =$51
; BIGFIL =$52
; FILOPN =$60
; FILNOP =$61
; FLNTFD =$62
; FLEXST =$63
; MISTYP =$64
; NOBLK =$65
; BADTS =$66
; NOCHNL =$70
; DIRERR =$71
; DSKFUL =$72
; CBMV2 =$73
; .PAGE
; ; ERROR MESSAGE TABLE
; ;   LEADING ERRROR NUMBERS,
; ;   TEXT WITH 1ST &amp; LAST CHARS
; ;   OR'ED WITH $80,
; ;   TOKENS FOR KEY WORDS ARE
; ;   LESS THAN $10 (AND'ED W/ $80)

 E5C5  <A NAME="E5C5">ERRTAB</A>     .byte $00, $A0, $4F, $CB                      ;. oK
 E5C9  <A NAME="E5C9">e_read</A>     .byte $20, $21, $22, $23, $24, $27, $D2, $45  ; !"#$'Re
 E5D1             .byte $41, $44, $89                           ;ad.
 E5D4  <A NAME="E5D4">e_write</A>    .byte $25, $28, $8A, $89                      ;%(..
 E5D8  <A NAME="E5D8">e_prot</A>     .byte $26, $8A, $20, $50, $52, $4F, $54, $45  ;&. prote
 E5E0             .byte $43, $54, $20, $4F, $CE                 ;ct oN
 E5E5  <A NAME="E5E5">e_id</A>       .byte $29, $88, $20, $49, $44, $85            ;). id.
 E5EB  <A NAME="E5EB">e_synt</A>     .byte $30, $31, $32, $33, $34, $D3, $59, $4E  ;01234Syn
 E5F3             .byte $54, $41, $58, $89                      ;tax.
 E5F7  <A NAME="E5F7">e_wfile</A>    .byte $60, $8A, $03, $84                      ;`.c.
 E5FB  <A NAME="E5FB">e_exist</A>    .byte $63, $83, $20, $45, $58, $49, $53, $54  ;C. exist
 E603             .byte $D3                                     ;S
 E604  <A NAME="E604">e_type</A>     .byte $64, $83, $20, $54, $59, $50, $45, $85  ;D. type.
 E60C  <A NAME="E60C">e_block</A>    .byte $65, $CE, $4F, $20, $42, $4C, $4F, $43  ;ENo bloc
 E614             .byte $CB                                     ;K
 E615  <A NAME="E615">e_fnotop</A>   .byte $61, $83, $06, $84                      ;A.f.
 E619  <A NAME="E619">e_fnotfnd</A>  .byte $62, $83, $06, $87                      ;B.f.
 E61D  <A NAME="E61D">e_scratchd</A> .byte $01, $83, $53, $20, $53, $43, $52, $41  ;a.s scra
 E625             .byte $54, $43, $48, $45, $C4                 ;tcheD
 E62A  <A NAME="E62A">e_nchanl</A>   .byte $70, $CE, $4F, $20, $43, $48, $41, $4E  ;PNo chan
 E632             .byte $4E, $45, $CC                           ;neL
 E635  <A NAME="E635">e_dir</A>      .byte $71, $C4, $49, $52, $89                 ;QDir.
 E63A  <A NAME="E63A">e_dskfull</A>  .byte $72, $88, $20, $46, $55, $4C, $CC       ;R. fulL
 E641  <A NAME="E641">t_error</A>    .byte $09, $C5, $52, $52, $4F, $D2            ;iErroR
 E647  <A NAME="E647">t_write</A>    .byte $0A, $D7, $52, $49, $54, $C5            ;jWritE
 E64D  <A NAME="E64D">t_file</A>     .byte $03, $C6, $49, $4C, $C5                 ;cFilE
 E652  <A NAME="E652">t_open</A>     .byte $04, $CF, $50, $45, $CE                 ;dOpeN
 E657  <A NAME="E657">t_mismatch</A> .byte $05, $CD, $49, $53, $4D, $41, $54, $43  ;eMismatc
 E65F             .byte $C8                                     ;H
 E660  <A NAME="E660">t_not</A>      .byte $06, $CE, $4F, $D4                      ;fNoT
 E664  <A NAME="E664">t_found</A>    .byte $07, $C6, $4F, $55, $4E, $C4            ;gFounD
 E66A  <A NAME="E66A">t_disk</A>     .byte $08, $C4, $49, $53, $CB                 ;hDisK


; .A=BCD ERROR #


; RECURSIVE (2) ERROR MESSAGE ROUTINE


 E66F  DD C5 E5  <A NAME="E66F">MOVERR</A>     CMP <A HREF="#E5C5">ERRTAB,X</A>   ; .A=BCD ERROR #
 E672  F0 06                BEQ <A HREF="#E67A">iE67A</A>     
 E674  E8                   INX <A HREF="#E67A"></A>          
 E675  E0 AA                CPX #$AA       ; ERREND
 E677  90 F6                BCC <A HREF="#E66F">MOVERR</A>    
 E679  60                   RTS <A HREF="#E66F"></A>          
 E67A  E8        <A NAME="E67A">iE67A</A>      INX <A HREF="#E66F"></A>           ; SKIP PAST ERROR #'S
 E67B  BD C5 E5             LDA <A HREF="#E5C5">ERRTAB,X</A>  
 E67E  10 FA                BPL <A HREF="#E67A">iE67A</A>     
 E680  29 7F                AND #$7F      
 E682  C9 10     <A NAME="E682">iE682</A>      CMP #$10      
 E684  90 17                BCC <A HREF="#E69D">iE69D</A>     
 E686  99 B4 43             STA ERRBUF,Y  
 E689  C8                   INY           
 E68A  E8        <A NAME="E68A">iE68A</A>      INX           
 E68B  BD C5 E5             LDA <A HREF="#E5C5">ERRTAB,X</A>  
 E68E  10 F2                BPL <A HREF="#E682">iE682</A>     
 E690  48                   PHA <A HREF="#E682"></A>           ; LAST CHARACTER
 E691  29 7F                AND #$7F      
 E693  C9 10                CMP #$10      
 E695  90 07                BCC <A HREF="#E69E">iE69E</A>      ; TOKEN
 E697  99 B4 43             STA ERRBUF,Y  
 E69A  C8                   INY           
 E69B  68                   PLA           
 E69C  60                   RTS           
 E69D  48        <A NAME="E69D">iE69D</A>      PHA            ; TOKEN PROCESS
 E69E  48        <A NAME="E69E">iE69E</A>      PHA           
 E69F  A9 20                LDA #$20      
 E6A1  99 B4 43             STA ERRBUF,Y   ; IMPLIED LEADING SPACE
 E6A4  C8                   INY           
 E6A5  68                   PLA           
 E6A6  86 2D                STX TEMP+3    
 E6A8  A2 7C                LDX #$7C       ; ERRTOK
 E6AA  20 6F E6             JSR <A HREF="#E66F">MOVERR</A>     ; RECURSIVE FOR TOKENS
 E6AD  A6 2D                LDX TEMP+3    
 E6AF  68                   PLA           
 E6B0  10 D8                BPL <A HREF="#E68A">iE68A</A>     
 E6B2  60                   RTS <A HREF="#E68A"></A>          

; CONTROLLER ERROR ENTRY
; .A= ERROR #
; .X= JOB #

 E6B3  48        <A NAME="E6B3">ERROR</A>      PHA <A HREF="#E68A"></A>          
 E6B4  86 8D                STX JOBNUM    
 E6B6  8A                   TXA           
 E6B7  0A                   ASL           
 E6B8  0A                   ASL           
 E6B9  0A                   ASL           
 E6BA  AA                   TAX           
 E6BB  BD 23 10             LDA HDRS+2,X   ; RECALL TRACK,SECTOR
 E6BE  85 81                STA TRACK     
 E6C0  BD 24 10             LDA HDRS+3,X  
 E6C3  85 82                STA SECTOR    
 E6C5  68                   PLA           
 E6C6  29 0F                AND #$0F       ; CONVERT CONTROLLER...
 E6C8  D0 02                BNE <A HREF="#E6CC">iE6CC</A>      ; ...ERRORS TO DOS ERRORS
 E6CA  A9 06                LDA #$06       ; CODE=16--&gt;14
 E6CC  09 20     <A NAME="E6CC">iE6CC</A>      ORA #$20      
 E6CE  AA                   TAX           
 E6CF  CA                   DEX           
 E6D0  CA                   DEX           
 E6D1  8A                   TXA           
 E6D2  A0 00                LDY #$00      
 E6D4  20 5D E7  <A NAME="E6D4">CMDER2</A>     JSR <A HREF="#E75D">ERRMSG</A>    
 E6D7  20 81 E1             JSR <A HREF="#E181">DROMTS</A>     ; check for diagnostic ROM
 E6DA  D0 03                BNE <A HREF="#E6DF">iE6DF</A>     
 E6DC  4C 02 D0             JMP DIAGROM+2 
 E6DF  AD 82 02  <A NAME="E6DF">iE6DF</A>      LDA RIOT2PBD   ; SET ERROR LED
 E6E2  09 20                ORA #$20       ; ERRLED
 E6E4  8D 82 02             STA RIOT2PBD  
 E6E7  20 A9 EE             JSR <A HREF="#EEA9">FREICH</A>     ; FREE INTERNAL CHANNEL
 E6EA  A9 00                LDA #$00       ; CLEAR POINTERS
 E6EC  85 5B                STA x5B        ; the 4040 purges the stack and SEI
 E6EE  85 5C                STA x5C       
 E6F0  A5 83                LDA LINDX     
 E6F2  C9 06                CMP #$06      
 E6F4  B0 08                BCS <A HREF="#E6FE">iE6FE</A>     
 E6F6  A5 34                LDA LSNACT    
 E6F8  D0 21                BNE <A HREF="#E71B">LSNERR</A>     ; error while listening
 E6FA  A5 35                LDA TLKACT    
 E6FC  D0 03                BNE <A HREF="#E701">TLKERR</A>     ; error while talking
 E6FE  4C 72 E2  <A NAME="E6FE">iE6FE</A>      JMP <A HREF="#E272">IDLE</A>      

; TALKER ERROR RECOVERY
; IF COMMAND CHANNEL, RELEASE DAV
; IF DATA CHANNEL, FORCE NOT READY
; AND RELEASE CHANNEL
; this code is different from 4040

 E701  A5 84     <A NAME="E701">TLKERR</A>     LDA SA        
 E703  C9 0F                CMP #$0F      
 E705  F0 09                BEQ <A HREF="#E710">iE710</A>     
 E707  A6 83                LDX LINDX     
 E709  A9 80                LDA #$80      
 E70B  95 BE                STA CHNRDY,X  
 E70D  20 32 EB             JSR <A HREF="#EB32">FRECHN</A>    
 E710  AD 80 02  <A NAME="E710">iE710</A>      LDA RIOT2PAD  
 E713  09 10                ORA #$10       ; DAVO
 E715  8D 80 02             STA RIOT2PAD  
 E718  4C 72 E2             JMP <A HREF="#E272">IDLE</A>      

; LISTENER ERROR RECOVERY
; IF COMMAND CHANNEL, RELEASE RFD
; IF DATA CHANNEL, FORCE NOT READY
; AND RELEASE CHANNEL
; this code is different from 4040

 E71B  A5 84     <A NAME="E71B">LSNERR</A>     LDA SA        
 E71D  C9 0F                CMP #$0F      
 E71F  F0 0C                BEQ <A HREF="#E72D">iE72D</A>     
 E721  20 AD E9             JSR <A HREF="#E9AD">FNDWCH</A>    
 E724  A6 83                LDX LINDX     
 E726  A9 00                LDA #$00      
 E728  95 BE                STA CHNRDY,X  
 E72A  20 32 EB             JSR <A HREF="#EB32">FRECHN</A>    
 E72D  A9 04     <A NAME="E72D">iE72D</A>      LDA #$04      
 E72F  0D 80 02             ORA RIOT2PAD  
 E732  29 FE                AND #$FE      
 E734  8D 80 02             STA RIOT2PAD  
 E737  4C 72 E2             JMP <A HREF="#E272">IDLE</A>      

; CONVERT HEX TO BCD

 E73A  AA        <A NAME="E73A">HEXDEC</A>     TAX <A HREF="#E272"></A>          
 E73B  A9 00                LDA #$00      
 E73D  F8                   SED           
 E73E  E0 00     <A NAME="E73E">iE73E</A>      CPX #$00      
 E740  F0 07                BEQ <A HREF="#E749">iE749</A>     
 E742  18                   CLC <A HREF="#E749"></A>          
 E743  69 01                ADC #$01      
 E745  CA                   DEX           
 E746  4C 3E E7             JMP <A HREF="#E73E">iE73E</A>     
 E749  D8        <A NAME="E749">iE749</A>      CLD <A HREF="#E73E"></A>          

; CONVERT BCD TO ASCII DEC
; RETURN BCD IN .X
; STORE ASCII IN (TEMP)Y

 E74A  AA        <A NAME="E74A">BCDDEC</A>     TAX <A HREF="#E73E"></A>          
 E74B  4A                   LSR <A HREF="#E73E"></A>          
 E74C  4A                   LSR <A HREF="#E73E"></A>          
 E74D  4A                   LSR <A HREF="#E73E"></A>          
 E74E  4A                   LSR <A HREF="#E73E"></A>          
 E74F  09 30                ORA #$30      
 E751  91 2A                STA (TEMP),Y  
 E753  C8                   INY           
 E754  8A                   TXA           
 E755  29 0F                AND #$0F      
 E757  09 30                ORA #$30      
 E759  91 2A                STA (TEMP),Y  
 E75B  C8                   INY           
 E75C  60                   RTS           

 E75D  A2 B4     <A NAME="E75D">ERRMSG</A>     LDX #$B4       ; &lt;ERRBUF
 E75F  86 2A                STX TEMP      
 E761  A2 43                LDX #$43       ; &gt;ERRBUF
 E763  86 2B                STX TEMP+1    
 E765  20 4A E7             JSR <A HREF="#E74A">BCDDEC</A>    
 E768  A9 2C                LDA #$2C       ; ","
 E76A  99 B4 43             STA ERRBUF,Y  
 E76D  C8                   INY           
 E76E  AD B4 43             LDA ERRBUF    
 E771  8D E0 10             STA CHNDAT+7   ; CHNDAT+ERRCHN
 E774  A9 B5                LDA #$B5      
 E776  85 5D                STA x5D       
 E778  8A                   TXA            ; ERROR # IN .X
 E779  A2 00                LDX #$00      
 E77B  20 6F E6             JSR <A HREF="#E66F">MOVERR</A>     ; MOVE MESSAGE
 E77E  A9 2C                LDA #$2C       ; ","
 E780  99 B4 43             STA ERRBUF,Y  
 E783  C8                   INY           
 E784  A5 81                LDA TRACK      ; CONVERT TRACK #
 E786  20 3A E7             JSR <A HREF="#E73A">HEXDEC</A>    
 E789  A9 2C                LDA #$2C      
 E78B  99 B4 43             STA ERRBUF,Y  
 E78E  C8                   INY           
 E78F  A5 82                LDA SECTOR     ; CONVERT SECTOR #
 E791  20 3A E7             JSR <A HREF="#E73A">HEXDEC</A>    
 E794  A9 0D                LDA #$0D      
 E796  99 B4 43             STA ERRBUF,Y  
 E799  18                   CLC           
 E79A  98                   TYA           
 E79B  69 B4                ADC #$B4       ; &lt;ERRBUF
 E79D  85 CD                STA LSTCHR+7   ; LSTCHR++ERRCHN; SET LAST CHAR
 E79F  60                   RTS           

; MARK TRACK, SECTOR, (BMPNT) AS USED

 E7A0  A5 81     <A NAME="E7A0">USEDTS</A>     LDA TRACK      ; CALC INDEX INTO BAM
 E7A2  0A                   ASL           
 E7A3  0A                   ASL            ; 4 BYTES IN BAM PER TRACK
 E7A4  85 2A                STA TEMP       ; SAVE INDEX
 E7A6  A8                   TAY           
 E7A7  B1 28                LDA (BMPNT),Y 
 E7A9  AA                   TAX           
 E7AA  CA                   DEX           
 E7AB  8A                   TXA           
 E7AC  91 28                STA (BMPNT),Y 
 E7AE  A5 82                LDA SECTOR     ; A=SECTOR/8
 E7B0  4A                   LSR           
 E7B1  4A                   LSR           
 E7B2  4A                   LSR            ; FOR WHICH OF THREE BYTES
 E7B3  18                   CLC            ; the 4040 has a "SEC" here (in routing FREUSE) and no "INY" in e7b7 :-)
 E7B4  65 2A                ADC TEMP       ; CALC INDEX
 E7B6  A8                   TAY           
 E7B7  C8                   INY           
 E7B8  A5 82                LDA SECTOR     ; BIT IN THAT BYTE
 E7BA  29 07                AND #$07      
 E7BC  AA                   TAX           
 E7BD  A9 01                LDA #$01       ; this routine calculates(!) the bitmask; the 4040 reads it of a table
 E7BF  CA        <A NAME="E7BF">iE7BF</A>      DEX           
 E7C0  30 03                BMI <A HREF="#E7C5">iE7C5</A>     
 E7C2  0A                   ASL <A HREF="#E7C5"></A>          
 E7C3  90 FA                BCC <A HREF="#E7BF">iE7BF</A>     
 E7C5  85 2A     <A NAME="E7C5">iE7C5</A>      STA TEMP      
 E7C7  B1 28                LDA (BMPNT),Y  ; GET THE BYTE
 E7C9  25 2A                AND TEMP       ; TEST IT; Z=1=USED, Z=0=FREE
 E7CB  D0 0D                BNE <A HREF="#E7DA">iE7DA</A>      ; jump when free
 E7CD  A5 81                LDA TRACK      ; USED, "NO ACTION"
 E7CF  0A                   ASL           
 E7D0  0A                   ASL           
 E7D1  A8                   TAY           
 E7D2  B1 28                LDA (BMPNT),Y 
 E7D4  AA                   TAX           
 E7D5  E8                   INX           
 E7D6  8A                   TXA           
 E7D7  91 28                STA (BMPNT),Y 
 E7D9  60                   RTS           
 E7DA  A5 2A     <A NAME="E7DA">iE7DA</A>      LDA TEMP      
 E7DC  49 FF                EOR #$FF      
 E7DE  31 28                AND (BMPNT),Y  ; MARK SEC USED
 E7E0  91 28                STA (BMPNT),Y 
 E7E2  60                   RTS            ; note the count is not fixed here (as in 4040)!

 E7E3  A5 83     <A NAME="E7E3">DBLBUF</A>     LDA LINDX      ; TOGGLE ACTIVE BUFFER # IN BUFNUM
 E7E5  0A                   ASL           
 E7E6  AA                   TAX           
 E7E7  B5 5F                LDA BUFNUM,X   ; TOGGLE ACTIVE FLAG
 E7E9  49 80                EOR #$80      
 E7EB  95 5F                STA BUFNUM,X  
 E7ED  30 00                BMI <A HREF="#E7EF">iE7EF</A>      ; not needed...
 E7EF  B5 60     <A NAME="E7EF">iE7EF</A>      LDA BUFNUM+1,X ; TOGGLE ACTIVE FLAG
 E7F1  49 80                EOR #$80      
 E7F3  95 60                STA BUFNUM+1,X
 E7F5  30 00                BMI <A HREF="#E7F7">iE7F7</A>     
 E7F7  20 9D E8  <A NAME="E7F7">iE7F7</A>      JSR <A HREF="#E89D">GETACT</A>     ; GET ACTIVE BUF#
 E7FA  AA                   TAX <A HREF="#E89D"></A>          
 E7FB  4C 59 E8             JMP <A HREF="#E859">WATJOB</A>     ; AND WAIT FOR BUFFER READY

; MAIN ROUTINE TO WRITE TO CHANL

 E7FE  A5 85     <A NAME="E7FE">PUT</A>        LDA ORGSA      ; IS CHANL CMD OR DATA
 E800  29 8F                AND #$8F      
 E802  C9 0F                CMP #$0F       ; &lt;15
 E804  B0 17                BCS <A HREF="#E81D">iE81D</A>     
 E806  A6 83                LDX LINDX     
 E808  B5 B6                LDA FILTYP,X  
 E80A  49 08                EOR #$08      
 E80C  F0 05                BEQ <A HREF="#E813">iE813</A>     
 E80E  A5 87                LDA DATA       ; SEQ FILE
 E810  4C 35 EA             JMP <A HREF="#EA35">WRTBYT</A>     ; WRITE BYTE TO CHANL
 E813  A5 87     <A NAME="E813">iE813</A>      LDA DATA       ; RND FILE WRITE
 E815  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>     ; WRITE TO CHANL
 E818  A4 83                LDY LINDX      ; PREPARE NXT BYTE
 E81A  4C 2E ED             JMP <A HREF="#ED2E">RNGET2</A>    
 E81D  A9 06     <A NAME="E81D">iE81D</A>      LDA #$06       ; CMDCHN
 E81F  85 83                STA LINDX     
 E821  20 B0 EE             JSR <A HREF="#EEB0">GETPNT</A>     ; TEST IF COMM AND BUFFER FULL
 E824  C9 29                CMP #$29      
 E826  F0 05                BEQ <A HREF="#E82D">iE82D</A>      ; IT IS FULL (&gt;40)
 E828  A5 87                LDA DATA       ; NOT FULL YET
 E82A  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>     ; STORE THE BYTE
 E82D  A5 88     <A NAME="E82D">iE82D</A>      LDA EOIFLG     ; TST IF LST BYTE OF MSG
 E82F  F0 01                BEQ <A HREF="#E832">iE832</A>      ; IT IS
 E831  60                   RTS <A HREF="#E832"></A>           ; NOT YET, RETURN
 E832  A5 85     <A NAME="E832">iE832</A>      LDA ORGSA      ; this test is missing in 4040, instead directly gone to e839
 E834  10 03                BPL <A HREF="#E839">iE839</A>     
 E836  4C 7A F6             JMP <A HREF="#F67A">iF67A</A>     
 E839  E6 3A     <A NAME="E839">iE839</A>      INC CMDWAT     ; SET CMD WAITING FLAG
 E83B  60                   RTS           

; TEST IF JOB (.X) IS DONE YET
; IF NOT DONE RETURN
; IF OK THEN RETURN ELSE REDO IT

 E83C  BD 03 10  <A NAME="E83C">TSTJOB</A>     LDA JOBS,X    
 E83F  30 14                BMI <A HREF="#E855">NOTYET</A>    
 E841  F0 14                BEQ <A HREF="#E857">OK</A>        
 E843  C9 01                CMP #$01      
 E845  F0 10                BEQ <A HREF="#E857">OK</A>        
 E847  DE A8 10             DEC ERRCNT,X   ; REDO UNTIL ERRCNT=0
 E84A  10 03                BPL <A HREF="#E84F">AGAIN</A>     
 E84C  4C B3 E6             JMP <A HREF="#E6B3">ERROR</A>     
 E84F  BD 99 10  <A NAME="E84F">AGAIN</A>      LDA LSTJOB,X  
 E852  9D 03 10             STA JOBS,X    
 E855  38        <A NAME="E855">NOTYET</A>     SEC           
 E856  60                   RTS           
 E857  18        <A NAME="E857">OK</A>         CLC           
 E858  60                   RTS           

; WAIT UNTIL JOB(.X) IS DONE
; RETURN WHEN DONE

 E859  20 3C E8  <A NAME="E859">WATJOB</A>     JSR <A HREF="#E83C">TSTJOB</A>    
 E85C  B0 FB                BCS <A HREF="#E859">WATJOB</A>    
 E85E  60                   RTS <A HREF="#E859"></A>          

 E85F  A2 0E                LDX #$0E       ; this routine seems to be unused?
 E861  20 59 E8  <A NAME="E861">iE861</A>      JSR <A HREF="#E859">WATJOB</A>    
 E864  CA                   DEX <A HREF="#E859"></A>          
 E865  10 FA                BPL <A HREF="#E861">iE861</A>     
 E867  60                   RTS <A HREF="#E861"></A>          

; SET HEADER OF ACTIVE BUFFER OF THE
; CURRENT LINDX TO TRACK,SECTOR,ID

 E868  20 9D E8  <A NAME="E868">SETHDR</A>     JSR <A HREF="#E89D">GETACT</A>    
 E86B  AA        <A NAME="E86B">SETH</A>       TAX <A HREF="#E89D"></A>          
 E86C  0A                   ASL <A HREF="#E89D"></A>          
 E86D  0A                   ASL <A HREF="#E89D"></A>          
 E86E  0A                   ASL <A HREF="#E89D"></A>          
 E86F  A8                   TAY <A HREF="#E89D"></A>          
 E870  A5 81                LDA TRACK     
 E872  99 23 10             STA HDRS+2,Y   ; SEt TRACK
 E875  A5 82                LDA SECTOR    
 E877  99 24 10             STA HDRS+3,Y   ; SET SECTOR
 E87A  A5 80                LDA DRVNUM     ; GET PROPER ID(DRVNUM)
 E87C  0A                   ASL           
 E87D  AA                   TAX           
 E87E  B5 8E                LDA DISKID,X  
 E880  99 21 10             STA HDRS,Y    
 E883  B5 8F                LDA DISKID+1,X
 E885  99 22 10             STA HDRS+1,Y  
 E888  60                   RTS           

; PUT .A INTO ACTIVE BUFFER OF LINDX

 E889  48        <A NAME="E889">PUTBYT</A>     PHA            ; SAVE .A
 E88A  20 9D E8             JSR <A HREF="#E89D">GETACT</A>     ; GET ACTIVE BUF#
 E88D  10 06                BPL <A HREF="#E895">iE895</A>      ; BRANCH IF THERE IS ONE
 E88F  68                   PLA <A HREF="#E895"></A>           ; NO BUFFER ERROR
 E890  A9 61                LDA #$61       ; FILNOP
 E892  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>     ; JMP TO ERROR ROUTINE
 E895  0A        <A NAME="E895">iE895</A>      ASL <A HREF="#F090"></A>           ; SAVE THE BYTE IN BUFFER
 E896  AA                   TAX <A HREF="#F090"></A>          
 E897  68                   PLA <A HREF="#F090"></A>          
 E898  81 3D                STA (BUFTAB,X)
 E89A  F6 3D                INC BUFTAB,X   ; INC THE BUFFER POINTER
 E89C  60                   RTS            ; Z=1 IF LAST CHAR SLOT IN BUFFER

 E89D  A5 83     <A NAME="E89D">GETACT</A>     LDA LINDX     
 E89F  0A                   ASL           
 E8A0  AA                   TAX           
 E8A1  B5 5F                LDA BUFNUM,X  
 E8A3  10 02                BPL <A HREF="#E8A7">iE8A7</A>     
 E8A5  B5 60                LDA BUFNUM+1,X
 E8A7  60        <A NAME="E8A7">iE8A7</A>      RTS           

; INITIALIZE DRIVES (COMMAND)

 E8A8  20 99 F0  <A NAME="E8A8">INTDRV</A>     JSR <A HREF="#F099">SIMPRS</A>    
 E8AB  20 C1 E8             JSR <A HREF="#E8C1">INITDR</A>    
 E8AE  A5 CF                LDA IMAGE      ; USED AS FLAG FOR BOTH DRIVES
 E8B0  10 0C                BPL <A HREF="#E8BE">iE8BE</A>     
 E8B2  20 12 F2             JSR <A HREF="#F212">TOGDRV</A>    
 E8B5  20 0A EF             JSR <A HREF="#EF0A">SETLDS</A>    
 E8B8  20 C1 E8             JSR <A HREF="#E8C1">INITDR</A>    
 E8BB  20 12 F2             JSR <A HREF="#F212">TOGDRV</A>    
 E8BE  4C 75 F0  <A NAME="E8BE">iE8BE</A>      JMP <A HREF="#F075">ENDCMD</A>    

; INITIALIZE DRIVE (DRVNUM)
; in 4040 this is called INITSU

 E8C1  20 CE EB  <A NAME="E8C1">INITDR</A>     JSR <A HREF="#EBCE">CLDCHN</A>     ; missing in 4040
 E8C4  A5 80                LDA DRVNUM     ; DO A BUMP TO TRK 1
 E8C6  18                   CLC            ; READ IN BIT MAP (18.00)
 E8C7  69 0D                ADC #$0D       ; BAMJOB; AND SAVE DISK ID
 E8C9  85 8D                STA JOBNUM    
 E8CB  AA                   TAX           
 E8CC  A9 01                LDA #$01      
 E8CE  9D 12 10             STA x1012,X   
 E8D1  A5 80                LDA DRVNUM    
 E8D3  09 C0                ORA #$C0       ; SEEK
 E8D5  20 08 E9             JSR <A HREF="#E908">DOIT</A>      
 E8D8  A9 12                LDA #$12      
 E8DA  A6 8D                LDX JOBNUM    
 E8DC  9D 12 10             STA x1012,X   
 E8DF  A5 80                LDA DRVNUM    
 E8E1  09 B0                ORA #$B0       ; READ
 E8E3  20 08 E9             JSR <A HREF="#E908">DOIT</A>      
 E8E6  A5 8D                LDA JOBNUM    
 E8E8  AA                   TAX           
 E8E9  0A                   ASL           
 E8EA  0A                   ASL           
 E8EB  0A                   ASL           
 E8EC  A8                   TAY           
 E8ED  A9 00                LDA #$00      
 E8EF  99 24 10             STA HDRS+3,Y  
 E8F2  A5 80                LDA DRVNUM    
 E8F4  09 80                ORA #$80      
 E8F6  20 08 E9             JSR <A HREF="#E908">DOIT</A>      
 E8F9  A5 80                LDA DRVNUM    
 E8FB  0A                   ASL           
 E8FC  AA                   TAX           
 E8FD  B9 21 10             LDA HDRS,Y    
 E900  95 8E                STA DISKID,X  
 E902  B9 22 10             LDA HDRS+1,Y  
 E905  95 8F                STA DISKID+1,X
 E907  60                   RTS           

; DO JOB IN .A, SET UP ERROR COUNT
; AND LSTJOB. RETURN WHEN JOB DONE OK
; JMP TO ERROR IF ERROR RETURNS
; this code is vastly different from 4040

 E908  85 89     <A NAME="E908">DOIT</A>       STA CMD       
 E90A  A9 0A     <A NAME="E90A">DOIT2</A>      LDA #$0A      
 E90C  9D A8 10             STA ERRCNT,X  
 E90F  BD 12 10             LDA x1012,X   
 E912  F0 1E                BEQ <A HREF="#E932">iE932</A>     
 E914  C9 24                CMP #$24      
 E916  B0 1A                BCS <A HREF="#E932">iE932</A>     
 E918  A5 89     <A NAME="E918">iE918</A>      LDA CMD       
 E91A  9D 03 10             STA JOBS,X    
 E91D  9D 99 10             STA LSTJOB,X  
 E920  BD 03 10  <A NAME="E920">iE920</A>      LDA JOBS,X    
 E923  30 FB                BMI <A HREF="#E920">iE920</A>     
 E925  C9 01                CMP #$01      
 E927  F0 08                BEQ <A HREF="#E931">iE931</A>     
 E929  DE A8 10             DEC ERRCNT,X  
 E92C  D0 EA                BNE <A HREF="#E918">iE918</A>     
 E92E  4C B3 E6             JMP <A HREF="#E6B3">ERROR</A>     
 E931  60        <A NAME="E931">iE931</A>      RTS <A HREF="#E6B3"></A>          
 E932  85 81     <A NAME="E932">iE932</A>      STA TRACK     
 E934  8A                   TXA           
 E935  0A                   ASL           
 E936  0A                   ASL           
 E937  0A                   ASL           
 E938  AA                   TAX           
 E939  BD 24 10             LDA HDRS+3,X  
 E93C  85 82                STA SECTOR    
 E93E  A9 20                LDA #$20      
 E940  4C D4 E6             JMP <A HREF="#E6D4">CMDER2</A>    

; START DOUBLE BUFFERING
; USE TRACK,SECTOR AS STARTING BLOCK

 E943  20 9D E8  <A NAME="E943">STRDBL</A>     JSR <A HREF="#E89D">GETACT</A>    
 E946  20 68 E8             JSR <A HREF="#E868">SETHDR</A>    
 E949  20 6A E9             JSR <A HREF="#E96A">RDBUF</A>     
 E94C  20 59 E8             JSR <A HREF="#E859">WATJOB</A>    
 E94F  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 E952  85 81                STA TRACK     
 E954  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 E957  85 82                STA SECTOR    
 E959  A5 81                LDA TRACK     
 E95B  D0 01                BNE <A HREF="#E95E">iE95E</A>     
 E95D  60                   RTS <A HREF="#E95E"></A>          
 E95E  20 E3 E7  <A NAME="E95E">iE95E</A>      JSR <A HREF="#E7E3">DBLBUF</A>    
 E961  20 68 E8             JSR <A HREF="#E868">SETHDR</A>    
 E964  20 6A E9             JSR <A HREF="#E96A">RDBUF</A>     
 E967  4C E3 E7             JMP <A HREF="#E7E3">DBLBUF</A>    

; START A READ JOB ON TRACK, SECTOR

 E96A  A9 80     <A NAME="E96A">RDBUF</A>      LDA #$80       ; READ
 E96C  D0 02                BNE <A HREF="#E970">iE970</A>     

; START A WRITE JOB ON TRACK, SECTOR

 E96E  A9 90     <A NAME="E96E">WRTBUF</A>     LDA #$90       ; WRITE
 E970  85 89     <A NAME="E970">iE970</A>      STA CMD       
 E972  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 E975  AA                   TAX <A HREF="#E89D"></A>          
 E976  0A                   ASL <A HREF="#E89D"></A>          
 E977  0A                   ASL <A HREF="#E89D"></A>          
 E978  0A                   ASL <A HREF="#E89D"></A>          
 E979  A8                   TAY <A HREF="#E89D"></A>          
 E97A  B9 23 10             LDA HDRS+2,Y  
 E97D  F0 B3                BEQ <A HREF="#E932">iE932</A>     
 E97F  C9 24                CMP #$24      
 E981  B0 AF                BCS <A HREF="#E932">iE932</A>     
 E983  9D 12 10             STA x1012,X   
 E986  A9 0A                LDA #$0A      
 E988  9D A8 10             STA ERRCNT,X  
 E98B  BD 99 10             LDA LSTJOB,X  
 E98E  29 01                AND #$01      
 E990  05 89                ORA CMD       
 E992  9D 99 10             STA LSTJOB,X  
 E995  9D 03 10             STA JOBS,X    
 E998  8A                   TXA           
 E999  48                   PHA           
 E99A  0A                   ASL           
 E99B  AA                   TAX           
 E99C  A9 00                LDA #$00      
 E99E  95 3D                STA BUFTAB,X  
 E9A0  A5 83                LDA LINDX     
 E9A2  0A                   ASL           
 E9A3  AA                   TAX           
 E9A4  F6 6F                INC BUFNUM+16,X
 E9A6  D0 02                BNE <A HREF="#E9AA">iE9AA</A>     
 E9A8  F6 70                INC BUFNUM+17,X
 E9AA  68        <A NAME="E9AA">iE9AA</A>      PLA           
 E9AB  AA                   TAX           
 E9AC  60                   RTS           

 E9AD  38        <A NAME="E9AD">FNDWCH</A>     SEC           
 E9AE  B0 01                BCS <A HREF="#E9B1">iE9B1</A>     
 E9B0  18        <A NAME="E9B0">FNDRCH</A>     CLC <A HREF="#E9B1"></A>          
 E9B1  08        <A NAME="E9B1">iE9B1</A>      PHP <A HREF="#E9B1"></A>          
 E9B2  A5 84                LDA SA        
 E9B4  C9 11                CMP #$11       ; MAXSA+1
 E9B6  90 02                BCC <A HREF="#E9BA">iE9BA</A>     
 E9B8  29 0F                AND #$0F      
 E9BA  0A        <A NAME="E9BA">iE9BA</A>      ASL           
 E9BB  28                   PLP           
 E9BC  69 00                ADC #$00      
 E9BE  AA                   TAX           
 E9BF  BD B7 10             LDA LINTAB,X  
 E9C2  85 83                STA LINDX     
 E9C4  AA                   TAX           
 E9C5  C9 FF                CMP #$FF      
 E9C7  F0 01                BEQ <A HREF="#E9CA">iE9CA</A>     
 E9C9  60                   RTS <A HREF="#E9CA"></A>          
 E9CA  38        <A NAME="E9CA">iE9CA</A>      SEC <A HREF="#E9CA"></A>          
 E9CB  60                   RTS <A HREF="#E9CA"></A>          

 E9CC  20 9D E8  <A NAME="E9CC">GETPRE</A>     JSR <A HREF="#E89D">GETACT</A>    
 E9CF  0A                   ASL <A HREF="#E89D"></A>          
 E9D0  AA                   TAX <A HREF="#E89D"></A>          
 E9D1  A4 83                LDY LINDX     
 E9D3  60                   RTS           

; READ BYTE FROM ACTIVE BUFFER
; AND SET FLAG IF LAST DATA BYTE
; IF LAST THEN Z=1 ELSE Z=0

 E9D4  20 CC E9  <A NAME="E9D4">GETBYT</A>     JSR <A HREF="#E9CC">GETPRE</A>    
 E9D7  B9 C6 00             LDA LSTCHR,Y  
 E9DA  F0 12                BEQ <A HREF="#E9EE">iE9EE</A>     
 E9DC  A1 3D                LDA (BUFTAB,X)
 E9DE  48                   PHA           
 E9DF  B5 3D                LDA BUFTAB,X  
 E9E1  D9 C6 00             CMP LSTCHR,Y  
 E9E4  D0 04                BNE <A HREF="#E9EA">iE9EA</A>     
 E9E6  A9 FF                LDA #$FF      
 E9E8  95 3D                STA BUFTAB,X  
 E9EA  68        <A NAME="E9EA">iE9EA</A>      PLA           
 E9EB  F6 3D                INC BUFTAB,X  
 E9ED  60                   RTS           
 E9EE  A1 3D     <A NAME="E9EE">iE9EE</A>      LDA (BUFTAB,X)
 E9F0  F6 3D                INC BUFTAB,X  
 E9F2  60                   RTS           

; READ A CHAR FROM FILE AND READ NEXT
; BLOCK OF FILE IF NEEDED.
; SET CHNRDY=EOI IF END OF FILE

 E9F3  20 D4 E9  <A NAME="E9F3">RDBYT</A>      JSR <A HREF="#E9D4">GETBYT</A>    
 E9F6  D0 31                BNE <A HREF="#EA29">iEA29</A>     
 E9F8  85 87                STA DATA      
 E9FA  B9 C6 00             LDA LSTCHR,Y  
 E9FD  F0 08                BEQ <A HREF="#EA07">iEA07</A>     
 E9FF  A9 80                LDA #$80       ; EOIOUT
 EA01  99 BE 00             STA CHNRDY,Y  
 EA04  A5 87                LDA DATA      
 EA06  60                   RTS           
 EA07  20 E3 E7  <A NAME="EA07">iEA07</A>      JSR <A HREF="#E7E3">DBLBUF</A>    
 EA0A  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 EA0D  C9 00                CMP #$00      
 EA0F  F0 19                BEQ <A HREF="#EA2A">iEA2A</A>     
 EA11  85 81                STA TRACK     
 EA13  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 EA16  85 82                STA SECTOR    
 EA18  20 E3 E7             JSR <A HREF="#E7E3">DBLBUF</A>    
 EA1B  20 66 EA             JSR <A HREF="#EA66">SETDRN</A>    
 EA1E  20 68 E8             JSR <A HREF="#E868">SETHDR</A>    
 EA21  20 6A E9             JSR <A HREF="#E96A">RDBUF</A>     
 EA24  20 E3 E7             JSR <A HREF="#E7E3">DBLBUF</A>    
 EA27  A5 87                LDA DATA      
 EA29  60        <A NAME="EA29">iEA29</A>      RTS           
 EA2A  20 D4 E9  <A NAME="EA2A">iEA2A</A>      JSR <A HREF="#E9D4">GETBYT</A>    
 EA2D  A4 83                LDY LINDX     
 EA2F  99 C6 00             STA LSTCHR,Y  
 EA32  A5 87                LDA DATA      
 EA34  60                   RTS           

; WRITE A CHAR TO CHANL AND WRITE
; BUFFER OUT TO DISK IF ITS FULL

 EA35  20 89 E8  <A NAME="EA35">WRTBYT</A>     JSR <A HREF="#E889">PUTBYT</A>    
 EA38  F0 01                BEQ <A HREF="#EA3B">iEA3B</A>     
 EA3A  60                   RTS <A HREF="#EA3B"></A>          
 EA3B  20 66 EA  <A NAME="EA3B">iEA3B</A>      JSR <A HREF="#EA66">SETDRN</A>    
 EA3E  20 7C E4             JSR <A HREF="#E47C">NXTTS</A>     
 EA41  A5 81                LDA TRACK     
 EA43  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EA46  A5 82                LDA SECTOR    
 EA48  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EA4B  20 6E E9             JSR <A HREF="#E96E">WRTBUF</A>    
 EA4E  A9 02                LDA #$02      
 EA50  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 EA53  20 E3 E7             JSR <A HREF="#E7E3">DBLBUF</A>    
 EA56  4C 68 E8             JMP <A HREF="#E868">SETHDR</A>    

; INC POINTER OF ACTIVE BUFFER
; BY .A

 EA59  85 2A     <A NAME="EA59">INCPTR</A>     STA TEMP       ; SCOTT PATCH
 EA5B  20 B0 EE             JSR <A HREF="#EEB0">GETPNT</A>    
 EA5E  18                   CLC <A HREF="#EEB0"></A>          
 EA5F  65 2A                ADC TEMP      
 EA61  95 3D                STA BUFTAB,X  
 EA63  85 93                STA DIRBUF    
 EA65  60                   RTS           

; SET DRVNUM TO DRIVE INDICATED BY
; LSTJOB OF ACTIVE BUFFER

 EA66  20 9D E8  <A NAME="EA66">SETDRN</A>     JSR <A HREF="#E89D">GETACT</A>    
 EA69  AA                   TAX <A HREF="#E89D"></A>          
 EA6A  BD 99 10             LDA LSTJOB,X  
 EA6D  29 01                AND #$01      
 EA6F  85 80                STA DRVNUM    
 EA71  60                   RTS           

; OPEN A READ CHANL WITH 2 BUFFERS
; WILL INSERT SA IN LINTAB
; AND INITS ALL POINTERS.

 EA72  A9 02     <A NAME="EA72">OPNRCH</A>     LDA #$02       ; GET TWO DATA BUFFERS
 EA74  20 F3 EA             JSR <A HREF="#EAF3">GETRCH</A>    
 EA77  20 98 EA             JSR <A HREF="#EA98">INTPNT</A>    
 EA7A  20 43 E9             JSR <A HREF="#E943">STRDBL</A>     ; READ 1ST ONE OR TWO BLOCKS
 EA7D  A6 83                LDX LINDX     
 EA7F  A9 88                LDA #$88       ; RDYTLK
 EA81  95 BE                STA CHNRDY,X  
 EA83  A9 02                LDA #$02      
 EA85  95 B6                STA FILTYP,X  
 EA87  A5 81                LDA TRACK     
 EA89  D0 04                BNE <A HREF="#EA8F">iEA8F</A>     
 EA8B  A5 82                LDA SECTOR    
 EA8D  95 C6                STA LSTCHR,X   ; SET LAST CHAR PTR
 EA8F  20 F3 E9  <A NAME="EA8F">iEA8F</A>      JSR <A HREF="#E9F3">RDBYT</A>      ; SEQUENTIAL SET UP
 EA92  A6 83                LDX LINDX     
 EA94  9D D9 10             STA CHNDAT,X  
 EA97  60                   RTS           

; INITIALIZE VARIABLES FOR OPEN CHANL
; LSTJOB,SETS ACTIVE BUFFER#,LSTCHR,
; BUFFER POINTERS IN BUFTAB=2

 EA98  A5 83     <A NAME="EA98">INTPNT</A>     LDA LINDX     
 EA9A  0A                   ASL           
 EA9B  AA                   TAX           
 EA9C  A5 80                LDA DRVNUM    
 EA9E  B4 5F                LDY BUFNUM,X  
 EAA0  99 99 10             STA LSTJOB,Y  
 EAA3  B4 60                LDY BUFNUM+1,X
 EAA5  99 99 10             STA LSTJOB,Y  
 EAA8  99 03 10             STA JOBS,Y    
 EAAB  B5 5F                LDA BUFNUM,X  
 EAAD  0A                   ASL           
 EAAE  A8                   TAY           
 EAAF  A9 02                LDA #$02      
 EAB1  99 3D 00             STA BUFTAB,Y  
 EAB4  B5 60                LDA BUFNUM+1,X
 EAB6  09 80                ORA #$80      
 EAB8  95 60                STA BUFNUM+1,X
 EABA  0A                   ASL           
 EABB  A8                   TAY           
 EABC  A9 02                LDA #$02      
 EABE  99 3D 00             STA BUFTAB,Y  
 EAC1  A9 00                LDA #$00      
 EAC3  95 6F                STA BUFNUM+16,X
 EAC5  95 70                STA BUFNUM+17,X
 EAC7  A6 83                LDX LINDX     
 EAC9  A9 00                LDA #$00      
 EACB  95 C6                STA LSTCHR,X  
 EACD  60                   RTS           

; OPEN A WRITE CHANNEL WITH 2 BUFFERS

 EACE  20 1B E5  <A NAME="EACE">OPNWCH</A>     JSR <A HREF="#E51B">INTTS</A>      ; GET FIRST TRACK,SECTOR
 EAD1  A9 02                LDA #$02      
 EAD3  20 E6 EA             JSR <A HREF="#EAE6">GETWCH</A>    
 EAD6  A6 83                LDX LINDX     
 EAD8  A9 02                LDA #$02      
 EADA  95 B6                STA FILTYP,X  
 EADC  A9 01                LDA #$01      
 EADE  95 BE                STA CHNRDY,X  
 EAE0  20 98 EA             JSR <A HREF="#EA98">INTPNT</A>    
 EAE3  4C 68 E8             JMP <A HREF="#E868">SETHDR</A>    

; .A=#BUFFERS NEEDED
; SETS UP BUFFER # AND ALLOCATES LINDX
; for write

 EAE6  85 2A     <A NAME="EAE6">GETWCH</A>     STA TEMP       ; SAVE #BUFS NEEDED
 EAE8  20 AD E9             JSR <A HREF="#E9AD">FNDWCH</A>    
 EAEB  B0 03                BCS <A HREF="#EAF0">iEAF0</A>     
 EAED  20 66 EB             JSR <A HREF="#EB66">iEB66</A>     
 EAF0  38        <A NAME="EAF0">iEAF0</A>      SEC <A HREF="#EB66"></A>          
 EAF1  B0 0B                BCS <A HREF="#EAFE">iEAFE</A>     

; .A=#BUFFERS NEEDED
; SETS UP BUFFER # AND ALLOCATES LINDX
; for read

 EAF3  85 2A     <A NAME="EAF3">GETRCH</A>     STA TEMP       ; SAVE #BUFS NEEDED
 EAF5  20 B0 E9             JSR <A HREF="#E9B0">FNDRCH</A>    
 EAF8  B0 03                BCS <A HREF="#EAFD">iEAFD</A>     
 EAFA  20 5F EB             JSR <A HREF="#EB5F">iEB5F</A>     
 EAFD  18        <A NAME="EAFD">iEAFD</A>      CLC <A HREF="#EB5F"></A>          
 EAFE  08        <A NAME="EAFE">iEAFE</A>      PHP <A HREF="#EB5F"></A>           ; save r/w flag (.C)
 EAFF  20 F6 EB             JSR <A HREF="#EBF6">FNDLNX</A>    
 EB02  85 83                STA LINDX     
 EB04  A5 84                LDA SA        
 EB06  0A                   ASL           
 EB07  28                   PLP           
 EB08  69 00                ADC #$00      
 EB0A  AA                   TAX           
 EB0B  A5 83                LDA LINDX     
 EB0D  9D B7 10             STA LINTAB,X  
 EB10  0A        <A NAME="EB10">iEB10</A>      ASL           
 EB11  A8                   TAY           
 EB12  A9 FF                LDA #$FF      
 EB14  99 5F 00             STA BUFNUM,Y  
 EB17  99 60 00             STA BUFNUM+1,Y
 EB1A  C6 2A     <A NAME="EB1A">iEB1A</A>      DEC TEMP      
 EB1C  30 13                BMI <A HREF="#EB31">iEB31</A>     
 EB1E  20 88 EB             JSR <A HREF="#EB88">GETBUF</A>    
 EB21  10 08                BPL <A HREF="#EB2B">iEB2B</A>     
 EB23  20 6E EB             JSR <A HREF="#EB6E">RELBUF</A>    
 EB26  A9 70                LDA #$70      
 EB28  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 EB2B  99 5F 00  <A NAME="EB2B">iEB2B</A>      STA BUFNUM,Y  
 EB2E  C8                   INY           
 EB2F  D0 E9                BNE <A HREF="#EB1A">iEB1A</A>     
 EB31  60        <A NAME="EB31">iEB31</A>      RTS <A HREF="#EB1A"></A>          

; FREE CHANL ASSOCIATED WITH SA
; FREE READ AND WRITE CHANLS
; DONT FREE CHANL 15

 EB32  A5 84     <A NAME="EB32">FRECHN</A>     LDA SA        
 EB34  C9 0F                CMP #$0F      
 EB36  D0 01                BNE <A HREF="#EB39">iEB39</A>     
 EB38  60                   RTS <A HREF="#EB39"></A>          
 EB39  20 5F EB  <A NAME="EB39">iEB39</A>      JSR <A HREF="#EB5F">iEB5F</A>     
 EB3C  4C 66 EB             JMP <A HREF="#EB66">iEB66</A>     

 EB3F  BD B7 10  <A NAME="EB3F">iEB3F</A>      LDA LINTAB,X  
 EB42  C9 FF                CMP #$FF      
 EB44  F0 18                BEQ <A HREF="#EB5E">iEB5E</A>     
 EB46  85 83                STA LINDX     
 EB48  A9 FF                LDA #$FF      
 EB4A  9D B7 10             STA LINTAB,X  
 EB4D  20 6E EB             JSR <A HREF="#EB6E">RELBUF</A>    
 EB50  A6 83                LDX LINDX     
 EB52  A9 01                LDA #$01      
 EB54  CA        <A NAME="EB54">iEB54</A>      DEX           
 EB55  30 03                BMI <A HREF="#EB5A">iEB5A</A>     
 EB57  0A                   ASL <A HREF="#EB5A"></A>          
 EB58  D0 FA                BNE <A HREF="#EB54">iEB54</A>     
 EB5A  05 3C     <A NAME="EB5A">iEB5A</A>      ORA LINUSE    
 EB5C  85 3C                STA LINUSE    
 EB5E  60        <A NAME="EB5E">iEB5E</A>      RTS           

 EB5F  A5 84     <A NAME="EB5F">iEB5F</A>      LDA SA        
 EB61  0A                   ASL           
 EB62  AA                   TAX           
 EB63  4C 3F EB             JMP <A HREF="#EB3F">iEB3F</A>     

 EB66  A5 84     <A NAME="EB66">iEB66</A>      LDA SA        
 EB68  0A                   ASL           
 EB69  AA                   TAX           
 EB6A  E8                   INX           
 EB6B  4C 3F EB             JMP <A HREF="#EB3F">iEB3F</A>     

; GIVEN SA, FREE ITS READ CHANL
; RELEASE BUFFERS (LINDX)

 EB6E  A5 83     <A NAME="EB6E">RELBUF</A>     LDA LINDX     
 EB70  0A                   ASL           
 EB71  AA                   TAX           
 EB72  B5 5F                LDA BUFNUM,X  
 EB74  C9 FF                CMP #$FF      
 EB76  F0 03                BEQ <A HREF="#EB7B">iEB7B</A>     
 EB78  20 B0 EB             JSR <A HREF="#EBB0">FREBUF</A>    
 EB7B  A5 83     <A NAME="EB7B">iEB7B</A>      LDA LINDX     
 EB7D  0A                   ASL           
 EB7E  AA                   TAX           
 EB7F  B5 60                LDA BUFNUM+1,X
 EB81  C9 FF                CMP #$FF      
 EB83  F0 D9                BEQ <A HREF="#EB5E">iEB5E</A>     
 EB85  4C B0 EB             JMP <A HREF="#EBB0">FREBUF</A>    

; GET A FREE BUFFER #

 EB88  A9 FF     <A NAME="EB88">GETBUF</A>     LDA #$FF      
 EB8A  85 2B                STA TEMP+1    
 EB8C  A2 0F                LDX #$0F      
 EB8E  26 8B     <A NAME="EB8E">iEB8E</A>      ROL BUFUSE    
 EB90  26 8C                ROL BUFUSE+1  
 EB92  B0 05                BCS <A HREF="#EB99">iEB99</A>     
 EB94  86 2B                STX TEMP+1    
 EB96  38                   SEC           
 EB97  B0 0E                BCS <A HREF="#EBA7">iEBA7</A>     
 EB99  CA        <A NAME="EB99">iEB99</A>      DEX <A HREF="#EBA7"></A>          
 EB9A  10 F2                BPL <A HREF="#EB8E">iEB8E</A>     
 EB9C  A6 2B     <A NAME="EB9C">iEB9C</A>      LDX TEMP+1    
 EB9E  30 05                BMI <A HREF="#EBA5">iEBA5</A>     
 EBA0  A9 00                LDA #$00      
 EBA2  9D 03 10             STA JOBS,X    
 EBA5  8A        <A NAME="EBA5">iEBA5</A>      TXA           
 EBA6  60                   RTS           
 EBA7  26 8B     <A NAME="EBA7">iEBA7</A>      ROL BUFUSE    
 EBA9  26 8C                ROL BUFUSE+1  
 EBAB  CA                   DEX           
 EBAC  10 F9                BPL <A HREF="#EBA7">iEBA7</A>     
 EBAE  30 EC                BMI <A HREF="#EB9C">iEB9C</A>     

; ALLOCATE

 EBB0  29 0F     <A NAME="EBB0">FREBUF</A>     AND #$0F      
 EBB2  A8                   TAY           
 EBB3  C8                   INY           
 EBB4  A2 10                LDX #$10      
 EBB6  66 8C     <A NAME="EBB6">iEBB6</A>      ROR BUFUSE+1  
 EBB8  66 8B                ROR BUFUSE    
 EBBA  88                   DEY           
 EBBB  D0 01                BNE <A HREF="#EBBE">iEBBE</A>     
 EBBD  18                   CLC <A HREF="#EBBE"></A>          
 EBBE  CA        <A NAME="EBBE">iEBBE</A>      DEX <A HREF="#EBBE"></A>          
 EBBF  10 F5                BPL <A HREF="#EBB6">iEBB6</A>     
 EBC1  60                   RTS <A HREF="#EBB6"></A>          

 EBC2  A9 0E     <A NAME="EBC2">CLRCHN</A>     LDA #$0E      
 EBC4  85 84                STA SA        
 EBC6  20 32 EB  <A NAME="EBC6">iEBC6</A>      JSR <A HREF="#EB32">FRECHN</A>    
 EBC9  C6 84                DEC SA        
 EBCB  D0 F9                BNE <A HREF="#EBC6">iEBC6</A>     
 EBCD  60                   RTS <A HREF="#EBC6"></A>          

 EBCE  A9 1D     <A NAME="EBCE">CLDCHN</A>     LDA #$1D      
 EBD0  85 2D                STA TEMP+3    
 EBD2  A6 2D     <A NAME="EBD2">iEBD2</A>      LDX TEMP+3    
 EBD4  BD B7 10             LDA LINTAB,X  
 EBD7  C9 FF                CMP #$FF      
 EBD9  F0 16                BEQ <A HREF="#EBF1">iEBF1</A>     
 EBDB  85 83                STA LINDX     
 EBDD  8A                   TXA           
 EBDE  4A                   LSR           
 EBDF  85 84                STA SA        
 EBE1  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EBE4  AA                   TAX <A HREF="#E89D"></A>          
 EBE5  BD 99 10             LDA LSTJOB,X  
 EBE8  29 01                AND #$01      
 EBEA  C5 80                CMP DRVNUM    
 EBEC  D0 03                BNE <A HREF="#EBF1">iEBF1</A>     
 EBEE  20 32 EB             JSR <A HREF="#EB32">FRECHN</A>    
 EBF1  C6 2D     <A NAME="EBF1">iEBF1</A>      DEC TEMP+3    
 EBF3  10 DD                BPL <A HREF="#EBD2">iEBD2</A>     
 EBF5  60                   RTS <A HREF="#EBD2"></A>          

; FIND A FREE LINDX TO USE
; MARK AS USED IN LINUSE

 EBF6  A0 00     <A NAME="EBF6">FNDLNX</A>     LDY #$00      
 EBF8  A9 01                LDA #$01      
 EBFA  24 3C     <A NAME="EBFA">iEBFA</A>      BIT LINUSE     ; 1=FREE 0=USED
 EBFC  D0 09                BNE <A HREF="#EC07">iEC07</A>     
 EBFE  C8                   INY <A HREF="#EC07"></A>          
 EBFF  0A                   ASL <A HREF="#EC07"></A>          
 EC00  D0 F8                BNE <A HREF="#EBFA">iEBFA</A>     
 EC02  A9 70                LDA #$70       ; NOCHNL; NO FREE LINDX AVAILABLE
 EC04  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 EC07  49 FF     <A NAME="EC07">iEC07</A>      EOR #$FF       ; TOGGLE BIT MASK
 EC09  25 3C                AND LINUSE     ; MARK BIT USED
 EC0B  85 3C                STA LINUSE    
 EC0D  98                   TYA            ; RETURN LINDX IN .A
 EC0E  60                   RTS           

; CLOSE THE FILE ASSOCIATED WITH SA
; this routine is massively different, partly due to REL files in 4040

 EC0F  A5 84     <A NAME="EC0F">CLOSE</A>      LDA SA        
 EC11  F0 3D                BEQ <A HREF="#EC50">iEC50</A>      ; DIRECTORY CLOSE
 EC13  C9 0F                CMP #$0F      
 EC15  F0 1B                BEQ <A HREF="#EC32">CLSALL</A>     ; CLOSE CMD CHANL
 EC17  20 AD E9             JSR <A HREF="#E9AD">FNDWCH</A>    
 EC1A  B0 13                BCS <A HREF="#EC2F">iEC2F</A>     
 EC1C  A6 83                LDX LINDX     
 EC1E  B5 B6                LDA FILTYP,X  
 EC20  29 0E                AND #$0E      
 EC22  C9 08                CMP #$08      
 EC24  F0 06                BEQ <A HREF="#EC2C">iEC2C</A>     
 EC26  20 5E EC             JSR <A HREF="#EC5E">iEC5E</A>     
 EC29  20 53 ED             JSR <A HREF="#ED53">iED53</A>     
 EC2C  20 87 EC  <A NAME="EC2C">iEC2C</A>      JSR <A HREF="#EC87">MAPOUT</A>    
 EC2F  4C 32 EB  <A NAME="EC2F">iEC2F</A>      JMP <A HREF="#EB32">FRECHN</A>    
 EC32  A9 00     <A NAME="EC32">CLSALL</A>     LDA #$00      
 EC34  85 84                STA SA        
 EC36  20 AD E9  <A NAME="EC36">iEC36</A>      JSR <A HREF="#E9AD">FNDWCH</A>    
 EC39  B0 09                BCS <A HREF="#EC44">iEC44</A>     
 EC3B  20 5E EC             JSR <A HREF="#EC5E">iEC5E</A>     
 EC3E  20 53 ED             JSR <A HREF="#ED53">iED53</A>     
 EC41  20 87 EC             JSR <A HREF="#EC87">MAPOUT</A>    
 EC44  20 32 EB  <A NAME="EC44">iEC44</A>      JSR <A HREF="#EB32">FRECHN</A>    
 EC47  E6 84                INC SA        
 EC49  A5 84                LDA SA        
 EC4B  C9 0F                CMP #$0F      
 EC4D  D0 E7                BNE <A HREF="#EC36">iEC36</A>     
 EC4F  60                   RTS <A HREF="#EC36"></A>          
 EC50  A9 00     <A NAME="EC50">iEC50</A>      LDA #$00      
 EC52  85 38                STA DIRLST     ; CLEAR DIR LIST
 EC54  20 32 EB             JSR <A HREF="#EB32">FRECHN</A>    
 EC57  A9 10                LDA #$10       ; in 4040 JMP FREICH
 EC59  85 84                STA SA        
 EC5B  4C 32 EB             JMP <A HREF="#EB32">FRECHN</A>    

 EC5E  20 B0 EE  <A NAME="EC5E">iEC5E</A>      JSR <A HREF="#EEB0">GETPNT</A>    
 EC61  C9 02                CMP #$02      
 EC63  D0 07                BNE <A HREF="#EC6C">iEC6C</A>     
 EC65  A9 0D                LDA #$0D      
 EC67  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EC6A  A9 03                LDA #$03      
 EC6C  85 2A     <A NAME="EC6C">iEC6C</A>      STA TEMP      
 EC6E  C6 2A                DEC TEMP      
 EC70  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EC73  0A                   ASL <A HREF="#E89D"></A>          
 EC74  AA                   TAX <A HREF="#E89D"></A>          
 EC75  A9 00                LDA #$00      
 EC77  95 3D                STA BUFTAB,X  
 EC79  81 3D                STA (BUFTAB,X)
 EC7B  F6 3D                INC BUFTAB,X  
 EC7D  A5 2A                LDA TEMP      
 EC7F  81 3D                STA (BUFTAB,X)
 EC81  20 6E E9             JSR <A HREF="#E96E">WRTBUF</A>    
 EC84  4C 59 E8             JMP <A HREF="#E859">WATJOB</A>    

; WRITE OUT THE BIT MAP TO
; THE DRIVE IN LSTJOB(ACTIVE)

 EC87  20 9D E8  <A NAME="EC87">MAPOUT</A>     JSR <A HREF="#E89D">GETACT</A>    
 EC8A  AA                   TAX <A HREF="#E89D"></A>          
 EC8B  BD 99 10             LDA LSTJOB,X  
 EC8E  29 01                AND #$01      
 EC90  48                   PHA            ; CHECK BAM BEFORE WRITING
 EC91  AA                   TAX           
 EC92  A9 00                LDA #$00      
 EC94  85 82                STA SECTOR    
 EC96  BD 40 E5             LDA <A HREF="#E540">IPBM,X</A>    
 EC99  85 2F                STA TEMP+5    
 EC9B  A9 00                LDA #$00      
 EC9D  85 2E                STA TEMP+4    
 EC9F  A9 01                LDA #$01      
 ECA1  85 81                STA TRACK     

; VERIFY THE BAM BLOCK COUNT
; MATCHES THE BITS

 ECA3  A5 81     <A NAME="ECA3">MAPCHK</A>     LDA TRACK     
 ECA5  0A                   ASL           
 ECA6  0A                   ASL           
 ECA7  A8                   TAY           
 ECA8  B1 2E                LDA (TEMP+4),Y
 ECAA  85 2D                STA TEMP+3    
 ECAC  C8                   INY           
 ECAD  B1 2E                LDA (TEMP+4),Y
 ECAF  85 2A                STA TEMP      
 ECB1  C8                   INY           
 ECB2  B1 2E                LDA (TEMP+4),Y
 ECB4  85 2B                STA TEMP+1    
 ECB6  C8                   INY           
 ECB7  B1 2E                LDA (TEMP+4),Y
 ECB9  85 2C                STA TEMP+2    
 ECBB  20 93 E5             JSR <A HREF="#E593">AVCK</A>      
 ECBE  E6 81                INC TRACK     
 ECC0  A5 81                LDA TRACK     
 ECC2  C9 24                CMP #$24       ; MAXTRK
 ECC4  D0 DD                BNE <A HREF="#ECA3">MAPCHK</A>    
 ECC6  A9 12                LDA #$12      
 ECC8  85 81                STA TRACK     
 ECCA  68                   PLA           
 ECCB  A8                   TAY           
 ECCC  18                   CLC           
 ECCD  69 0D                ADC #$0D       ; BAMJOB
 ECCF  AA                   TAX           
 ECD0  98                   TYA           
 ECD1  09 90                ORA #$90       ; WRITE
 ECD3  4C 08 E9             JMP <A HREF="#E908">DOIT</A>      

; GET NEXT CHAR FROM A CHANL

 ECD6  A6 83     <A NAME="ECD6">GET</A>        LDX LINDX     
 ECD8  B5 BE                LDA CHNRDY,X  
 ECDA  29 08                AND #$08      
 ECDC  D0 13                BNE <A HREF="#ECF1">iECF1</A>     
 ECDE  B5 B6                LDA FILTYP,X  
 ECE0  49 08                EOR #$08      
 ECE2  4A                   LSR           
 ECE3  D0 07                BNE <A HREF="#ECEC">iECEC</A>     
 ECE5  A9 89                LDA #$89      
 ECE7  95 BE                STA CHNRDY,X  
 ECE9  4C 1A ED             JMP <A HREF="#ED1A">iED1A</A>     
 ECEC  A9 00     <A NAME="ECEC">iECEC</A>      LDA #$00      
 ECEE  95 BE                STA CHNRDY,X  
 ECF0  60                   RTS           
 ECF1  A5 84     <A NAME="ECF1">iECF1</A>      LDA SA        
 ECF3  F0 54                BEQ <A HREF="#ED49">iED49</A>     
 ECF5  C9 0F                CMP #$0F      
 ECF7  D0 19                BNE <A HREF="#ED12">iED12</A>     
 ECF9  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 ECFC  D0 45                BNE <A HREF="#ED43">GET3</A>      
 ECFE  85 87                STA DATA      
 ED00  A9 B4                LDA #$B4      
 ED02  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 ED05  AD 82 02             LDA RIOT2PBD  
 ED08  29 DF                AND #$DF      
 ED0A  8D 82 02             STA RIOT2PBD  
 ED0D  A5 87                LDA DATA      
 ED0F  4C 43 ED             JMP <A HREF="#ED43">GET3</A>      
 ED12  A6 83     <A NAME="ED12">iED12</A>      LDX LINDX     
 ED14  B5 B6                LDA FILTYP,X  
 ED16  49 08                EOR #$08      
 ED18  D0 26                BNE <A HREF="#ED40">SEQGET</A>    
 ED1A  20 9D E8  <A NAME="ED1A">iED1A</A>      JSR <A HREF="#E89D">GETACT</A>    
 ED1D  0A                   ASL <A HREF="#E89D"></A>          
 ED1E  AA                   TAX <A HREF="#E89D"></A>          
 ED1F  A4 83                LDY LINDX     
 ED21  B5 3D                LDA BUFTAB,X  
 ED23  D9 C6 00             CMP LSTCHR,Y   ; UP TO LST CHAR YET
 ED26  D0 04                BNE <A HREF="#ED2C">RNGET1</A>     ; NOT YET
 ED28  A9 00                LDA #$00       ; READ THE WHOLE THING
 ED2A  95 3D                STA BUFTAB,X   ; WRAP PNTR TO 0
 ED2C  F6 3D     <A NAME="ED2C">RNGET1</A>     INC BUFTAB,X   ; GET THE NEXT CHAR
 ED2E  A1 3D     <A NAME="ED2E">RNGET2</A>     LDA (BUFTAB,X)
 ED30  99 D9 10             STA CHNDAT,Y   ; SAVE CHAR IN
 ED33  B5 3D                LDA BUFTAB,X  
 ED35  D9 C6 00             CMP LSTCHR,Y  
 ED38  D0 05                BNE <A HREF="#ED3F">RNGET3</A>    
 ED3A  A9 81                LDA #$81       ; RNDEOI
 ED3C  99 BE 00             STA CHNRDY,Y   ; THIS IS LAST CHAR
 ED3F  60        <A NAME="ED3F">RNGET3</A>     RTS            ; SEND EOI WITH IT
 ED40  20 F3 E9  <A NAME="ED40">SEQGET</A>     JSR <A HREF="#E9F3">RDBYT</A>      ; READ THE NEXT BYTE
 ED43  A6 83     <A NAME="ED43">GET3</A>       LDX LINDX     
 ED45  9D D9 10             STA CHNDAT,X   ; STORE IN CHNDAT
 ED48  60                   RTS           
 ED49  A5 38     <A NAME="ED49">iED49</A>      LDA DIRLST    
 ED4B  F0 C5                BEQ <A HREF="#ED12">iED12</A>     
 ED4D  20 F0 EF             JSR <A HREF="#EFF0">GETDIR</A>    
 ED50  4C 43 ED             JMP <A HREF="#ED43">GET3</A>      

 ED53  A6 83     <A NAME="ED53">iED53</A>      LDX LINDX     
 ED55  8E EB 10             STX x10EB     
 ED58  A5 84                LDA SA        
 ED5A  48                   PHA           
 ED5B  BD E1 10             LDA CHNDAT+8,X
 ED5E  48                   PHA           
 ED5F  29 1F                AND #$1F      
 ED61  85 82                STA SECTOR    
 ED63  68                   PLA           
 ED64  29 E0                AND #$E0      
 ED66  09 02                ORA #$02      
 ED68  85 D8                STA INDEX     
 ED6A  B5 B6                LDA FILTYP,X  
 ED6C  29 01                AND #$01      
 ED6E  85 80                STA DRVNUM    
 ED70  A9 12                LDA #$12      
 ED72  85 81                STA TRACK     
 ED74  20 88 EB             JSR <A HREF="#EB88">GETBUF</A>    
 ED77  48                   PHA <A HREF="#EB88"></A>          
 ED78  85 8D                STA JOBNUM    
 ED7A  20 1D EE             JSR <A HREF="#EE1D">DRTRD</A>     
 ED7D  A0 00                LDY #$00      
 ED7F  BD CE EE             LDA <A HREF="#EECE">BUFIND,X</A>  
 ED82  85 9C                STA F2PTR     
 ED84  A5 D8                LDA INDEX     
 ED86  85 9B                STA F1PTR     
 ED88  B1 9B                LDA (F1PTR),Y 
 ED8A  10 25                BPL <A HREF="#EDB1">iEDB1</A>     
 ED8C  29 8F                AND #$8F      
 ED8E  91 9B                STA (F1PTR),Y 
 ED90  C8                   INY           
 ED91  B1 9B                LDA (F1PTR),Y 
 ED93  85 81                STA TRACK     
 ED95  84 2C                STY TEMP+2    
 ED97  A0 1B                LDY #$1B      
 ED99  B1 9B                LDA (F1PTR),Y 
 ED9B  48                   PHA           
 ED9C  88                   DEY           
 ED9D  B1 9B                LDA (F1PTR),Y 
 ED9F  A4 2C                LDY TEMP+2    
 EDA1  91 9B                STA (F1PTR),Y 
 EDA3  C8                   INY           
 EDA4  B1 9B                LDA (F1PTR),Y 
 EDA6  85 82                STA SECTOR    
 EDA8  68                   PLA           
 EDA9  91 9B                STA (F1PTR),Y 
 EDAB  20 B6 F9             JSR <A HREF="#F9B6">DELFIL</A>    
 EDAE  4C B5 ED             JMP <A HREF="#EDB5">iEDB5</A>     
 EDB1  09 80     <A NAME="EDB1">iEDB1</A>      ORA #$80      
 EDB3  91 9B                STA (F1PTR),Y 
 EDB5  AD EB 10  <A NAME="EDB5">iEDB5</A>      LDA x10EB     
 EDB8  0A                   ASL           
 EDB9  AA                   TAX           
 EDBA  A0 1C                LDY #$1C      
 EDBC  B5 6F                LDA BUFNUM+16,X
 EDBE  91 9B                STA (F1PTR),Y 
 EDC0  C8                   INY           
 EDC1  B5 70                LDA BUFNUM+17,X
 EDC3  91 9B                STA (F1PTR),Y 
 EDC5  68                   PLA           
 EDC6  AA                   TAX           
 EDC7  A9 90                LDA #$90      
 EDC9  05 80                ORA DRVNUM    
 EDCB  20 08 E9             JSR <A HREF="#E908">DOIT</A>      
 EDCE  8A                   TXA <A HREF="#E908"></A>          
 EDCF  20 B0 EB             JSR <A HREF="#EBB0">FREBUF</A>    
 EDD2  68                   PLA <A HREF="#EBB0"></A>          
 EDD3  85 84                STA SA        
 EDD5  60                   RTS           

; INITIALIZE BUFFER PNTR TABLE
; this function is much longer in 4040

 EDD6  A2 00     <A NAME="EDD6">INTTAB</A>     LDX #$00      
 EDD8  A0 00                LDY #$00      
 EDDA  A9 00     <A NAME="EDDA">iEDDA</A>      LDA #$00      
 EDDC  95 3D                STA BUFTAB,X  
 EDDE  E8                   INX           
 EDDF  B9 CE EE             LDA <A HREF="#EECE">BUFIND,Y</A>  
 EDE2  95 3D                STA BUFTAB,X  
 EDE4  E8                   INX           
 EDE5  C8                   INY           
 EDE6  C9 43                CMP #$43      
 EDE8  D0 F0                BNE <A HREF="#EDDA">iEDDA</A>     
 EDEA  A9 B4                LDA #$B4      
 EDEC  85 5D                STA x5D       
 EDEE  A9 43                LDA #$43      
 EDF0  85 5E                STA x5E       
 EDF2  60                   RTS           

; READ NEXT BUFFER OF A FILE
; FOLLOW LINKS IN FIRST TWO BYTES
; END OF FILE IF 1ST BYTE=0
; 2ND CHAR LENGTH

 EDF3  20 9D E8  <A NAME="EDF3">NXTBUF</A>     JSR <A HREF="#E89D">GETACT</A>    
 EDF6  0A                   ASL <A HREF="#E89D"></A>          
 EDF7  AA                   TAX <A HREF="#E89D"></A>          
 EDF8  A9 00                LDA #$00      
 EDFA  95 3D                STA BUFTAB,X  
 EDFC  A1 3D                LDA (BUFTAB,X)
 EDFE  F0 05                BEQ <A HREF="#EE05">iEE05</A>     
 EE00  D6 3D                DEC BUFTAB,X  
 EE02  4C F3 E9             JMP <A HREF="#E9F3">RDBYT</A>     
 EE05  60        <A NAME="EE05">iEE05</A>      RTS <A HREF="#E9F3"></A>          

; READ TRACK, SECTOR FROM HEADER

 EE06  20 B0 E9  <A NAME="EE06">CURBLK</A>     JSR <A HREF="#E9B0">FNDRCH</A>    
 EE09  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EE0C  85 8D                STA JOBNUM    
 EE0E  0A                   ASL           
 EE0F  0A                   ASL           
 EE10  0A                   ASL           
 EE11  AA                   TAX           
 EE12  BD 24 10             LDA HDRS+3,X  
 EE15  85 82                STA SECTOR    
 EE17  BD 23 10             LDA HDRS+2,X  
 EE1A  85 81                STA TRACK     
 EE1C  60                   RTS           

; DIRECT BLOCK READ

 EE1D  A9 80     <A NAME="EE1D">DRTRD</A>      LDA #$80       ; READ
 EE1F  D0 02                BNE <A HREF="#EE23">iEE23</A>     

; DIRECT BLOCK WRITE

 EE21  A9 90     <A NAME="EE21">DRTWRT</A>     LDA #$90       ; WRITE
 EE23  05 80     <A NAME="EE23">iEE23</A>      ORA DRVNUM    
 EE25  85 89                STA CMD       
 EE27  A5 8D                LDA JOBNUM    
 EE29  20 6B E8             JSR <A HREF="#E86B">SETH</A>      
 EE2C  A6 8D                LDX JOBNUM    
 EE2E  A5 81                LDA TRACK     
 EE30  9D 12 10             STA x1012,X   
 EE33  4C 0A E9             JMP <A HREF="#E90A">DOIT2</A>     

; OPEN INTERNAL READ CHANL (SA=16)

 EE36  A9 10     <A NAME="EE36">OPNIRD</A>     LDA #$10       ; IRSA
 EE38  85 84                STA SA        
 EE3A  20 72 EA             JSR <A HREF="#EA72">OPNRCH</A>    
 EE3D  A9 02                LDA #$02      
 EE3F  4C 89 EE             JMP <A HREF="#EE89">SETPNT</A>    

; OPEN INTERNAL WRITE CHANL (SA=16)

 EE42  A9 10     <A NAME="EE42">iEE42</A>      LDA #$10      
 EE44  85 84                STA SA        
 EE46  4C CE EA             JMP <A HREF="#EACE">OPNWCH</A>    

; ALLOCATE NEXT DIRECTORY BLOCK ON 18
; AND MARK AS USED IN BAM

 EE49  20 06 EE  <A NAME="EE49">NXDRBK</A>     JSR <A HREF="#EE06">CURBLK</A>    
 EE4C  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EE4F  85 3B                STA x3B       
 EE51  A9 01                LDA #$01      
 EE53  85 2A                STA TEMP      
 EE55  A5 92                LDA SECINC    
 EE57  48                   PHA           
 EE58  A9 03                LDA #$03       ; INCR SECTOR BY 3 IN DIRECTORY
 EE5A  85 92                STA SECINC    
 EE5C  20 91 E4             JSR <A HREF="#E491">NXTDS</A>     
 EE5F  68                   PLA <A HREF="#E491"></A>          
 EE60  85 92                STA SECINC    
 EE62  A9 00                LDA #$00      
 EE64  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 EE67  A5 81                LDA TRACK     
 EE69  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EE6C  A5 82                LDA SECTOR    
 EE6E  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EE71  20 6E E9             JSR <A HREF="#E96E">WRTBUF</A>    
 EE74  20 59 E8             JSR <A HREF="#E859">WATJOB</A>    
 EE77  A9 00                LDA #$00      
 EE79  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 EE7C  20 89 E8  <A NAME="EE7C">iEE7C</A>      JSR <A HREF="#E889">PUTBYT</A>    
 EE7F  D0 FB                BNE <A HREF="#EE7C">iEE7C</A>     
 EE81  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EE84  A9 FF                LDA #$FF      
 EE86  4C 89 E8             JMP <A HREF="#E889">PUTBYT</A>    

; .A=NEW PNTR VALUE

 EE89  85 2A     <A NAME="EE89">SETPNT</A>     STA TEMP      
 EE8B  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EE8E  0A                   ASL <A HREF="#E89D"></A>          
 EE8F  AA                   TAX <A HREF="#E89D"></A>          
 EE90  B5 3E                LDA BUFTAB+1,X
 EE92  85 94                STA DIRBUF+1  
 EE94  A5 2A                LDA TEMP      
 EE96  95 3D                STA BUFTAB,X  
 EE98  85 93                STA DIRBUF    
 EE9A  60                   RTS           

 EE9B  85 2A                STA TEMP      
 EE9D  A9 07                LDA #$07      
 EE9F  85 83                STA LINDX     
 EEA1  20 6E EB             JSR <A HREF="#EB6E">RELBUF</A>    
 EEA4  A5 83                LDA LINDX     
 EEA6  4C 10 EB             JMP <A HREF="#EB10">iEB10</A>     

; FREE THE INTERNAL CHANL (SA=16)

 EEA9  A9 10     <A NAME="EEA9">FREICH</A>     LDA #$10       ; in the 4040 there are two calls to FRECHN, with .A as #IRSA and #IWSA
 EEAB  85 84                STA SA        
 EEAD  4C 32 EB             JMP <A HREF="#EB32">FRECHN</A>    

; READ THE ACTIVE BUFFER POINTER

 EEB0  20 9D E8  <A NAME="EEB0">GETPNT</A>     JSR <A HREF="#E89D">GETACT</A>    
 EEB3  0A                   ASL <A HREF="#E89D"></A>          
 EEB4  AA                   TAX <A HREF="#E89D"></A>          
 EEB5  B5 3E                LDA BUFTAB+1,X
 EEB7  85 94                STA DIRBUF+1  
 EEB9  B5 3D                LDA BUFTAB,X  
 EEBB  85 93                STA DIRBUF    
 EEBD  60                   RTS           

; DIRECT READ BYTE, .A=BYTE# TO READ

 EEBE  85 2C     <A NAME="EEBE">DRDBYT</A>     STA TEMP+2    
 EEC0  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EEC3  AA                   TAX <A HREF="#E89D"></A>          
 EEC4  BD CE EE             LDA <A HREF="#EECE">BUFIND,X</A>  
 EEC7  85 2D                STA TEMP+3    
 EEC9  A0 00                LDY #$00      
 EECB  B1 2C                LDA (TEMP+2),Y
 EECD  60                   RTS           

; INDEX TABLE CONTAINING HIGH 
; BYTE ADRESS OF BUFFERS

 EECE  <A NAME="EECE">BUFIND</A>     .byte $11, $12, $13, $20, $21, $22, $23, $30  ;qrs !"#0
 EED6             .byte $31, $32, $33, $40, $41, $42, $43       ;123@abc


; POINT BMPNT AT BAM


; MARK A TRACK, SECTOR AS FREE IN BAM


 EEDD  20 5F E5  <A NAME="EEDD">FRETS</A>      JSR <A HREF="#E55F">SETBMP</A>     ; POINT BMPNT AT BAM
 EEE0  A5 81                LDA TRACK      ; CALC INDEX INTO BAM - in 4040 done in subrouting FREUSE
 EEE2  0A                   ASL           
 EEE3  0A                   ASL           
 EEE4  85 2A                STA TEMP      
 EEE6  A8                   TAY           
 EEE7  B1 28                LDA (BMPNT),Y 
 EEE9  AA                   TAX           
 EEEA  E8                   INX           
 EEEB  8A                   TXA           
 EEEC  91 28                STA (BMPNT),Y 
 EEEE  A5 82                LDA SECTOR    
 EEF0  4A                   LSR           
 EEF1  4A                   LSR           
 EEF2  4A                   LSR           
 EEF3  18                   CLC           
 EEF4  65 2A                ADC TEMP      
 EEF6  A8                   TAY           
 EEF7  C8                   INY           
 EEF8  A5 82                LDA SECTOR    
 EEFA  29 07                AND #$07      
 EEFC  AA                   TAX           
 EEFD  A9 01                LDA #$01      
 EEFF  CA        <A NAME="EEFF">iEEFF</A>      DEX           
 EF00  30 03                BMI <A HREF="#EF05">iEF05</A>     
 EF02  0A                   ASL <A HREF="#EF05"></A>          
 EF03  90 FA                BCC <A HREF="#EEFF">iEEFF</A>     
 EF05  11 28     <A NAME="EF05">iEF05</A>      ORA (BMPNT),Y  ; free it
 EF07  91 28                STA (BMPNT),Y 
 EF09  60                   RTS           

; TURN ON ACTIVITY LED SPECIFIED
; BY DRVNUM

 EF0A  A9 E7     <A NAME="EF0A">SETLDS</A>     LDA #$E7       ; clear both LEDs
 EF0C  2D 82 02             AND RIOT2PBD  
 EF0F  8D 82 02             STA RIOT2PBD   ; the 4040 does not store it back, but puts it on stack. Avoiding possible IO side effects
 EF12  A5 80                LDA DRVNUM    
 EF14  F0 09                BEQ <A HREF="#EF1F">iEF1F</A>     
 EF16  A9 08                LDA #$08       ; LED1
 EF18  0D 82 02             ORA RIOT2PBD  
 EF1B  8D 82 02             STA RIOT2PBD  
 EF1E  60                   RTS           
 EF1F  A9 10     <A NAME="EF1F">iEF1F</A>      LDA #$10       ; LED0
 EF21  0D 82 02             ORA RIOT2PBD  
 EF24  8D 82 02             STA RIOT2PBD  
 EF27  60                   RTS           

; START THE DIRECTORY LOADING FUNCTION
; GET THE BUFFER AND GET IT STARTED

 EF28  A9 00     <A NAME="EF28">iEF28</A>      LDA #$00      
 EF2A  85 84                STA SA        
 EF2C  A9 01                LDA #$01       ; ALLOCATE CHANL AND 1 BUFFER
 EF2E  20 F3 EA             JSR <A HREF="#EAF3">GETRCH</A>    
 EF31  A9 00                LDA #$00      
 EF33  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 EF36  A6 83                LDX LINDX     
 EF38  A9 00                LDA #$00      
 EF3A  95 C6                STA LSTCHR,X  
 EF3C  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EF3F  AA                   TAX <A HREF="#E89D"></A>          
 EF40  A5 80                LDA DRVNUM    
 EF42  9D 99 10             STA LSTJOB,X  
 EF45  A9 00                LDA #$00      
 EF47  95 3D                STA BUFTAB,X  
 EF49  A9 01                LDA #$01       ; PUT SAL IN BUFFER
 EF4B  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF4E  A9 04                LDA #$04       ; PUT SAH IN BUFFER
 EF50  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF53  A9 01                LDA #$01       ; INSERT FHONEY LINKS (0101)
 EF55  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF58  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF5B  A5 80                LDA DRVNUM     ; the 4040 reads NBTEMP here
 EF5D  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>     ; PUT IN DRVNUM
 EF60  A9 00                LDA #$00      
 EF62  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF65  20 E2 EF             JSR <A HREF="#EFE2">MOVBUF</A>     ; GET DISK NAME
 EF68  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EF6B  0A                   ASL <A HREF="#E89D"></A>          
 EF6C  AA                   TAX <A HREF="#E89D"></A>          
 EF6D  D6 3D                DEC BUFTAB,X  
 EF6F  D6 3D                DEC BUFTAB,X  
 EF71  A9 00                LDA #$00       ; END OF THIS LINE
 EF73  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF76  A9 01     <A NAME="EF76">DIR1</A>       LDA #$01       ; INSERT FHONEY LINKS ($0101)
 EF78  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF7B  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF7E  20 51 F5             JSR <A HREF="#F551">GETNAM</A>     ; GET #BUFRS AND FILE NAME
 EF81  90 2B                BCC <A HREF="#EFAE">DIR3</A>       ; TEST IF LAST ENTRY
 EF83  AD ED 10             LDA NBTEMP    
 EF86  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF89  AD EE 10             LDA NBTEMP+1  
 EF8C  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF8F  20 E2 EF             JSR <A HREF="#EFE2">MOVBUF</A>    
 EF92  A9 00                LDA #$00       ; END OF ENTRY
 EF94  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EF97  D0 DD                BNE <A HREF="#EF76">DIR1</A>      
 EF99  20 9D E8  <A NAME="EF99">DIR10</A>      JSR <A HREF="#E89D">GETACT</A>    
 EF9C  0A                   ASL <A HREF="#E89D"></A>          
 EF9D  AA                   TAX <A HREF="#E89D"></A>          
 EF9E  A9 00                LDA #$00      
 EFA0  95 3D                STA BUFTAB,X  
 EFA2  A9 88                LDA #$88       ; RDYTLK
 EFA4  A4 83                LDY LINDX     
 EFA6  85 38                STA DIRLST    
 EFA8  99 BE 00             STA CHNRDY,Y   ; DIRECTORY LIST BUFFER FULL
 EFAB  A5 87                LDA DATA      
 EFAD  60                   RTS           
 EFAE  AD ED 10  <A NAME="EFAE">DIR3</A>       LDA NBTEMP     ; THIS IS END OF LOAD
 EFB1  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EFB4  AD EE 10             LDA NBTEMP+1  
 EFB7  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EFBA  20 E2 EF             JSR <A HREF="#EFE2">MOVBUF</A>    
 EFBD  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EFC0  0A                   ASL <A HREF="#E89D"></A>          
 EFC1  AA                   TAX <A HREF="#E89D"></A>          
 EFC2  D6 3D                DEC BUFTAB,X  
 EFC4  D6 3D                DEC BUFTAB,X  
 EFC6  A9 00                LDA #$00       ; END OF LISTING (000)
 EFC8  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EFCB  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EFCE  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EFD1  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 EFD4  0A                   ASL <A HREF="#E89D"></A>          
 EFD5  A8                   TAY <A HREF="#E89D"></A>          
 EFD6  B9 3D 00             LDA BUFTAB,Y  
 EFD9  A6 83                LDX LINDX     
 EFDB  95 C6                STA LSTCHR,X  
 EFDD  D6 C6                DEC LSTCHR,X  
 EFDF  4C 99 EF             JMP <A HREF="#EF99">DIR10</A>     

; TRANSFRE FILE NAME TO LISTING BUFFER

 EFE2  A0 00     <A NAME="EFE2">MOVBUF</A>     LDY #$00      
 EFE4  B9 B4 42  <A NAME="EFE4">iEFE4</A>      LDA NAMBUF,Y  
 EFE7  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 EFEA  C8                   INY <A HREF="#E889"></A>          
 EFEB  C0 1B                CPY #$1B       ; in 4040 src this is #27, not a constant
 EFED  D0 F5                BNE <A HREF="#EFE4">iEFE4</A>     
 EFEF  60                   RTS <A HREF="#EFE4"></A>          

; GET CHAR FOR DIRECTORY LOADING

 EFF0  20 D4 E9  <A NAME="EFF0">GETDIR</A>     JSR <A HREF="#E9D4">GETBYT</A>    
 EFF3  F0 01                BEQ <A HREF="#EFF6">iEFF6</A>     
 EFF5  60                   RTS <A HREF="#EFF6"></A>          
 EFF6  85 87     <A NAME="EFF6">iEFF6</A>      STA DATA      
 EFF8  A4 83                LDY LINDX     
 EFFA  B9 C6 00             LDA LSTCHR,Y  
 EFFD  F0 08                BEQ <A HREF="#F007">iF007</A>     
; *** EFFF: Warning: Possibly modifyable opcode. ***

 EFFF  A9 80                LDA #$80       ; EOIOUT
 F001  99 BE 00             STA CHNRDY,Y  
 F004  A5 87                LDA DATA      
 F006  60                   RTS           
 F007  4C 76 EF  <A NAME="F007">iF007</A>      JMP <A HREF="#EF76">DIR1</A>      

; CALC THE NUMBER OF FREE BLOCKS ON DRVNUM

 F00A  A6 80     <A NAME="F00A">NUMFRE</A>     LDX DRVNUM    
 F00C  BD 40 E5             LDA <A HREF="#E540">IPBM,X</A>    
 F00F  85 2B                STA TEMP+1    
 F011  A9 04                LDA #$04      
 F013  85 2A                STA TEMP       ; 0 LOW PTR
 F015  A9 00                LDA #$00      
 F017  8D ED 10             STA NBTEMP    
 F01A  8D EE 10             STA NBTEMP+1  
 F01D  A9 22                LDA #$22      
 F01F  85 2C                STA TEMP+2    
 F021  A0 00     <A NAME="F021">iF021</A>      LDY #$00      
 F023  18                   CLC           
 F024  B1 2A                LDA (TEMP),Y  
 F026  6D ED 10             ADC NBTEMP    
 F029  8D ED 10             STA NBTEMP    
 F02C  AD EE 10             LDA NBTEMP+1  
 F02F  69 00                ADC #$00      
 F031  8D EE 10             STA NBTEMP+1  
 F034  A5 2A                LDA TEMP      
 F036  18        <A NAME="F036">iF036</A>      CLC           
 F037  69 04                ADC #$04      
 F039  C9 48                CMP #$48       ; DON'T COUNT THE DIR
 F03B  F0 F9                BEQ <A HREF="#F036">iF036</A>     
 F03D  85 2A                STA TEMP      
 F03F  C6 2C                DEC TEMP+2    
 F041  D0 DE                BNE <A HREF="#F021">iF021</A>     
 F043  60                   RTS <A HREF="#F021"></A>          

; PARSE &amp; EXECUTE STRING IN CMDBUF
; in 4040 there is some code in PARSXQ before this code here

 F044  20 59 F1  <A NAME="F044">PARSXQ</A>     JSR <A HREF="#F159">CMDSET</A>     ; SET VARIABLES, REGS
 F047  B9 00 00             LDA CMDBUF,Y  
 F04A  85 97                STA CHAR      
 F04C  A2 09                LDX #$09       ; NCMDS-1
 F04E  BD 00 E0  <A NAME="F04E">iF04E</A>      LDA <A HREF="#E000">CMDTBL,X</A>  
 F051  C5 97                CMP CHAR      
 F053  F0 08                BEQ <A HREF="#F05D">iF05D</A>     
 F055  CA                   DEX <A HREF="#F05D"></A>          
 F056  10 F6                BPL <A HREF="#F04E">iF04E</A>     
 F058  A9 31                LDA #$31       ; BADCMD, NO SUCH CMD
 F05A  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F05D  86 96     <A NAME="F05D">iF05D</A>      STX CMDNUM     ; X= CMD #
 F05F  E0 06                CPX #$06       ; PCMD, CMDS NOT PARSED
 F061  90 03                BCC <A HREF="#F066">iF066</A>     
 F063  20 AB F0             JSR <A HREF="#F0AB">TAGCMD</A>     ; SET TABLES, POINTERS &amp;PATTERNS
 F066  A6 96     <A NAME="F066">iF066</A>      LDX CMDNUM    
 F068  BD 0A E0             LDA <A HREF="#E00A">CJUMPL,X</A>  
 F06B  85 2A                STA TEMP      
 F06D  BD 14 E0             LDA <A HREF="#E014">CJUMPH,X</A>  
 F070  85 2B                STA TEMP+1    
 F072  6C 2A 00             JMP (TEMP)     ; COMMAND TABLE JUMP

; SUCCESSFUL COMMAND TERMINATION

 F075  A0 00     <A NAME="F075">ENDCMD</A>     LDY #$00      
 F077  98                   TYA           
 F078  84 81                STY TRACK     
 F07A  84 82     <A NAME="F07A">SCREND</A>     STY SECTOR     ; SCRATCH ENTRY
 F07C  84 5B                STY x5B        ; CB
 F07E  20 5D E7             JSR <A HREF="#E75D">ERRMSG</A>    
 F081  A5 80                LDA DRVNUM    
 F083  85 D2                STA LSTDRV    
 F085  AD 82 02             LDA RIOT2PBD  
 F088  29 DF                AND #$DF      
 F08A  8D 82 02             STA RIOT2PBD  
 F08D  4C A9 EE             JMP <A HREF="#EEA9">FREICH</A>     ; FREE INTERNAL CHANNELS (? label should be FREICH)

; COMMAND LEVEL ERROR PROCESSING

 F090  A0 00     <A NAME="F090">CMDERR</A>     LDY #$00      
 F092  84 81                STY TRACK     
 F094  84 82                STY SECTOR    
 F096  4C D4 E6             JMP <A HREF="#E6D4">CMDER2</A>    

 F099  A2 00     <A NAME="F099">SIMPRS</A>     LDX #$00       ; SIMPLE PARSER
 F09B  86 9D                STX FILTBL    
 F09D  A9 3A                LDA #$3A       ; ":"
 F09F  20 17 F1             JSR <A HREF="#F117">PARSE</A>     
 F0A2  F0 04                BEQ <A HREF="#F0A8">iF0A8</A>     
 F0A4  88                   DEY <A HREF="#F0A8"></A>          
 F0A5  88                   DEY <A HREF="#F0A8"></A>          
 F0A6  84 9D                STY FILTBL    
 F0A8  4C EC F1  <A NAME="F0A8">iF0A8</A>      JMP <A HREF="#F1EC">SETANY</A>     ; SET DRIVE#

; TAG COMMAND STRING
; SET UP CMD STRUCTURE
; IMAGE &amp; FILE STREAM PTRS
; Note: in 4040 the code up to the first PARSE is in subroutine PRSCLN

 F0AB  A0 00     <A NAME="F0AB">TAGCMD</A>     LDY #$00      
 F0AD  A2 00                LDX #$00      
 F0AF  A9 3A                LDA #$3A       ; ":"
 F0B1  20 17 F1             JSR <A HREF="#F117">PARSE</A>      ; FIND POS'N OF ":"
 F0B4  D0 05                BNE <A HREF="#F0BB">iF0BB</A>     
 F0B6  A9 34     <A NAME="F0B6">iF0B6</A>      LDA #$34       ; NOFILE, NONE, NO FILES
 F0B8  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F0BB  88        <A NAME="F0BB">iF0BB</A>      DEY <A HREF="#F090"></A>          
 F0BC  88                   DEY <A HREF="#F090"></A>          
 F0BD  84 9D                STY FILTBL     ; ":"-1 STARTS FS1
 F0BF  8A                   TXA           
 F0C0  D0 F4                BNE <A HREF="#F0B6">iF0B6</A>      ; ERR: "," BEFORE ":"
 F0C2  A9 3D     <A NAME="F0C2">iF0C2</A>      LDA #$3D       ; SEARCH "="
 F0C4  20 17 F1             JSR <A HREF="#F117">PARSE</A>     
 F0C7  8A                   TXA <A HREF="#F117"></A>           ; ?FILE COUNT = 1-1?
 F0C8  F0 02                BEQ <A HREF="#F0CC">iF0CC</A>     
 F0CA  A9 40                LDA #$40       ; %01000000, G1-BIT
 F0CC  09 21     <A NAME="F0CC">iF0CC</A>      ORA #$21       ; %00100001, E1,^E2-BITS
 F0CE  85 CF                STA IMAGE      ; FS STRUCTURE
 F0D0  E8                   INX           
 F0D1  86 99                STX F1CNT     
 F0D3  86 9A                STX R0         ; F2CNT, INIT FOR NO FS2
 F0D5  A5 CE                LDA PATFLG    
 F0D7  F0 0A                BEQ <A HREF="#F0E3">iF0E3</A>     
 F0D9  A9 80                LDA #$80       ; %10000000, P1-BIT
 F0DB  05 CF                ORA IMAGE     
 F0DD  85 CF                STA IMAGE     
 F0DF  A9 00                LDA #$00      
 F0E1  85 CE                STA PATFLG     ; CLEAR PATTERN FLAG
 F0E3  98        <A NAME="F0E3">iF0E3</A>      TYA            ; PTR TO FS2
 F0E4  F0 21                BEQ <A HREF="#F107">iF107</A>      ; FS2 NOT HERE
 F0E6  95 9D                STA FILTBL,X  
 F0E8  A5 99                LDA F1CNT      ; FS2 IS HERE NOW,...
 F0EA  85 9C                STA F2PTR      ; ...NOW SET F2 PTR
 F0EC  A9 8D                LDA #$8D       ; FIND CR-SHIFTED
 F0EE  20 17 F1             JSR <A HREF="#F117">PARSE</A>      ; PARSE REST OF CMD STRING
 F0F1  E8                   INX <A HREF="#F117"></A>           ; ADVANCE FILTBL PTR TO END
 F0F2  86 9A                STX R0         ; F2CNT, SAVE IT
 F0F4  CA                   DEX            ; RESTORE FOR TEST
 F0F5  A5 CE                LDA PATFLG     ; SAVE LAST PATTERN
 F0F7  F0 02                BEQ <A HREF="#F0FB">iF0FB</A>      ; ?ANY PATTERN?
 F0F9  A9 08                LDA #$08       ; %1000, YES, P2-BIT
 F0FB  E4 99     <A NAME="F0FB">iF0FB</A>      CPX F1CNT      ; ?F2CNT=F1CNT+1?
 F0FD  F0 02                BEQ <A HREF="#F101">iF101</A>     
 F0FF  09 04                ORA #$04       ; %0100, G2-BIT
 F101  09 03     <A NAME="F101">iF101</A>      ORA #$03       ; %0011, E2-BIT, ^E2-BIT
 F103  45 CF                EOR IMAGE      ; EOR CLEARS ^E2-BIT
 F105  85 CF                STA IMAGE     
 F107  A6 96     <A NAME="F107">iF107</A>      LDX CMDNUM    
 F109  3D 18 E0             AND <A HREF="#E014">CJUMPH+4,X</A> ; MATCH CMD TEMPLATE (orignal label: STRUCT)
 F10C  D0 01                BNE <A HREF="#F10F">iF10F</A>     
 F10E  60                   RTS <A HREF="#F10F"></A>          
 F10F  8D E9 10  <A NAME="F10F">iF10F</A>      STA ERWORD     ; **COULD BE WARNING
 F112  A9 30                LDA #$30       ; BADSYN, ERR: BAD SYNTAX
 F114  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    

; PARSE STRING
; LOOKS FOR SPECIAL CHARS,
; RETURNING WHEN VAR'BL CHAR
; IS FOUND
; A: VAR'BL CHAR
; X: IN,OUT: INDEX, FILTBL+1
; Y: IN: INDEX, CMDBUF
; OUT: NEW PTR, =0 IF NONE
; (Z=1) IF Y=0

 F117  85 97     <A NAME="F117">PARSE</A>      STA CHAR       ; SAVE VAR'BL CHAR
 F119  C4 95     <A NAME="F119">iF119</A>      CPY CMDSIZ     ; STAY IN STRING
 F11B  B0 2A                BCS <A HREF="#F147">iF147</A>     
 F11D  B9 00 00             LDA CMDBUF,Y   ; MATCH CHAR
 F120  C8                   INY           
 F121  C5 97                CMP CHAR      
 F123  F0 24                BEQ <A HREF="#F149">iF149</A>      ; FOUND CHAR
 F125  C9 2A                CMP #$2A       ; MATCH PATTERN CHAR ("*" in this case)
 F127  F0 04                BEQ <A HREF="#F12D">iF12D</A>     
 F129  C9 3F                CMP #$3F       ; "?"
 F12B  D0 02                BNE <A HREF="#F12F">iF12F</A>     
 F12D  E6 CE     <A NAME="F12D">iF12D</A>      INC PATFLG     ; SET PATTERN FLAG
 F12F  C9 2C     <A NAME="F12F">iF12F</A>      CMP #$2C       ; MATCH FILE SEPARATOR (",")
 F131  D0 E6                BNE <A HREF="#F119">iF119</A>     
 F133  98                   TYA <A HREF="#F119"></A>          
 F134  95 9E                STA FILTBL+1,X ; PUT PTRS IN TABLE
 F136  A5 CE                LDA PATFLG     ; SAVE PATTERN FOR EA FILE
 F138  29 7F                AND #$7F      
 F13A  F0 06                BEQ <A HREF="#F142">iF142</A>     
 F13C  A9 80                LDA #$80       ; RETAIN PATTERN PRESENCE...
 F13E  95 AC                STA FILTRK,X  
 F140  85 CE                STA PATFLG     ; ... BUT CLEAR COUNT
 F142  E8        <A NAME="F142">iF142</A>      INX           
 F143  E0 04                CPX #$04       ; MXFILS-1
 F145  90 D2                BCC <A HREF="#F119">iF119</A>      ; NO MORE THAN MXFILS
 F147  A0 00     <A NAME="F147">iF147</A>      LDY #$00       ; Y=0 (Z=1)
 F149  A5 95     <A NAME="F149">iF149</A>      LDA CMDSIZ    
 F14B  95 9E                STA FILTBL+1,X
 F14D  A5 CE                LDA PATFLG    
 F14F  29 7F                AND #$7F      
 F151  F0 04                BEQ <A HREF="#F157">iF157</A>     
 F153  A9 80                LDA #$80      
 F155  95 AC                STA FILTRK,X  
 F157  98        <A NAME="F157">iF157</A>      TYA            ; Z IS SET
 F158  60                   RTS           

; INITIALIZE COMMAND TABLES, PTRS, ETC.

 F159  A4 5B     <A NAME="F159">CMDSET</A>     LDY x5B        ; in 4040 source this is "LDY BUFTAB+CBPTR", but what does it mean?
 F15B  F0 14                BEQ <A HREF="#F171">iF171</A>     
 F15D  88                   DEY <A HREF="#F171"></A>          
 F15E  F0 10                BEQ <A HREF="#F170">iF170</A>     
 F160  B9 00 00             LDA CMDBUF,Y  
 F163  C9 0D                CMP #$0D       ; CR
 F165  F0 0A                BEQ <A HREF="#F171">iF171</A>     
 F167  88                   DEY <A HREF="#F171"></A>          
 F168  B9 00 00             LDA CMDBUF,Y  
 F16B  C9 0D                CMP #$0D       ; CR
 F16D  F0 02                BEQ <A HREF="#F171">iF171</A>     
 F16F  C8                   INY <A HREF="#F171"></A>          
 F170  C8        <A NAME="F170">iF170</A>      INY <A HREF="#F171"></A>          
 F171  84 95     <A NAME="F171">iF171</A>      STY CMDSIZ     ; SEt CMD STRING SIZE
 F173  C0 29                CPY #$29       ; CMDLEN-1
 F175  A0 FF                LDY #$FF      
 F177  90 07                BCC <A HREF="#F180">CMDRST</A>    
 F179  84 96                STY CMDNUM    
 F17B  A9 32                LDA #$32       ; LONGLN, LONG LINE ERROR
 F17D  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    

; CLEAR VARIABLES, TABLES

 F180  C8        <A NAME="F180">CMDRST</A>     INY <A HREF="#F090"></A>           ; in 4040, .Y is explicitely set to 0
 F181  84 5B     <A NAME="F181">iF181</A>      STY x5B        ; "BUFTAB+CBPTR"
 F183  98                   TYA           
 F184  85 DA                STA TYPFLG    
 F186  85 9B                STA F1PTR     
 F188  85 9C                STA F2PTR     
 F18A  85 99                STA F1CNT     
 F18C  85 9A                STA R0         ; F2CNT
 F18E  85 CE                STA PATFLG    
 F190  8D E9 10             STA ERWORD    
 F193  A2 05                LDX #$05       ; MXFILS
 F195  95 9C     <A NAME="F195">iF195</A>      STA F2PTR,X   
 F197  95 A1                STA xA1,X      ; FILENT-1
 F199  95 A6                STA xA6,X      ; FILDAT-1
 F19B  95 AB                STA xAB,X      ; FILTRK-1
 F19D  95 B0                STA xB0,X      ; FILSEC-1
 F19F  CA                   DEX           
 F1A0  D0 F3                BNE <A HREF="#F195">iF195</A>     
 F1A2  60                   RTS <A HREF="#F195"></A>          

; SET 1ST DRIVE AND TABLE POINTERS

 F1A3  A5 9A     <A NAME="F1A3">ONEDRV</A>     LDA R0        
 F1A5  85 99                STA F1CNT     
 F1A7  A9 01                LDA #$01      
 F1A9  85 9A                STA R0        
 F1AB  85 9C                STA F2PTR     

; SET UP ALL DRIVES FROM F2CNT

 F1AD  A4 D2     <A NAME="F1AD">ALLDRS</A>     LDY LSTDRV     ; ET UP DRIVE #'S...
 F1AF  A2 00                LDX #$00       ; ... INTO FILE ENTRY TABLE...
 F1B1  86 9B     <A NAME="F1B1">iF1B1</A>      STX F1PTR      ; ... ON SECTOR PTR BYTE
 F1B3  B5 9D                LDA FILTBL,X  
 F1B5  20 C5 F1             JSR <A HREF="#F1C5">SETDRV</A>    
 F1B8  A6 9B                LDX F1PTR     
 F1BA  95 9D                STA FILTBL,X   ; INCR PTR PAST ":"
 F1BC  98                   TYA            ; BITS REP DRIVES
 F1BD  95 A7                STA FILDAT,X   ; BIT7: DEFAULT
 F1BF  E8                   INX            ; BIT0: DRIVE #
 F1C0  E4 9A                CPX R0        
 F1C2  90 ED                BCC <A HREF="#F1B1">iF1B1</A>     
 F1C4  60                   RTS <A HREF="#F1B1"></A>          

; SET DRIVE NUMBER
; DETERMINES DRIVE # FROm TEST OR
; USES DEFAULT (-D)
; A: IN,OUT: INDEX, CMDBUF
; Y: IN: DEFAULT DRIVE
; OUT: DRIVE NUMBER, - IF DEFAULT

 F1C5  AA        <A NAME="F1C5">SETDRV</A>     TAX <A HREF="#F1B1"></A>           ; X=CMDBUF INDEX
 F1C6  A9 3A                LDA #$3A       ; ":"
 F1C8  D5 01                CMP CMDBUF+1,X ; FOR XXX:FILE
 F1CA  F0 0B                BEQ <A HREF="#F1D7">iF1D7</A>      ; ^
 F1CC  D5 00                CMP CMDBUF,X   ; FOR XXX:FILE
 F1CE  D0 15                BNE <A HREF="#F1E5">iF1E5</A>      ; ...^
 F1D0  E8                   INX <A HREF="#F1E5"></A>           ; FOUND ":", SO ...
 F1D1  98        <A NAME="F1D1">iF1D1</A>      TYA <A HREF="#F1E5"></A>           ; DRIVE= DEFAULT
 F1D2  29 01     <A NAME="F1D2">iF1D2</A>      AND #$01       ; CONVERT TO NUMERIC
 F1D4  A8        <A NAME="F1D4">iF1D4</A>      TAY            ; RESTORE DRIVE
 F1D5  8A                   TXA            ; A=INDEX &amp;&amp; XXXXFILE
 F1D6  60                   RTS            ; ...............^
 F1D7  B5 00     <A NAME="F1D7">iF1D7</A>      LDA CMDBUF,X  
 F1D9  E8                   INX            ; XXX:FILE
 F1DA  E8                   INX            ; ..--^
 F1DB  C9 30                CMP #$30       ; FOR XX0:FILE
 F1DD  F0 F3                BEQ <A HREF="#F1D2">iF1D2</A>      ; ........^
 F1DF  C9 31                CMP #$31       ; FOR XX1:FILE
 F1E1  F0 EF                BEQ <A HREF="#F1D2">iF1D2</A>      ; ........^
 F1E3  D0 EC                BNE <A HREF="#F1D1">iF1D1</A>      ; CMD:FILE OR XX,:FILE ; here points to the "F" in FILE twice
 F1E5  98        <A NAME="F1E5">iF1E5</A>      TYA <A HREF="#F1D1"></A>           ; FOR XXX,FILE OR XX=FILE
 F1E6  09 80                ORA #$80       ; ........^          ^
 F1E8  29 81                AND #$81       ; DRIVE= -DEFAULT
 F1EA  D0 E8                BNE <A HREF="#F1D4">iF1D4</A>      ; FINISH TESTING

; SET DRIVE FROM ANY CONFIG

 F1EC  A9 00     <A NAME="F1EC">SETANY</A>     LDA #$00      
 F1EE  85 CF                STA IMAGE     
 F1F0  A4 9D                LDY FILTBL    
 F1F2  B9 00 00  <A NAME="F1F2">iF1F2</A>      LDA CMDBUF,Y  
 F1F5  C9 30                CMP #$30      
 F1F7  F0 12                BEQ <A HREF="#F20B">iF20B</A>     
 F1F9  C9 31                CMP #$31      
 F1FB  F0 0E                BEQ <A HREF="#F20B">iF20B</A>     
 F1FD  C8                   INY <A HREF="#F20B"></A>          
 F1FE  C4 95                CPY CMDSIZ    
 F200  B0 05                BCS <A HREF="#F207">iF207</A>     
 F202  A4 95                LDY CMDSIZ    
 F204  88                   DEY           
 F205  D0 EB                BNE <A HREF="#F1F2">iF1F2</A>     
 F207  C6 CF     <A NAME="F207">iF207</A>      DEC IMAGE     
 F209  A5 D2                LDA LSTDRV    
 F20B  29 01     <A NAME="F20B">iF20B</A>      AND #$01      
 F20D  85 80                STA DRVNUM    
 F20F  4C 0A EF             JMP <A HREF="#EF0A">SETLDS</A>    

; TOGGLE DRVNUM

 F212  A5 80     <A NAME="F212">TOGDRV</A>     LDA DRVNUM    
 F214  49 01                EOR #$01      
 F216  29 01                AND #$01      
 F218  85 80                STA DRVNUM    
 F21A  60                   RTS           

; SET PTRS TO ONE FILE STREAM &amp; CHK TYPE

 F21B  A0 00     <A NAME="F21B">FS1SET</A>     LDY #$00      
 F21D  A5 99                LDA F1CNT     
 F21F  C5 9A                CMP R0         ; R0 aka F2CNT
 F221  F0 15                BEQ <A HREF="#F238">iF238</A>     
 F223  C6 9A                DEC R0        
 F225  A4 9A                LDY R0        
 F227  B9 9D 00             LDA FILTBL,Y  
 F22A  A8                   TAY           
 F22B  B9 00 00             LDA CMDBUF,Y   ; in 4040 this is an indirect indexed LDA (DB),Y
 F22E  A0 03                LDY #$03       ; NTYPES-1
 F230  D9 31 E0  <A NAME="F230">iF230</A>      CMP <A HREF="#E031">TYPLST,Y</A>  
 F233  F0 03                BEQ <A HREF="#F238">iF238</A>     
 F235  88                   DEY <A HREF="#F238"></A>          
 F236  D0 F8                BNE <A HREF="#F230">iF230</A>     
 F238  98        <A NAME="F238">iF238</A>      TYA <A HREF="#F230"></A>          
 F239  0A                   ASL <A HREF="#F230"></A>          
 F23A  85 DA                STA TYPFLG    
 F23C  60                   RTS           

; TEST CHAR In ACCUM FOR "0" OR "1"

 F23D  C9 30     <A NAME="F23D">TST0V1</A>     CMP #$30      
 F23F  F0 06                BEQ <A HREF="#F247">iF247</A>     
 F241  C9 31                CMP #$31      
 F243  F0 02                BEQ <A HREF="#F247">iF247</A>     
 F245  09 80                ORA #$80      
 F247  29 81     <A NAME="F247">iF247</A>      AND #$81      
 F249  60                   RTS           

; OPTSCH OPTIMAL SEARCH FOR LOOKUP
; AND FNDFIL

 F24A  A9 00     <A NAME="F24A">OPTSCH</A>     LDA #$00       ; DETERMINE OPTIMAL SEARCH
 F24C  85 2A                STA TEMP       ; INIT DRIVE MASK
 F24E  85 D1                STA DRVFLG    
 F250  85 D1                STA DRVFLG    
 F252  48                   PHA           
 F253  A6 9A                LDX R0        
 F255  68        <A NAME="F255">iF255</A>      PLA           
 F256  05 2A                ORA TEMP      
 F258  48                   PHA           
 F259  A9 01                LDA #$01      
 F25B  85 2A                STA TEMP      
 F25D  CA                   DEX           
 F25E  30 0F                BMI <A HREF="#F26F">iF26F</A>     
 F260  B5 A7                LDA FILDAT,X  
 F262  10 04                BPL <A HREF="#F268">iF268</A>     
 F264  06 2A                ASL TEMP      
 F266  06 2A                ASL TEMP      
 F268  4A        <A NAME="F268">iF268</A>      LSR           
 F269  90 EA                BCC <A HREF="#F255">iF255</A>     
 F26B  06 2A                ASL TEMP      
 F26D  D0 E6                BNE <A HREF="#F255">iF255</A>      ; (BRANCH)
 F26F  68        <A NAME="F26F">iF26F</A>      PLA <A HREF="#F255"></A>          
 F270  AA                   TAX <A HREF="#F255"></A>          
 F271  BD 89 F2             LDA <A HREF="#F28A">SCHTBL-1,X</A>
 F274  48                   PHA <A HREF="#F28A"></A>          
 F275  29 03                AND #$03      
 F277  85 D0                STA DRVCNT    
 F279  68                   PLA           
 F27A  0A                   ASL           
 F27B  10 09                BPL <A HREF="#F286">iF286</A>     
 F27D  A5 A7                LDA FILDAT    
 F27F  29 01     <A NAME="F27F">iF27F</A>      AND #$01      
 F281  85 80                STA DRVNUM    
 F283  4C 0A EF             JMP <A HREF="#EF0A">SETLDS</A>     ; in 4040 before JMP comment "*RSR ADD FOR AUTO INIT" and auto init code?
 F286  2A        <A NAME="F286">iF286</A>      ROL <A HREF="#EF0A"></A>          
; *** F287: Warning: Possibly modifyable opcode. ***

 F287  4C 7F F2             JMP <A HREF="#F27F">iF27F</A>     

; *** Invalid reference F28A ignored.

 F28A  <A NAME="F28A">SCHTBL</A>     .byte $00, $80, $41, $01, $01, $01, $01, $81  ;..aaaaa.
 F292             .byte $81, $81, $81, $42, $42, $42, $42       ;...bbbb

; LOOK Up ALL FILES IN STREAM
; AND FILL TABLES W/ INFO


 F299  20 4A F2  <A NAME="F299">LOOKUP</A>     JSR <A HREF="#F24A">OPTSCH</A>    
 F29C  A9 00     <A NAME="F29C">iF29C</A>      LDA #$00      
 F29E  85 D6                STA DELIND    
 F2A0  20 CE F3             JSR <A HREF="#F3CE">SRCHST</A>     ; START SEARCH
 F2A3  D0 18                BNE <A HREF="#F2BD">iF2BD</A>     
 F2A5  C6 D0     <A NAME="F2A5">iF2A5</A>      DEC DRVCNT    
 F2A7  10 01                BPL <A HREF="#F2AA">iF2AA</A>     
 F2A9  60                   RTS <A HREF="#F2AA"></A>           ; NO MORE DRIVE SEARCHES
 F2AA  A9 01     <A NAME="F2AA">iF2AA</A>      LDA #$01       ; TOGGLE DRIVE #
 F2AC  85 D1                STA DRVFLG    
 F2AE  20 12 F2             JSR <A HREF="#F212">TOGDRV</A>    
 F2B1  20 0A EF             JSR <A HREF="#EF0A">SETLDS</A>     ; TURN ON LEDS
 F2B4  F0 E6                BEQ <A HREF="#F29C">iF29C</A>      ; (BRANCH)
 F2B6  D0 E4                BNE <A HREF="#F29C">iF29C</A>     
 F2B8  20 29 F4  <A NAME="F2B8">iF2B8</A>      JSR <A HREF="#F429">SEARCH</A>     ; FIND VALID FN
 F2BB  F0 0E                BEQ <A HREF="#F2CB">iF2CB</A>      ; END OF SEARCH
 F2BD  20 14 F3  <A NAME="F2BD">iF2BD</A>      JSR <A HREF="#F314">COMPAR</A>     ; COMPARE DIR W/ TABLE
 F2C0  A5 D3                LDA FOUND      ; FOUND FLAG
 F2C2  F0 01                BEQ <A HREF="#F2C5">iF2C5</A>      ; ALL FN'S NOT FOUND, YET
 F2C4  60                   RTS <A HREF="#F2C5"></A>          
 F2C5  A5 37     <A NAME="F2C5">iF2C5</A>      LDA ENTFND    
 F2C7  30 EF                BMI <A HREF="#F2B8">iF2B8</A>     
 F2C9  10 F2                BPL <A HREF="#F2BD">iF2BD</A>     
 F2CB  A5 D3     <A NAME="F2CB">iF2CB</A>      LDA FOUND     
 F2CD  F0 D6                BEQ <A HREF="#F2A5">iF2A5</A>     
 F2CF  60                   RTS <A HREF="#F2A5"></A>          

; FIND NEXT FILE NAME MATCHING
; ANY FILE IN STREAM &amp; RETURN
; WITH ENTRY FOUND STUFFED INTO
; TABLES

 F2D0  20 19 F4  <A NAME="F2D0">FFRE</A>       JSR <A HREF="#F419">SRRE</A>       ; FIND FILE RE-ENTRY
 F2D3  F0 17                BEQ <A HREF="#F2EC">iF2EC</A>     
 F2D5  D0 23                BNE <A HREF="#F2FA">iF2FA</A>     
 F2D7  A9 01     <A NAME="F2D7">iF2D7</A>      LDA #$01      
 F2D9  85 D1                STA DRVFLG    
 F2DB  20 12 F2             JSR <A HREF="#F212">TOGDRV</A>    
 F2DE  20 0A EF             JSR <A HREF="#EF0A">SETLDS</A>    
 F2E1  A9 00     <A NAME="F2E1">FFST</A>       LDA #$00       ; FIND FILE START ENTRY
 F2E3  85 D6                STA DELIND    
 F2E5  20 CE F3             JSR <A HREF="#F3CE">SRCHST</A>    
 F2E8  D0 10                BNE <A HREF="#F2FA">iF2FA</A>     
 F2EA  85 D3                STA FOUND     
 F2EC  A5 D3     <A NAME="F2EC">iF2EC</A>      LDA FOUND     
 F2EE  D0 23                BNE <A HREF="#F313">iF313</A>     
 F2F0  C6 D0                DEC DRVCNT    
 F2F2  10 E3                BPL <A HREF="#F2D7">iF2D7</A>     
 F2F4  60                   RTS <A HREF="#F2D7"></A>          
 F2F5  20 29 F4  <A NAME="F2F5">FNDFIL</A>     JSR <A HREF="#F429">SEARCH</A>     ; FIND FILE CONTINUOUS...
 F2F8  F0 F2                BEQ <A HREF="#F2EC">iF2EC</A>      ; ... RE-ENTRY, NO CHANNEL ACTIVITY
 F2FA  20 14 F3  <A NAME="F2FA">iF2FA</A>      JSR <A HREF="#F314">COMPAR</A>     ; COMPARE FILE NAMES
 F2FD  A6 37                LDX ENTFND    
 F2FF  10 06                BPL <A HREF="#F307">iF307</A>     
 F301  A5 D3                LDA FOUND     
 F303  F0 F0                BEQ <A HREF="#F2F5">FNDFIL</A>    
 F305  D0 0C                BNE <A HREF="#F313">iF313</A>     
 F307  A5 DA     <A NAME="F307">iF307</A>      LDA TYPFLG    
 F309  F0 08                BEQ <A HREF="#F313">iF313</A>      ; NO TYPE RESTRICTION
 F30B  B5 A7                LDA FILDAT,X  
 F30D  29 1E                AND #$1E      
 F30F  C5 DA                CMP TYPFLG    
 F311  D0 E2                BNE <A HREF="#F2F5">FNDFIL</A>    
 F313  60        <A NAME="F313">iF313</A>      RTS <A HREF="#F2F5"></A>          

; COMPARE ALL FILENAMES IN STREAM TABLE
; WITH EACH VALID ENTRY IN THE
; DIRECTORY. MATCHES ARE TABULATED

 F314  A2 FF     <A NAME="F314">COMPAR</A>     LDX #$FF      
 F316  86 37                STX ENTFND    
 F318  E8                   INX           
 F319  86 CE                STX PATFLG    
 F31B  20 B4 F3             JSR <A HREF="#F3B4">CMPCHK</A>    
 F31E  F0 06                BEQ <A HREF="#F326">iF326</A>     
 F320  60        <A NAME="F320">iF320</A>      RTS <A HREF="#F326"></A>           ; ALL ARE FOUND
 F321  20 BC F3  <A NAME="F321">iF321</A>      JSR <A HREF="#F3BC">CC10</A>      
 F324  D0 FA                BNE <A HREF="#F320">iF320</A>     
 F326  A5 80     <A NAME="F326">iF326</A>      LDA DRVNUM    
 F328  55 A7                EOR FILDAT,X  
 F32A  4A                   LSR           
 F32B  90 0A                BCC <A HREF="#F337">iF337</A>      ; RIGHT DRIVE
 F32D  29 40                AND #$40      
 F32F  F0 F0                BEQ <A HREF="#F321">iF321</A>      ; NO DEFAULT
 F331  A9 02                LDA #$02      
 F333  C5 D0                CMP DRVCNT    
 F335  F0 EA                BEQ <A HREF="#F321">iF321</A>      ; DON'T USE DEFAULT
 F337  B5 9D     <A NAME="F337">iF337</A>      LDA FILTBL,X   ; GOOD DRIVE MATCH
 F339  AA                   TAX           
 F33A  20 2F F5             JSR <A HREF="#F52F">FNDLMT</A>    
 F33D  A0 03                LDY #$03      
 F33F  B1 93                LDA (DIRBUF),Y ; in 4040 the CMDBUF,x and (DIRBUF),y are exchanged, so the char is always in .A and can directly compared with
 F341  E4 98     <A NAME="F341">iF341</A>      CPX LIMIT      ; this compare and the branch is later in 4040
 F343  B0 DC                BCS <A HREF="#F321">iF321</A>      ; END OF PATTERN
 F345  D5 00                CMP CMDBUF,X  
 F347  F0 06                BEQ <A HREF="#F34F">iF34F</A>      ; CHARS ARE =
 F349  A9 3F                LDA #$3F       ; "?"
 F34B  D5 00                CMP CMDBUF,X  
 F34D  D0 5C                BNE <A HREF="#F3AB">iF3AB</A>      ; NO SINGLE PATTERN
 F34F  C8        <A NAME="F34F">iF34F</A>      INY <A HREF="#F3AB"></A>          
 F350  E8                   INX <A HREF="#F3AB"></A>          
 F351  B1 93                LDA (DIRBUF),Y
 F353  C9 A0                CMP #$A0      
 F355  F0 04                BEQ <A HREF="#F35B">iF35B</A>      ; END OF FILENAME
 F357  C0 13                CPY #$13      
 F359  90 E6                BCC <A HREF="#F341">iF341</A>      ; in 4040 this is at different place as BCS, with comment "END OF FILENAME"
 F35B  A9 2A     <A NAME="F35B">iF35B</A>      LDA #$2A       ; "*"
 F35D  D5 00                CMP CMDBUF,X   ; STAR MATCHES ALL
 F35F  F0 04                BEQ <A HREF="#F365">iF365</A>     
 F361  E4 98                CPX LIMIT     
 F363  90 BC                BCC <A HREF="#F321">iF321</A>     
 F365  A6 9C     <A NAME="F365">iF365</A>      LDX F2PTR      ; FILENAMES MATCH
 F367  86 37                STX ENTFND    
 F369  B5 AC                LDA FILTRK,X   ; STORE INFO IN TABLES
 F36B  29 80                AND #$80      
 F36D  85 CE                STA PATFLG    
 F36F  95 AC                STA FILTRK,X  
 F371  A5 D8                LDA INDEX     
 F373  29 E0                AND #$E0      
 F375  85 2A                STA TEMP      
 F377  A5 82                LDA SECTOR    
 F379  05 2A                ORA TEMP      
 F37B  95 A2                STA FILENT,X  
 F37D  A0 00                LDY #$00      
 F37F  B1 93                LDA (DIRBUF),Y
 F381  C8                   INY           
 F382  48                   PHA           
 F383  29 40                AND #$40      
 F385  85 2A                STA TEMP      
 F387  68                   PLA           
 F388  0A                   ASL           
 F389  29 1E                AND #$1E      
 F38B  B0 02                BCS <A HREF="#F38F">iF38F</A>     
 F38D  09 20                ORA #$20      
 F38F  05 2A     <A NAME="F38F">iF38F</A>      ORA TEMP      
 F391  85 2A                STA TEMP      
 F393  A9 80                LDA #$80      
 F395  35 A7                AND FILDAT,X  
 F397  05 80                ORA DRVNUM    
 F399  05 2A                ORA TEMP      
 F39B  95 A7                STA FILDAT,X  
 F39D  B1 93                LDA (DIRBUF),Y
 F39F  15 AC                ORA FILTRK,X  
 F3A1  95 AC                STA FILTRK,X  
 F3A3  C8                   INY           
 F3A4  B1 93                LDA (DIRBUF),Y
 F3A6  95 B1                STA FILSEC,X  
 F3A8  4C B4 F3             JMP <A HREF="#F3B4">CMPCHK</A>     ; here is a change from 4040
 F3AB  A9 2A     <A NAME="F3AB">iF3AB</A>      LDA #$2A      
 F3AD  D5 00                CMP CMDBUF,X  
 F3AF  F0 B4                BEQ <A HREF="#F365">iF365</A>     
 F3B1  4C 21 F3             JMP <A HREF="#F321">iF321</A>     

; CHECK TABLES FOR UNFOUND FILES

 F3B4  A9 FF     <A NAME="F3B4">CMPCHK</A>     LDA #$FF      
 F3B6  85 D3                STA FOUND     
 F3B8  A5 9A                LDA R0        
 F3BA  85 9C                STA F2PTR     
 F3BC  C6 9C     <A NAME="F3BC">CC10</A>       DEC F2PTR     
 F3BE  10 01                BPL <A HREF="#F3C1">iF3C1</A>     
 F3C0  60                   RTS <A HREF="#F3C1"></A>           ; TABLE EXHAUSTED
 F3C1  A6 9C     <A NAME="F3C1">iF3C1</A>      LDX F2PTR     
 F3C3  B5 AC                LDA FILTRK,X  
 F3C5  30 02                BMI <A HREF="#F3C9">iF3C9</A>     
 F3C7  D0 F3                BNE <A HREF="#F3BC">CC10</A>      
 F3C9  A9 00     <A NAME="F3C9">iF3C9</A>      LDA #$00      
 F3CB  85 D3                STA FOUND     
 F3CD  60                   RTS           

; SEARCH DIRECTORY
; RETURNS WITH VALID ENTRY W/ DELIND=0
; OR RETURNS W/ 1ST DELETED ENTRY
; DELIND=1
; e
; SRCHST WILL INITIATE A SEARCH
; SEARCH WILL CONTINUE A SEARCH

 F3CE  A0 00     <A NAME="F3CE">SRCHST</A>     LDY #$00       ; INIT DELETED SECTOR
 F3D0  84 D5                STY DELSEC    
 F3D2  88                   DEY           
 F3D3  84 37                STY ENTFND    
 F3D5  A9 12                LDA #$12       ; START SEARCH AT BEGINNING
 F3D7  85 81                STA TRACK     
 F3D9  A9 01                LDA #$01      
 F3DB  85 82                STA SECTOR    
 F3DD  85 D7                STA LSTBUF    
 F3DF  20 36 EE             JSR <A HREF="#EE36">OPNIRD</A>     ; OPEN INTERNAL READ CHNL
 F3E2  A5 D7     <A NAME="F3E2">iF3E2</A>      LDA LSTBUF     ; LAST BUFFER IF 0
 F3E4  D0 01                BNE <A HREF="#F3E7">iF3E7</A>     
 F3E6  60                   RTS <A HREF="#F3E7"></A>           ; (Z=1)
 F3E7  A9 07     <A NAME="F3E7">iF3E7</A>      LDA #$07      
 F3E9  85 D9                STA FILCNT    
 F3EB  A9 00                LDA #$00       ; READ TRACK #
 F3ED  20 BE EE             JSR <A HREF="#EEBE">DRDBYT</A>    
 F3F0  85 D7                STA LSTBUF     ; UPDATE END FLAG
 F3F2  20 B0 EE  <A NAME="F3F2">iF3F2</A>      JSR <A HREF="#EEB0">GETPNT</A>    
 F3F5  C6 D9                DEC FILCNT    
 F3F7  A0 00                LDY #$00      
 F3F9  B1 93                LDA (DIRBUF),Y ; READ FILE TYPE
 F3FB  D0 14                BNE <A HREF="#F411">iF411</A>     
 F3FD  A5 D5                LDA DELSEC     ; DELETED ENTRY FOUND
 F3FF  D0 28                BNE <A HREF="#F429">SEARCH</A>     ; DELETED ENTRY ALREADY FOUND
 F401  20 06 EE             JSR <A HREF="#EE06">CURBLK</A>     ; GET CURRENT SECTOR
 F404  A5 82                LDA SECTOR    
 F406  85 D5                STA DELSEC    
 F408  A5 93                LDA DIRBUF     ; GET CURRENT INDEX
 F40A  A6 D6                LDX DELIND     ; BIT1: WANT DELETED ENTRY
 F40C  85 D6                STA DELIND    
 F40E  F0 19                BEQ <A HREF="#F429">SEARCH</A>     ; NEED VALID ENTRY
 F410  60                   RTS <A HREF="#F429"></A>          
 F411  A2 01     <A NAME="F411">iF411</A>      LDX #$01      
 F413  E4 D6                CPX DELIND     ; ?LOOKING FOR DELETED?
 F415  D0 2A                BNE <A HREF="#F441">iF441</A>      ; NO!
 F417  F0 10                BEQ <A HREF="#F429">SEARCH</A>    
 F419  A9 12     <A NAME="F419">SRRE</A>       LDA #$12      
 F41B  85 81                STA TRACK     
 F41D  A5 D4                LDA DIRSEC    
 F41F  85 82                STA SECTOR    
 F421  20 36 EE             JSR <A HREF="#EE36">OPNIRD</A>    
 F424  A5 D8                LDA INDEX     
 F426  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 F429  A9 FF     <A NAME="F429">SEARCH</A>     LDA #$FF      
 F42B  85 37                STA ENTFND    
 F42D  A5 D9                LDA FILCNT     ; ADJUST FILE COUNT
 F42F  30 09                BMI <A HREF="#F43A">iF43A</A>     
 F431  A9 20                LDA #$20       ; INCR BY 32
 F433  20 59 EA             JSR <A HREF="#EA59">INCPTR</A>    
 F436  D0 BA                BNE <A HREF="#F3F2">iF3F2</A>      ; these two branches are later replaced by a JMP :-)
 F438  F0 B8                BEQ <A HREF="#F3F2">iF3F2</A>     
 F43A  20 F3 ED  <A NAME="F43A">iF43A</A>      JSR <A HREF="#EDF3">NXTBUF</A>     ; NEW BUFFER
 F43D  D0 A3                BNE <A HREF="#F3E2">iF3E2</A>      ; in 4040 replaced by JMP, with comment "(BRANCH)" :-)
 F43F  F0 A1                BEQ <A HREF="#F3E2">iF3E2</A>     
 F441  A5 93     <A NAME="F441">iF441</A>      LDA DIRBUF     ; FOUND VALID ENTRY
 F443  85 D8                STA INDEX      ; SAVE INDEX
 F445  20 06 EE             JSR <A HREF="#EE06">CURBLK</A>     ; GET SECTOR
 F448  A5 82                LDA SECTOR    
 F44A  85 D4                STA DIRSEC    
 F44C  60                   RTS            ; (Z=0)

; TRANSFER FILENAME FROM CMD TO BUFFER.
; A=STRING SIZE. 
; X=STARTING INDEX IN CMDBUF.
; Y=BUFFER #

 F44D  48        <A NAME="F44D">TRNAME</A>     PHA           
 F44E  20 2F F5             JSR <A HREF="#F52F">FNDLMT</A>    
 F451  20 66 F4             JSR <A HREF="#F466">TRCMBF</A>    
 F454  68                   PLA <A HREF="#F466"></A>          
 F455  38                   SEC <A HREF="#F466"></A>          
 F456  E5 2D                SBC TEMP+3    
 F458  AA                   TAX           
 F459  F0 0A                BEQ <A HREF="#F465">iF465</A>     
 F45B  90 08                BCC <A HREF="#F465">iF465</A>     
 F45D  A9 A0                LDA #$A0      
 F45F  91 93     <A NAME="F45F">iF45F</A>      STA (DIRBUF),Y
 F461  C8                   INY           
 F462  CA                   DEX           
 F463  D0 FA                BNE <A HREF="#F45F">iF45F</A>     
 F465  60        <A NAME="F465">iF465</A>      RTS <A HREF="#F45F"></A>          

; TRANSFER CMD BUFFER TO OTHER BUFFER
; USES CURRENT BUFFER PTR.
; LIMIT ENDING INDEX+1 IN CMD BUF
; X=STARTING INDEX IN CMD BUF
; Y=BUFFER#

 F466  98        <A NAME="F466">TRCMBF</A>     TYA <A HREF="#F45F"></A>          
 F467  0A                   ASL <A HREF="#F45F"></A>          
 F468  A8                   TAY <A HREF="#F45F"></A>          
 F469  B9 3D 00             LDA BUFTAB,Y  
 F46C  85 93                STA DIRBUF    
 F46E  B9 3E 00             LDA BUFTAB+1,Y
 F471  85 94                STA DIRBUF+1  
 F473  A0 00                LDY #$00      
 F475  B5 00     <A NAME="F475">iF475</A>      LDA CMDBUF,X  
 F477  91 93                STA (DIRBUF),Y
 F479  C8                   INY           
 F47A  F0 05                BEQ <A HREF="#F481">iF481</A>     
 F47C  E8                   INX <A HREF="#F481"></A>          
 F47D  E4 98                CPX LIMIT     
 F47F  90 F4                BCC <A HREF="#F475">iF475</A>     
 F481  60        <A NAME="F481">iF481</A>      RTS <A HREF="#F475"></A>          

; TODO

 F482  A5 84     <A NAME="F482">iF482</A>      LDA SA        
 F484  48                   PHA           
 F485  A5 83                LDA LINDX     
 F487  48                   PHA           
 F488  A5 82                LDA SECTOR    
 F48A  48                   PHA           
 F48B  A5 81                LDA TRACK     
 F48D  48                   PHA           
 F48E  A9 10                LDA #$10      
 F490  85 84                STA SA        
 F492  20 06 EE             JSR <A HREF="#EE06">CURBLK</A>    
 F495  A6 8D                LDX JOBNUM    
 F497  BD 99 10             LDA LSTJOB,X  
 F49A  A6 9B                LDX F1PTR     
 F49C  55 A7                EOR FILDAT,X  
 F49E  4A                   LSR           
 F49F  90 14                BCC <A HREF="#F4B5">iF4B5</A>     
 F4A1  B5 A7                LDA FILDAT,X  
 F4A3  29 01                AND #$01      
 F4A5  85 80                STA DRVNUM    
 F4A7  A2 01                LDX #$01      
 F4A9  86 D6                STX DELIND    
 F4AB  CA                   DEX           
 F4AC  86 D5                STX DELSEC    
 F4AE  20 CE F3             JSR <A HREF="#F3CE">SRCHST</A>    
 F4B1  F0 1B                BEQ <A HREF="#F4CE">iF4CE</A>     
 F4B3  D0 24                BNE <A HREF="#F4D9">iF4D9</A>     
 F4B5  A5 D5     <A NAME="F4B5">iF4B5</A>      LDA DELSEC    
 F4B7  F0 0C                BEQ <A HREF="#F4C5">iF4C5</A>     
 F4B9  C5 82                CMP SECTOR    
 F4BB  F0 1C                BEQ <A HREF="#F4D9">iF4D9</A>     
 F4BD  85 82                STA SECTOR    
 F4BF  20 1D EE             JSR <A HREF="#EE1D">DRTRD</A>     
 F4C2  4C D9 F4             JMP <A HREF="#F4D9">iF4D9</A>     
 F4C5  A9 01     <A NAME="F4C5">iF4C5</A>      LDA #$01      
 F4C7  85 D6                STA DELIND    
 F4C9  20 29 F4             JSR <A HREF="#F429">SEARCH</A>    
 F4CC  D0 0B                BNE <A HREF="#F4D9">iF4D9</A>     
 F4CE  20 49 EE  <A NAME="F4CE">iF4CE</A>      JSR <A HREF="#EE49">NXDRBK</A>    
 F4D1  A5 82                LDA SECTOR    
 F4D3  85 D5                STA DELSEC    
 F4D5  A9 02                LDA #$02      
 F4D7  85 D6                STA DELIND    
 F4D9  A5 D6     <A NAME="F4D9">iF4D9</A>      LDA DELIND    
 F4DB  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 F4DE  A5 DC                LDA xDC       
 F4E0  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 F4E3  68                   PLA <A HREF="#E889"></A>          
 F4E4  A6 9B                LDX F1PTR     
 F4E6  95 AC                STA FILTRK,X  
 F4E8  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 F4EB  68                   PLA <A HREF="#E889"></A>          
 F4EC  A6 9B                LDX F1PTR     
 F4EE  95 B1                STA FILSEC,X  
 F4F0  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 F4F3  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 F4F6  A8                   TAY <A HREF="#E89D"></A>          
 F4F7  A6 9B                LDX F1PTR     
 F4F9  B5 9D                LDA FILTBL,X  
 F4FB  AA                   TAX           
 F4FC  A9 10                LDA #$10      
 F4FE  20 4D F4             JSR <A HREF="#F44D">TRNAME</A>    
 F501  A0 17                LDY #$17      
 F503  A9 00                LDA #$00      
 F505  91 93     <A NAME="F505">iF505</A>      STA (DIRBUF),Y
 F507  C8                   INY           
 F508  C0 1B                CPY #$1B      
 F50A  90 F9                BCC <A HREF="#F505">iF505</A>     
 F50C  20 21 EE             JSR <A HREF="#EE21">DRTWRT</A>    
 F50F  68                   PLA <A HREF="#EE21"></A>          
 F510  85 83                STA LINDX     
 F512  68                   PLA           
 F513  85 84                STA SA        
 F515  A6 9B                LDX F1PTR     
 F517  A5 D5                LDA DELSEC    
 F519  29 1F                AND #$1F      
 F51B  95 A2                STA FILENT,X  
 F51D  A5 D6                LDA DELIND    
 F51F  29 E0                AND #$E0      
 F521  15 A2                ORA FILENT,X  
 F523  95 A2                STA FILENT,X  
 F525  A5 DC                LDA xDC       
 F527  0A                   ASL           
 F528  29 1E                AND #$1E      
 F52A  05 80                ORA DRVNUM    
 F52C  95 A7                STA FILDAT,X  
 F52E  60                   RTS           

; FIND THE LIMIT OF THE STRING IN CMDBUF
; POINTED TO BY X

 F52F  A9 00     <A NAME="F52F">FNDLMT</A>     LDA #$00      
 F531  85 2D                STA TEMP+3    
 F533  8A                   TXA           
 F534  48                   PHA           
 F535  B5 00     <A NAME="F535">iF535</A>      LDA CMDBUF,X  
 F537  C9 2C                CMP #$2C       ; "."
 F539  F0 11                BEQ <A HREF="#F54C">iF54C</A>     
 F53B  C9 3D                CMP #$3D       ; "="
 F53D  F0 0D                BEQ <A HREF="#F54C">iF54C</A>     
 F53F  E6 2D                INC TEMP+3    
 F541  E8                   INX           
 F542  A9 0F                LDA #$0F      
 F544  C5 2D                CMP TEMP+3    
 F546  90 04                BCC <A HREF="#F54C">iF54C</A>     
 F548  E4 95                CPX CMDSIZ    
 F54A  90 E9                BCC <A HREF="#F535">iF535</A>     
 F54C  86 98     <A NAME="F54C">iF54C</A>      STX LIMIT     
 F54E  68                   PLA           
 F54F  AA                   TAX           
 F550  60                   RTS           

; GET FILE ENTRY FROM DIRECTORY
; CALLED BY STDIR, GETDIR; SAVE VARIABLES

 F551  A5 84     <A NAME="F551">GETNAM</A>     LDA SA         ; SAVE VARIABLES
 F553  48                   PHA           
 F554  A5 83                LDA LINDX     
 F556  48                   PHA           
 F557  20 61 F5             JSR <A HREF="#F561">GNSUB</A>     
 F55A  68                   PLA <A HREF="#F561"></A>          
 F55B  85 83                STA LINDX     
 F55D  68                   PLA           
 F55E  85 84                STA SA        
 F560  60                   RTS           

 F561  A9 10     <A NAME="F561">GNSUB</A>      LDA #$10       ; IRSA
 F563  85 84                STA SA        
 F565  20 B0 E9             JSR <A HREF="#E9B0">FNDRCH</A>    
 F568  20 B0 EE             JSR <A HREF="#EEB0">GETPNT</A>    
 F56B  A5 37                LDA ENTFND    
 F56D  10 07                BPL <A HREF="#F576">iF576</A>      ; MORE FILES
 F56F  20 5D F6             JSR <A HREF="#F65D">MSGFRE</A>     ; SEND BLOCKS FREE
 F572  18                   CLC <A HREF="#F65D"></A>           ; (C=0) = END
 F573  4C 22 F6             JMP <A HREF="#F622">iF622</A>      ; TERMINATE
 F576  A5 D1     <A NAME="F576">iF576</A>      LDA DRVFLG    
 F578  F0 1F                BEQ <A HREF="#F599">iF599</A>     
 F57A  C6 D1                DEC DRVFLG     ; (DRVFLG=-1) = NEW DIR
 F57C  D0 0C                BNE <A HREF="#F58A">iF58A</A>     
 F57E  C6 D1                DEC DRVFLG     ; (DRVFLG=-1) =
 F580  20 12 F2             JSR <A HREF="#F212">TOGDRV</A>     ; SEND BLOCKS FREE
 F583  20 5D F6             JSR <A HREF="#F65D">MSGFRE</A>    
 F586  38                   SEC <A HREF="#F65D"></A>          
 F587  4C 12 F2             JMP <A HREF="#F212">TOGDRV</A>    
 F58A  A9 00     <A NAME="F58A">iF58A</A>      LDA #$00      
 F58C  8D EE 10             STA NBTEMP+1  
 F58F  85 D1                STA DRVFLG    
 F591  20 2E F6             JSR <A HREF="#F62E">NEWDIR</A>    
 F594  8E ED 10             STX NBTEMP    
 F597  38                   SEC           
 F598  60                   RTS           
 F599  A2 18     <A NAME="F599">iF599</A>      LDX #$18       ; DIRLEN; SET NUMBER BLOCKS
 F59B  A0 1D                LDY #$1D       ; &amp; ADJUST SPACING
 F59D  B1 93                LDA (DIRBUF),Y
 F59F  8D EE 10             STA NBTEMP+1  
 F5A2  F0 02                BEQ <A HREF="#F5A6">iF5A6</A>     
 F5A4  A2 16                LDX #$16       ; DIRLEN-2
 F5A6  88        <A NAME="F5A6">iF5A6</A>      DEY           
 F5A7  B1 93                LDA (DIRBUF),Y
 F5A9  8D ED 10             STA NBTEMP    
 F5AC  E0 16                CPX #$16       ; DIRLEN-2
 F5AE  F0 0A                BEQ <A HREF="#F5BA">iF5BA</A>     
 F5B0  C9 0A                CMP #$0A      
 F5B2  90 06                BCC <A HREF="#F5BA">iF5BA</A>     
 F5B4  CA                   DEX <A HREF="#F5BA"></A>          
 F5B5  C9 64                CMP #$64      
 F5B7  90 01                BCC <A HREF="#F5BA">iF5BA</A>     
 F5B9  CA                   DEX <A HREF="#F5BA"></A>          
 F5BA  20 23 F6  <A NAME="F5BA">iF5BA</A>      JSR <A HREF="#F623">BLKNB</A>      ; CLEAR NAME BUFFER
 F5BD  B1 93                LDA (DIRBUF),Y ; SEt TYPE CHARS
 F5BF  48                   PHA           
 F5C0  0A                   ASL            ; (USED IN BCS)
 F5C1  68                   PLA           
 F5C2  29 0F                AND #$0F      
 F5C4  A8                   TAY           
 F5C5  B9 39 E0             LDA <A HREF="#E039">TP2LST,Y</A>  
 F5C8  9D B4 42             STA NAMBUF,X  
 F5CB  CA                   DEX           
 F5CC  B9 35 E0             LDA <A HREF="#E035">TP1LST,Y</A>  
 F5CF  9D B4 42             STA NAMBUF,X  
 F5D2  CA                   DEX           
 F5D3  B9 31 E0             LDA <A HREF="#E031">TYPLST,Y</A>  
 F5D6  9D B4 42             STA NAMBUF,X  
 F5D9  CA                   DEX           
 F5DA  CA                   DEX           
 F5DB  B0 05                BCS <A HREF="#F5E2">iF5E2</A>      ; (FROM ASL)
 F5DD  A9 2A                LDA #$2A       ; "*"; FILE NOT CLOSED
 F5DF  9D B5 42             STA NAMBUF+1,X
 F5E2  A9 A0     <A NAME="F5E2">iF5E2</A>      LDA #$A0      
 F5E4  9D B4 42             STA NAMBUF,X  
 F5E7  CA                   DEX           
 F5E8  A0 12                LDY #$12      
 F5EA  B1 93     <A NAME="F5EA">iF5EA</A>      LDA (DIRBUF),Y
 F5EC  9D B4 42             STA NAMBUF,X  
 F5EF  CA                   DEX           
 F5F0  88                   DEY           
 F5F1  C0 03                CPY #$03      
 F5F3  B0 F5                BCS <A HREF="#F5EA">iF5EA</A>     
 F5F5  A9 22                LDA #$22       ; '"' SEND NAME IN QUOTES
 F5F7  9D B4 42             STA NAMBUF,X  
 F5FA  E8        <A NAME="F5FA">iF5FA</A>      INX           
 F5FB  E0 20                CPX #$20      
 F5FD  B0 0B                BCS <A HREF="#F60A">iF60A</A>     
 F5FF  BD B4 42             LDA NAMBUF,X  
 F602  C9 22                CMP #$22       ; '"'
 F604  F0 04                BEQ <A HREF="#F60A">iF60A</A>     
 F606  C9 A0                CMP #$A0      
 F608  D0 F0                BNE <A HREF="#F5FA">iF5FA</A>     
 F60A  A9 22     <A NAME="F60A">iF60A</A>      LDA #$22       ; '"'
 F60C  9D B4 42             STA NAMBUF,X  
 F60F  E8        <A NAME="F60F">iF60F</A>      INX           
 F610  E0 20                CPX #$20      
 F612  B0 0A                BCS <A HREF="#F61E">iF61E</A>     
 F614  A9 7F                LDA #$7F      
 F616  3D B4 42             AND NAMBUF,X  
 F619  9D B4 42             STA NAMBUF,X  
 F61C  10 F1                BPL <A HREF="#F60F">iF60F</A>     
 F61E  20 F5 F2  <A NAME="F61E">iF61E</A>      JSR <A HREF="#F2F5">FNDFIL</A>    
 F621  38                   SEC <A HREF="#F2F5"></A>          
 F622  60        <A NAME="F622">iF622</A>      RTS <A HREF="#F2F5"></A>          

 F623  A0 1B     <A NAME="F623">BLKNB</A>      LDY #$1B       ; BLANK NAMBUF
 F625  A9 20                LDA #$20      
 F627  99 B3 42  <A NAME="F627">iF627</A>      STA NAMBUF-1,Y
 F62A  88                   DEY           
 F62B  D0 FA                BNE <A HREF="#F627">iF627</A>     
 F62D  60                   RTS <A HREF="#F627"></A>          

; NEW DIRECTORY IN LISTING

 F62E  20 23 F6  <A NAME="F62E">NEWDIR</A>     JSR <A HREF="#F623">BLKNB</A>     
 F631  A9 FF                LDA #$FF      
 F633  85 2A                STA TEMP      
 F635  A6 80                LDX DRVNUM    
 F637  BD 40 E5             LDA <A HREF="#E540">IPBM,X</A>    
 F63A  85 94                STA DIRBUF+1  
 F63C  A9 90                LDA #$90      
 F63E  85 93                STA DIRBUF    
 F640  A0 15                LDY #$15      
 F642  B1 93     <A NAME="F642">iF642</A>      LDA (DIRBUF),Y ; the 4040 adds version check here (write out "1" when no version on disk)
 F644  99 B6 42             STA NAMBUF+2,Y
 F647  88                   DEY           
 F648  10 F8                BPL <A HREF="#F642">iF642</A>     
 F64A  A9 12                LDA #$12      
 F64C  8D B4 42             STA NAMBUF    
 F64F  A9 22                LDA #$22      
 F651  8D B5 42             STA NAMBUF+1  
 F654  8D C6 42             STA NAMBUF+18 
 F657  A9 20                LDA #$20      
 F659  8D C7 42             STA NAMBUF+19 
 F65C  60                   RTS           

 F65D  20 23 F6  <A NAME="F65D">MSGFRE</A>     JSR <A HREF="#F623">BLKNB</A>     
 F660  A0 0B                LDY #$0B       ; MSGLEN-1
 F662  B9 6E F6  <A NAME="F662">iF662</A>      LDA <A HREF="#F66E">FREMSG,Y</A>  
 F665  99 B4 42             STA NAMBUF,Y  
 F668  88                   DEY           
 F669  10 F7                BPL <A HREF="#F662">iF662</A>     
 F66B  4C 0A F0             JMP <A HREF="#F00A">NUMFRE</A>    


; blocks free message

 F66E  <A NAME="F66E">FREMSG</A>     .byte $42, $4C, $4F, $43, $4B, $53, $20, $46  ;blocks f
 F676             .byte $52, $45, $45, $2E                      ;ree.

; TODO


 F67A  A5 84     <A NAME="F67A">iF67A</A>      LDA SA        
 F67C  C9 0F                CMP #$0F      
 F67E  D0 06                BNE <A HREF="#F686">iF686</A>     
 F680  20 C2 EB             JSR <A HREF="#EBC2">CLRCHN</A>    
 F683  4C 44 F0             JMP <A HREF="#F044">PARSXQ</A>    
 F686  85 86     <A NAME="F686">iF686</A>      STA x86       
 F688  20 59 F1             JSR <A HREF="#F159">CMDSET</A>    
 F68B  86 96                STX CMDNUM    
 F68D  A6 00                LDX CMDBUF    
 F68F  A5 86                LDA x86       
 F691  D0 26                BNE <A HREF="#F6B9">iF6B9</A>     
 F693  E0 2A                CPX #$2A      
 F695  D0 22                BNE <A HREF="#F6B9">iF6B9</A>     
 F697  A5 7F                LDA x7F       
 F699  F0 45                BEQ <A HREF="#F6E0">iF6E0</A>     
 F69B  4A                   LSR <A HREF="#F6E0"></A>          
 F69C  85 81                STA TRACK     
 F69E  A9 00                LDA #$00      
 F6A0  2A                   ROL           
 F6A1  85 80                STA DRVNUM    
 F6A3  09 04                ORA #$04      
 F6A5  85 A7                STA FILDAT    
 F6A7  AD EA 10             LDA x10EA     
 F6AA  85 82                STA SECTOR    
 F6AC  20 72 EA             JSR <A HREF="#EA72">OPNRCH</A>    
 F6AF  A5 A7                LDA FILDAT    
 F6B1  A6 83     <A NAME="F6B1">iF6B1</A>      LDX LINDX     
 F6B3  99 B6 00             STA FILTYP,Y  
 F6B6  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    
 F6B9  E0 24     <A NAME="F6B9">iF6B9</A>      CPX #$24      
 F6BB  D0 1C                BNE <A HREF="#F6D9">iF6D9</A>     
 F6BD  A5 86                LDA x86       
 F6BF  D0 03                BNE <A HREF="#F6C4">iF6C4</A>     
 F6C1  4C 51 F8             JMP <A HREF="#F851">iF851</A>     
 F6C4  20 99 F0  <A NAME="F6C4">iF6C4</A>      JSR <A HREF="#F099">SIMPRS</A>    
 F6C7  A9 12                LDA #$12      
 F6C9  85 81                STA TRACK     
 F6CB  A9 00                LDA #$00      
 F6CD  85 82                STA SECTOR    
 F6CF  20 72 EA             JSR <A HREF="#EA72">OPNRCH</A>    
 F6D2  A5 80                LDA DRVNUM    
 F6D4  09 02                ORA #$02      
 F6D6  4C B1 F6             JMP <A HREF="#F6B1">iF6B1</A>     
 F6D9  E0 23     <A NAME="F6D9">iF6D9</A>      CPX #$23      
 F6DB  D0 0A                BNE <A HREF="#F6E7">iF6E7</A>     
 F6DD  4C 6A FD             JMP <A HREF="#FD6A">OPNBLK</A>    
 F6E0  A9 04     <A NAME="F6E0">iF6E0</A>      LDA #$04      
 F6E2  85 DA                STA TYPFLG    
 F6E4  20 C1 E8             JSR <A HREF="#E8C1">INITDR</A>    
 F6E7  A2 00     <A NAME="F6E7">iF6E7</A>      LDX #$00      
 F6E9  A9 3A                LDA #$3A      
 F6EB  20 17 F1             JSR <A HREF="#F117">PARSE</A>     
 F6EE  F0 0C                BEQ <A HREF="#F6FC">iF6FC</A>     
 F6F0  8A                   TXA <A HREF="#F6FC"></A>          
 F6F1  F0 05                BEQ <A HREF="#F6F8">iF6F8</A>     
 F6F3  A9 30                LDA #$30      
 F6F5  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F6F8  88        <A NAME="F6F8">iF6F8</A>      DEY <A HREF="#F090"></A>          
 F6F9  F0 01                BEQ <A HREF="#F6FC">iF6FC</A>     
 F6FB  88                   DEY <A HREF="#F6FC"></A>          
 F6FC  84 9D     <A NAME="F6FC">iF6FC</A>      STY FILTBL    
 F6FE  A9 8D                LDA #$8D      
 F700  20 17 F1             JSR <A HREF="#F117">PARSE</A>     
 F703  E8                   INX <A HREF="#F117"></A>          
 F704  86 9A                STX R0        
 F706  20 A3 F1             JSR <A HREF="#F1A3">ONEDRV</A>    
 F709  20 4A F2             JSR <A HREF="#F24A">OPTSCH</A>    
 F70C  20 E1 F2             JSR <A HREF="#F2E1">FFST</A>      
 F70F  A6 86                LDX x86       
 F711  86 84                STX SA        
 F713  E0 02                CPX #$02      
 F715  B0 0C                BCS <A HREF="#F723">iF723</A>     
 F717  A9 02                LDA #$02      
 F719  85 DC                STA xDC       
 F71B  86 DB                STX xDB       
 F71D  8A                   TXA           
 F71E  D0 3D                BNE <A HREF="#F75D">iF75D</A>     
 F720  4C C9 F7             JMP <A HREF="#F7C9">iF7C9</A>     
 F723  A2 00     <A NAME="F723">iF723</A>      LDX #$00      
 F725  86 DB                STX xDB       
 F727  E8                   INX           
 F728  86 DC                STX xDC       
 F72A  E4 99                CPX F1CNT     
 F72C  B0 2B                BCS <A HREF="#F759">iF759</A>     
 F72E  B5 9D                LDA FILTBL,X  
 F730  A8                   TAY           
 F731  B9 00 00             LDA CMDBUF,Y  
 F734  A0 03                LDY #$03      
 F736  D9 31 E0  <A NAME="F736">iF736</A>      CMP <A HREF="#E031">TYPLST,Y</A>  
 F739  F0 04                BEQ <A HREF="#F73F">iF73F</A>     
 F73B  88                   DEY <A HREF="#F73F"></A>          
 F73C  D0 F8                BNE <A HREF="#F736">iF736</A>     
 F73E  C8                   INY <A HREF="#F736"></A>          
 F73F  84 DC     <A NAME="F73F">iF73F</A>      STY xDC       
 F741  E8                   INX           
 F742  E4 99                CPX F1CNT     
 F744  B0 13                BCS <A HREF="#F759">iF759</A>     
 F746  B5 9D                LDA FILTBL,X  
 F748  A8                   TAY           
 F749  B9 00 00             LDA CMDBUF,Y  
 F74C  A0 02                LDY #$02      
 F74E  D9 2E E0  <A NAME="F74E">iF74E</A>      CMP <A HREF="#E02E">MODLST,Y</A>  
 F751  F0 04                BEQ <A HREF="#F757">iF757</A>     
 F753  88                   DEY <A HREF="#F757"></A>          
 F754  10 F8                BPL <A HREF="#F74E">iF74E</A>     
 F756  C8                   INY <A HREF="#F74E"></A>          
 F757  84 DB     <A NAME="F757">iF757</A>      STY xDB       
 F759  A6 DB     <A NAME="F759">iF759</A>      LDX xDB       
 F75B  F0 6C                BEQ <A HREF="#F7C9">iF7C9</A>     
 F75D  A5 CE     <A NAME="F75D">iF75D</A>      LDA PATFLG    
 F75F  F0 05                BEQ <A HREF="#F766">iF766</A>     
 F761  A9 33                LDA #$33      
 F763  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F766  A9 20     <A NAME="F766">iF766</A>      LDA #$20      
 F768  24 A7                BIT FILDAT    
 F76A  F0 0C                BEQ <A HREF="#F778">iF778</A>     
 F76C  A5 DB                LDA xDB       
 F76E  C9 02                CMP #$02      
 F770  F0 6D                BEQ <A HREF="#F7DF">iF7DF</A>     
 F772  20 DE F9             JSR <A HREF="#F9DE">DELDIR</A>    
 F775  4C 0F F8             JMP <A HREF="#F80F">iF80F</A>     
 F778  A5 AC     <A NAME="F778">iF778</A>      LDA FILTRK    
 F77A  29 3F                AND #$3F      
 F77C  D0 03                BNE <A HREF="#F781">iF781</A>     
 F77E  4C 0F F8             JMP <A HREF="#F80F">iF80F</A>     
 F781  A5 00     <A NAME="F781">iF781</A>      LDA CMDBUF    
 F783  C9 40                CMP #$40      
 F785  F0 05                BEQ <A HREF="#F78C">iF78C</A>     
 F787  A9 63                LDA #$63      
 F789  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F78C  A5 A7     <A NAME="F78C">iF78C</A>      LDA FILDAT    
 F78E  29 1F                AND #$1F      
 F790  48                   PHA           
 F791  4A                   LSR           
 F792  C5 DC                CMP xDC       
 F794  D0 52                BNE <A HREF="#F7E8">iF7E8</A>     
 F796  20 CE EA             JSR <A HREF="#EACE">OPNWCH</A>    
 F799  A5 83                LDA LINDX     
 F79B  8D EB 10             STA x10EB     
 F79E  A9 10                LDA #$10      
 F7A0  85 84                STA SA        
 F7A2  20 B0 E9             JSR <A HREF="#E9B0">FNDRCH</A>    
 F7A5  A5 D8                LDA INDEX     
 F7A7  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 F7AA  A0 1A                LDY #$1A      
 F7AC  A5 81                LDA TRACK     
 F7AE  91 93                STA (DIRBUF),Y
 F7B0  C8                   INY           
 F7B1  A5 82                LDA SECTOR    
 F7B3  91 93                STA (DIRBUF),Y
 F7B5  A5 A2                LDA FILENT    
 F7B7  AE EB 10             LDX x10EB     
 F7BA  9D E1 10             STA CHNDAT+8,X
 F7BD  68                   PLA           
 F7BE  95 B6                STA FILTYP,X  
 F7C0  20 06 EE             JSR <A HREF="#EE06">CURBLK</A>    
 F7C3  20 21 EE             JSR <A HREF="#EE21">DRTWRT</A>    
 F7C6  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    
 F7C9  A5 AC     <A NAME="F7C9">iF7C9</A>      LDA FILTRK    
 F7CB  29 3F                AND #$3F      
 F7CD  D0 05                BNE <A HREF="#F7D4">iF7D4</A>     
 F7CF  A9 62                LDA #$62      
 F7D1  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F7D4  A9 20     <A NAME="F7D4">iF7D4</A>      LDA #$20      
 F7D6  24 A7                BIT FILDAT    
 F7D8  F0 05                BEQ <A HREF="#F7DF">iF7DF</A>     
 F7DA  A9 60                LDA #$60      
 F7DC  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F7DF  A5 A7     <A NAME="F7DF">iF7DF</A>      LDA FILDAT    
 F7E1  4A                   LSR           
 F7E2  29 0F                AND #$0F      
 F7E4  C5 DC                CMP xDC       
 F7E6  F0 05                BEQ <A HREF="#F7ED">iF7ED</A>     
 F7E8  A9 64     <A NAME="F7E8">iF7E8</A>      LDA #$64      
 F7EA  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F7ED  A5 AC     <A NAME="F7ED">iF7ED</A>      LDA FILTRK    
 F7EF  29 3F                AND #$3F      
 F7F1  85 81                STA TRACK     
 F7F3  85 2E                STA TEMP+4    
 F7F5  A5 B1                LDA FILSEC    
 F7F7  85 82                STA SECTOR    
 F7F9  85 2F                STA TEMP+5    
 F7FB  20 72 EA             JSR <A HREF="#EA72">OPNRCH</A>    
 F7FE  A4 83                LDY LINDX     
 F800  A5 A2                LDA FILENT    
 F802  99 E1 10             STA CHNDAT+8,Y
 F805  A5 A7                LDA FILDAT    
 F807  29 1F                AND #$1F      
 F809  99 B6 00             STA FILTYP,Y  
 F80C  4C 3B F8             JMP <A HREF="#F83B">iF83B</A>     

 F80F  20 CE EA  <A NAME="F80F">iF80F</A>      JSR <A HREF="#EACE">OPNWCH</A>    
 F812  A5 81                LDA TRACK     
 F814  48                   PHA           
 F815  A5 82                LDA SECTOR    
 F817  48                   PHA           
 F818  20 82 F4             JSR <A HREF="#F482">iF482</A>     
 F81B  A6 83                LDX LINDX     
 F81D  A5 D5                LDA DELSEC    
 F81F  29 1F                AND #$1F      
 F821  9D E1 10             STA CHNDAT+8,X
 F824  A5 D6                LDA DELIND    
 F826  29 E0                AND #$E0      
 F828  1D E1 10             ORA CHNDAT+8,X
 F82B  9D E1 10             STA CHNDAT+8,X
 F82E  A5 DC                LDA xDC       
 F830  0A                   ASL           
 F831  05 80                ORA DRVNUM    
 F833  95 B6                STA FILTYP,X  
 F835  68                   PLA           
 F836  85 2F                STA TEMP+5    
 F838  68                   PLA           
 F839  85 2E                STA TEMP+4    
 F83B  A6 86     <A NAME="F83B">iF83B</A>      LDX x86       
 F83D  CA                   DEX           
 F83E  CA                   DEX           
 F83F  10 0D                BPL <A HREF="#F84E">iF84E</A>     
 F841  A5 80                LDA DRVNUM    
 F843  4A                   LSR           
 F844  A5 2E                LDA TEMP+4    
 F846  2A                   ROL           
 F847  85 7F                STA x7F       
 F849  A5 2F                LDA TEMP+5    
 F84B  8D EA 10             STA x10EA     
 F84E  4C 75 F0  <A NAME="F84E">iF84E</A>      JMP <A HREF="#F075">ENDCMD</A>    

 F851  A9 08     <A NAME="F851">iF851</A>      LDA #$08      
 F853  85 96                STA CMDNUM    
 F855  A6 95                LDX CMDSIZ    
 F857  CA                   DEX           
 F858  D0 12                BNE <A HREF="#F86C">iF86C</A>     
 F85A  A9 2A                LDA #$2A      
 F85C  85 00                STA CMDBUF    
 F85E  A9 80                LDA #$80      
 F860  85 AC                STA FILTRK    
 F862  05 D2                ORA LSTDRV    
 F864  85 A7                STA FILDAT    
 F866  E6 99                INC F1CNT     
 F868  E6 9A                INC R0        
 F86A  D0 3B                BNE <A HREF="#F8A7">iF8A7</A>     
 F86C  CA        <A NAME="F86C">iF86C</A>      DEX <A HREF="#F8A7"></A>          
 F86D  D0 1B                BNE <A HREF="#F88A">iF88A</A>     
 F86F  A5 01                LDA CMDBUF+1  
 F871  20 3D F2             JSR <A HREF="#F23D">TST0V1</A>    
 F874  30 14                BMI <A HREF="#F88A">iF88A</A>     
 F876  29 01                AND #$01      
 F878  85 A7                STA FILDAT    
 F87A  E6 99                INC F1CNT     
 F87C  E6 9A                INC R0        
 F87E  E6 9D                INC FILTBL    
 F880  A9 80                LDA #$80      
 F882  85 AC                STA FILTRK    
 F884  A9 2A                LDA #$2A      
 F886  85 01                STA CMDBUF+1  
 F888  D0 1D                BNE <A HREF="#F8A7">iF8A7</A>     
 F88A  A2 00     <A NAME="F88A">iF88A</A>      LDX #$00      
 F88C  A9 3A                LDA #$3A      
 F88E  20 17 F1             JSR <A HREF="#F117">PARSE</A>     
 F891  D0 07                BNE <A HREF="#F89A">iF89A</A>     
 F893  A0 00                LDY #$00      
 F895  20 81 F1             JSR <A HREF="#F181">iF181</A>     
 F898  A0 03                LDY #$03      
 F89A  88        <A NAME="F89A">iF89A</A>      DEY           
 F89B  88                   DEY           
 F89C  84 9D                STY FILTBL    
 F89E  20 C2 F0             JSR <A HREF="#F0C2">iF0C2</A>     
 F8A1  20 1B F2             JSR <A HREF="#F21B">FS1SET</A>    
 F8A4  20 AD F1             JSR <A HREF="#F1AD">ALLDRS</A>    
 F8A7  20 4A F2  <A NAME="F8A7">iF8A7</A>      JSR <A HREF="#F24A">OPTSCH</A>    
 F8AA  20 2E F6             JSR <A HREF="#F62E">NEWDIR</A>    
 F8AD  20 E1 F2             JSR <A HREF="#F2E1">FFST</A>      
 F8B0  20 28 EF             JSR <A HREF="#EF28">iEF28</A>     
 F8B3  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 F8B6  A6 83                LDX LINDX     
 F8B8  9D D9 10             STA CHNDAT,X  
 F8BB  A5 80                LDA DRVNUM    
 F8BD  85 D2                STA LSTDRV    
 F8BF  09 04                ORA #$04      
 F8C1  95 B6                STA FILTYP,X  
 F8C3  A9 00                LDA #$00      
 F8C5  85 5B                STA x5B       
 F8C7  60                   RTS           

; NEW: INITIALIZE A DISK, DISK IS
; SOFT-SECTORED, BIT AVAIL. MAP,
; DIRECTORY, &amp; 1ST BLOCK ARE ALL INITED

 F8C8  20 A3 F1  <A NAME="F8C8">NEW</A>        JSR <A HREF="#F1A3">ONEDRV</A>    
 F8CB  A5 A7                LDA FILDAT     ; SET UP DRIVE#
 F8CD  10 05                BPL <A HREF="#F8D4">iF8D4</A>     
 F8CF  A9 33                LDA #$33       ; BADFN
 F8D1  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F8D4  29 01     <A NAME="F8D4">iF8D4</A>      AND #$01      
 F8D6  85 80                STA DRVNUM    
 F8D8  0A                   ASL           
 F8D9  AA                   TAX           
 F8DA  20 0A EF             JSR <A HREF="#EF0A">SETLDS</A>    
 F8DD  A4 9E                LDY FILTBL+1   ; GET DISK ID
 F8DF  C4 95                CPY CMDSIZ     ; IS THIS NEW OR CLEAR?
 F8E1  F0 13                BEQ <A HREF="#F8F6">iF8F6</A>      ; END OF CMD STRING
 F8E3  B9 00 00             LDA CMDBUF,Y  
 F8E6  95 8E                STA DISKID,X   ; STORE IN PROPER DRIVE
 F8E8  B9 01 00             LDA CMDBUF+1,Y ; (Y=0)
 F8EB  95 8F                STA DISKID+1,X
 F8ED  A9 01                LDA #$01       ; ...IN TRACK, TRACK=1
 F8EF  85 81                STA TRACK     
 F8F1  20 14 FB             JSR <A HREF="#FB14">FORMAT</A>     ; TRANSFER FORMAT TO RAM
 F8F4  F0 03                BEQ <A HREF="#F8F9">iF8F9</A>     
 F8F6  20 C1 E8  <A NAME="F8F6">iF8F6</A>      JSR <A HREF="#E8C1">INITDR</A>    
 F8F9  A6 80     <A NAME="F8F9">iF8F9</A>      LDX DRVNUM    
 F8FB  BD 40 E5             LDA <A HREF="#E540">IPBM,X</A>     ; load high byte of buffer for drive, either $4200 or $4300?
 F8FE  85 31                STA IP+1      
 F900  A9 00                LDA #$00      
 F902  85 30                STA IP        
 F904  A8                   TAY           
 F905  91 30     <A NAME="F905">iF905</A>      STA (IP),Y     ; clear buffer
 F907  C8                   INY           
 F908  D0 FB                BNE <A HREF="#F905">iF905</A>     
 F90A  8A                   TXA <A HREF="#F905"></A>           ; X contains the drive
 F90B  18                   CLC <A HREF="#F905"></A>          
 F90C  69 0D                ADC #$0D       ; BAMJOB, BUF#13 + DRVNUM
 F90E  85 8D                STA JOBNUM     ; either 13 or 14 (dezimal)
 F910  0A                   ASL           
 F911  AA                   TAX            ; either 26 or 28 (dezimal) = $1a or $1c
 F912  A9 90                LDA #$90      
 F914  95 3D                STA BUFTAB,X   ; store either into $57 or $59
 F916  A9 04                LDA #$04      
 F918  85 82                STA SECTOR    
 F91A  A9 12                LDA #$12       ; directory track (18)
 F91C  85 81                STA TRACK     
 F91E  20 21 EE  <A NAME="F91E">iF91E</A>      JSR <A HREF="#EE21">DRTWRT</A>     ; loop over directory starting with SECTOR=4 until SECTOR contains #1
 F921  A5 82                LDA SECTOR     ; write each sector with interleave of 3
 F923  18                   CLC           
 F924  69 03                ADC #$03       ; secs 4,7,10,13,16,19,22, 3,6,9,12,15,18,21, 2,5,8,11,14,17,20
 F926  85 82                STA SECTOR    
 F928  C9 14                CMP #$14      
 F92A  90 F2                BCC <A HREF="#F91E">iF91E</A>     
 F92C  E9 13                SBC #$13      
 F92E  85 82                STA SECTOR    
 F930  AA                   TAX           
 F931  CA                   DEX           
 F932  D0 EA                BNE <A HREF="#F91E">iF91E</A>     
 F934  A0 01                LDY #$01       ; end of loop, SECTOR contains $01
 F936  A9 FF                LDA #$FF      
 F938  91 30                STA (IP),Y     ; end of file marker (followup sector in second byte in sector  = $ff)
 F93A  20 21 EE             JSR <A HREF="#EE21">DRTWRT</A>     ; CLEAR DIRECTORY (write t=18/s=1)
 F93D  C6 82                DEC SECTOR     ; move pointer to BAM block
 F93F  20 AC FC             JSR <A HREF="#FCAC">iFCAC</A>     
 F942  A0 48                LDY #$48      
 F944  A9 12                LDA #$12      
 F946  91 30                STA (IP),Y    
 F948  C8                   INY           
 F949  A9 FC                LDA #$FC      
 F94B  91 30                STA (IP),Y    
 F94D  A4 8D                LDY JOBNUM    
 F94F  A6 9D                LDX FILTBL    
 F951  A9 1B                LDA #$1B      
 F953  20 4D F4             JSR <A HREF="#F44D">TRNAME</A>     ; TRANSFER CMD BUF TO BUF0
 F956  A0 12                LDY #$12      
 F958  A5 80                LDA DRVNUM     ; SET UP CURRENT I.D.
 F95A  0A                   ASL           
 F95B  AA                   TAX           
 F95C  B5 8E                LDA DISKID,X  
 F95E  91 93                STA (DIRBUF),Y
 F960  C8                   INY           
 F961  B5 8F                LDA DISKID+1,X
 F963  91 93                STA (DIRBUF),Y
 F965  C8                   INY           
 F966  A9 20                LDA #$20       ; add two spaces. Newer versions add "DOSVER+$30" and "VERNUM" -&gt; "2A"
 F968  91 93                STA (DIRBUF),Y
 F96A  C8                   INY           
 F96B  91 93                STA (DIRBUF),Y
 F96D  20 21 EE             JSR <A HREF="#EE21">DRTWRT</A>     ; WRITE IT OUT
 F970  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; SCRATCH FILE(S)

 F973  20 1B F2  <A NAME="F973">SCRTCH</A>     JSR <A HREF="#F21B">FS1SET</A>     ; SET UP FOR 1 STREAM
 F976  20 AD F1             JSR <A HREF="#F1AD">ALLDRS</A>    
 F979  20 4A F2             JSR <A HREF="#F24A">OPTSCH</A>    
 F97C  A9 00                LDA #$00      
 F97E  8D EB 10             STA x10EB     
 F981  20 E1 F2             JSR <A HREF="#F2E1">FFST</A>      
 F984  30 22                BMI <A HREF="#F9A8">iF9A8</A>     
 F986  20 DE F9  <A NAME="F986">iF986</A>      JSR <A HREF="#F9DE">DELDIR</A>     ; DELETE DIRECTORY; in 4040 before this a test for active file is inserted
 F989  A6 37                LDX ENTFND     ; in 4040 before this a REL-file test is inserted
 F98B  A9 20                LDA #$20      
 F98D  35 A7                AND FILDAT,X  
 F98F  D0 0F                BNE <A HREF="#F9A0">iF9A0</A>      ; CREATED, NOT CLOSED
 F991  A6 37                LDX ENTFND     ; no needed
 F993  B5 AC                LDA FILTRK,X   ; DELETE BY LINKS
 F995  29 7F                AND #$7F      
 F997  85 81                STA TRACK     
 F999  B5 B1                LDA FILSEC,X  
 F99B  85 82                STA SECTOR    
 F99D  20 B6 F9             JSR <A HREF="#F9B6">DELFIL</A>    
 F9A0  EE EB 10  <A NAME="F9A0">iF9A0</A>      INC x10EB     
 F9A3  20 D0 F2             JSR <A HREF="#F2D0">FFRE</A>      
 F9A6  10 DE                BPL <A HREF="#F986">iF986</A>     
 F9A8  AD EB 10  <A NAME="F9A8">iF9A8</A>      LDA x10EB      ; FINISHED SET
 F9AB  85 81                STA TRACK      ; FILE COUNT
 F9AD  A9 01                LDA #$01      
 F9AF  A0 00                LDY #$00      
 F9B1  84 82                STY SECTOR    
 F9B3  4C 7A F0             JMP <A HREF="#F07A">SCREND</A>     ; END OF SCRATCH

 F9B6  20 DD EE  <A NAME="F9B6">DELFIL</A>     JSR <A HREF="#EEDD">FRETS</A>      ; DELETE FILE BY LINKS
 F9B9  20 36 EE             JSR <A HREF="#EE36">OPNIRD</A>     ; UPDATE BAM
 F9BC  A9 00     <A NAME="F9BC">DEL2</A>       LDA #$00      
 F9BE  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 F9C1  20 F3 E9             JSR <A HREF="#E9F3">RDBYT</A>     
 F9C4  85 81                STA TRACK     
 F9C6  20 F3 E9             JSR <A HREF="#E9F3">RDBYT</A>     
 F9C9  85 82                STA SECTOR    
 F9CB  A5 81                LDA TRACK     
 F9CD  D0 06                BNE <A HREF="#F9D5">iF9D5</A>     
 F9CF  20 87 EC             JSR <A HREF="#EC87">MAPOUT</A>    
 F9D2  4C 32 EB             JMP <A HREF="#EB32">FRECHN</A>    
 F9D5  20 DD EE  <A NAME="F9D5">iF9D5</A>      JSR <A HREF="#EEDD">FRETS</A>     
 F9D8  20 F3 ED             JSR <A HREF="#EDF3">NXTBUF</A>    
 F9DB  4C BC F9             JMP <A HREF="#F9BC">DEL2</A>      

 F9DE  A0 00     <A NAME="F9DE">DELDIR</A>     LDY #$00      
 F9E0  98                   TYA           
 F9E1  91 93                STA (DIRBUF),Y
 F9E3  C8                   INY           
 F9E4  91 93                STA (DIRBUF),Y
 F9E6  88                   DEY           
 F9E7  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 F9EA  4C 21 EE             JMP <A HREF="#EE21">DRTWRT</A>    

; DUPLICATE DISK

 F9ED  A9 3D     <A NAME="F9ED">DUPLCT</A>     LDA #$3D       ; "=" SPECIAL CASE 
 F9EF  20 17 F1             JSR <A HREF="#F117">PARSE</A>     
 F9F2  D0 05                BNE <A HREF="#F9F9">iF9F9</A>     
 F9F4  A9 30     <A NAME="F9F4">iF9F4</A>      LDA #$30      
 F9F6  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 F9F9  B9 00 00  <A NAME="F9F9">iF9F9</A>      LDA CMDBUF,Y  
 F9FC  20 3D F2             JSR <A HREF="#F23D">TST0V1</A>    
 F9FF  30 F3                BMI <A HREF="#F9F4">iF9F4</A>     
 FA01  AA                   TAX <A HREF="#F9F4"></A>          
 FA02  88                   DEY <A HREF="#F9F4"></A>          
 FA03  88                   DEY <A HREF="#F9F4"></A>          
 FA04  B9 00 00             LDA CMDBUF,Y  
 FA07  20 3D F2             JSR <A HREF="#F23D">TST0V1</A>    
 FA0A  30 E8                BMI <A HREF="#F9F4">iF9F4</A>     
 FA0C  49 01                EOR #$01      
 FA0E  85 80                STA DRVNUM    
 FA10  A9 18                LDA #$18       ; LED0+LED1
 FA12  0D 82 02             ORA RIOT2PBD  
 FA15  8D 82 02             STA RIOT2PBD  
 FA18  20 C1 E8             JSR <A HREF="#E8C1">INITDR</A>     ; INIT SRC
 FA1B  A5 80                LDA DRVNUM    
 FA1D  49 01                EOR #$01      
 FA1F  85 80                STA DRVNUM    
 FA21  0A                   ASL           
 FA22  A8                   TAY           
 FA23  49 02                EOR #$02      
 FA25  AA                   TAX           
 FA26  B5 8E                LDA DISKID,X  
 FA28  99 8E 00             STA DISKID,Y  
 FA2B  B5 8F                LDA DISKID+1,X
 FA2D  99 8F 00             STA DISKID+1,Y
 FA30  A9 01                LDA #$01      
 FA32  85 81                STA TRACK     
 FA34  20 14 FB             JSR <A HREF="#FB14">FORMAT</A>     ; FORMAT DST DRIVE

; COPY BLOCKS FROM ONE DRIVE TO OTHER

 FA37  A5 81     <A NAME="FA37">CPYD1</A>      LDA TRACK     
 FA39  20 B1 E5             JSR <A HREF="#E5B1">MAXSEC</A>    
 FA3C  85 82                STA SECTOR    
 FA3E  C6 82                DEC SECTOR    
 FA40  20 51 FA             JSR <A HREF="#FA51">CPYTRK</A>     ; COPY ONE TRACK
 FA43  E6 81                INC TRACK     
 FA45  A5 81                LDA TRACK     
 FA47  C9 24                CMP #$24       ; MAXTRK
 FA49  D0 EC                BNE <A HREF="#FA37">CPYD1</A>     
 FA4B  20 C1 E8             JSR <A HREF="#E8C1">INITDR</A>    
 FA4E  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; COPY ONE TRACK

 FA51  20 62 FA  <A NAME="FA51">CPYTRK</A>     JSR <A HREF="#FA62">iFA62</A>     
 FA54  20 6D FA  <A NAME="FA54">iFA54</A>      JSR <A HREF="#FA6D">SETRH</A>     
 FA57  20 A0 FA             JSR <A HREF="#FAA0">READS</A>      ; READ 10 SECTORS
 FA5A  20 D8 FA             JSR <A HREF="#FAD8">WRITES</A>     ; WRITE 10 SECTORS
 FA5D  A5 82                LDA SECTOR    
 FA5F  10 F3                BPL <A HREF="#FA54">iFA54</A>     
 FA61  60                   RTS <A HREF="#FA54"></A>          

 FA62  A2 0A     <A NAME="FA62">iFA62</A>      LDX #$0A      
 FA64  A5 81                LDA TRACK     
 FA66  9D 12 10  <A NAME="FA66">iFA66</A>      STA x1012,X   
 FA69  CA                   DEX           
 FA6A  10 FA                BPL <A HREF="#FA66">iFA66</A>     
 FA6C  60                   RTS <A HREF="#FA66"></A>          

 FA6D  A5 80     <A NAME="FA6D">SETRH</A>      LDA DRVNUM    
 FA6F  49 01                EOR #$01      
 FA71  85 89                STA CMD       
 FA73  A9 0A                LDA #$0A      
 FA75  85 2C                STA TEMP+2    
 FA77  A5 2C     <A NAME="FA77">iFA77</A>      LDA TEMP+2     ; the 4040 has this up to fa95 in subroutine SETH
 FA79  0A                   ASL           
 FA7A  0A                   ASL           
 FA7B  0A                   ASL           
 FA7C  A8                   TAY           
 FA7D  A5 80                LDA DRVNUM    
 FA7F  0A                   ASL           
 FA80  AA                   TAX           
 FA81  B5 8E                LDA DISKID,X  
 FA83  99 21 10             STA HDRS,Y    
 FA86  B5 8F                LDA DISKID+1,X
 FA88  99 22 10             STA HDRS+1,Y  
 FA8B  A5 81                LDA TRACK     
 FA8D  99 23 10             STA HDRS+2,Y  
 FA90  A5 82                LDA SECTOR    
 FA92  99 24 10             STA HDRS+3,Y  
 FA95  C6 82                DEC SECTOR    
 FA97  30 06                BMI <A HREF="#FA9F">iFA9F</A>     
 FA99  C6 2C                DEC TEMP+2    
 FA9B  10 DA                BPL <A HREF="#FA77">iFA77</A>     
 FA9D  E6 2C                INC TEMP+2    
 FA9F  60        <A NAME="FA9F">iFA9F</A>      RTS           

; READ TEMP+2 BLOCKS IN

 FAA0  A5 89     <A NAME="FAA0">READS</A>      LDA CMD       
 FAA2  09 80                ORA #$80       ; READ
 FAA4  85 89                STA CMD       
 FAA6  A6 2C                LDX TEMP+2    
 FAA8  9D 03 10  <A NAME="FAA8">iFAA8</A>      STA JOBS,X    
 FAAB  E0 0A                CPX #$0A      
 FAAD  F0 03                BEQ <A HREF="#FAB2">iFAB2</A>     
 FAAF  E8                   INX <A HREF="#FAB2"></A>          
 FAB0  D0 F6                BNE <A HREF="#FAA8">iFAA8</A>     
 FAB2  A6 2C     <A NAME="FAB2">iFAB2</A>      LDX TEMP+2    
 FAB4  A0 0A                LDY #$0A      
 FAB6  BD 03 10  <A NAME="FAB6">iFAB6</A>      LDA JOBS,X    
 FAB9  30 FB                BMI <A HREF="#FAB6">iFAB6</A>     
 FABB  C9 04                CMP #$04      
 FABD  F0 11                BEQ <A HREF="#FAD0">iFAD0</A>     
 FABF  C9 01                CMP #$01      
 FAC1  F0 0D                BEQ <A HREF="#FAD0">iFAD0</A>     
 FAC3  88                   DEY <A HREF="#FAD0"></A>          
 FAC4  10 03                BPL <A HREF="#FAC9">iFAC9</A>     
 FAC6  4C B3 E6             JMP <A HREF="#E6B3">ERROR</A>     
 FAC9  A5 89     <A NAME="FAC9">iFAC9</A>      LDA CMD       
 FACB  9D 03 10             STA JOBS,X    
 FACE  30 E6                BMI <A HREF="#FAB6">iFAB6</A>     
 FAD0  E0 0A     <A NAME="FAD0">iFAD0</A>      CPX #$0A      
 FAD2  F0 03                BEQ <A HREF="#FAD7">iFAD7</A>     
 FAD4  E8                   INX <A HREF="#FAD7"></A>          
 FAD5  D0 DF                BNE <A HREF="#FAB6">iFAB6</A>     
 FAD7  60        <A NAME="FAD7">iFAD7</A>      RTS <A HREF="#FAB6"></A>          

; WRITE TEMP+2 BUFFERS OUT

 FAD8  A9 90     <A NAME="FAD8">WRITES</A>     LDA #$90       ; #WRITE
 FADA  05 80                ORA DRVNUM    
 FADC  85 89                STA CMD       
 FADE  A6 2C                LDX TEMP+2    
 FAE0  BC 03 10  <A NAME="FAE0">iFAE0</A>      LDY JOBS,X    
 FAE3  C0 04                CPY #$04      
 FAE5  D0 09                BNE <A HREF="#FAF0">iFAF0</A>     
 FAE7  A9 01                LDA #$01      
 FAE9  9D 03 10             STA JOBS,X    
 FAEC  A5 89                LDA CMD       
 FAEE  D0 03                BNE <A HREF="#FAF3">iFAF3</A>     
 FAF0  9D 03 10  <A NAME="FAF0">iFAF0</A>      STA JOBS,X    
 FAF3  E0 0A     <A NAME="FAF3">iFAF3</A>      CPX #$0A      
 FAF5  F0 03                BEQ <A HREF="#FAFA">iFAFA</A>     
 FAF7  E8                   INX <A HREF="#FAFA"></A>          
 FAF8  D0 E6                BNE <A HREF="#FAE0">iFAE0</A>     
 FAFA  A6 2C     <A NAME="FAFA">iFAFA</A>      LDX TEMP+2    
 FAFC  BD 03 10  <A NAME="FAFC">iFAFC</A>      LDA JOBS,X    
 FAFF  30 FB                BMI <A HREF="#FAFC">iFAFC</A>     
 FB01  C9 01                CMP #$01      
 FB03  F0 07                BEQ <A HREF="#FB0C">iFB0C</A>     
 FB05  A5 89                LDA CMD       
 FB07  9D 03 10             STA JOBS,X    
 FB0A  30 F0                BMI <A HREF="#FAFC">iFAFC</A>     
 FB0C  E0 0A     <A NAME="FB0C">iFB0C</A>      CPX #$0A      
 FB0E  F0 03                BEQ <A HREF="#FB13">iFB13</A>     
 FB10  E8                   INX <A HREF="#FB13"></A>          
 FB11  D0 E9                BNE <A HREF="#FAFC">iFAFC</A>     
 FB13  60        <A NAME="FB13">iFB13</A>      RTS <A HREF="#FAFC"></A>          

; TRANSFER FORMAT CODE TO BUFFER 0
; &amp; START CONTROLLER FORMATTING

 FB14  A0 00     <A NAME="FB14">FORMAT</A>     LDY #$00      
 FB16  B9 40 E0  <A NAME="FB16">iFB16</A>      LDA <A HREF="#E040">CODE,Y</A>    
 FB19  99 00 11             STA BUFS,Y    
 FB1C  B9 40 E1             LDA <A HREF="#E040">CODE+256,Y</A>
 FB1F  99 00 12             STA BUFS+256,Y
 FB22  C8                   INY           
 FB23  D0 F1                BNE <A HREF="#FB16">iFB16</A>     
 FB25  A9 00                LDA #$00      
 FB27  20 6B E8             JSR <A HREF="#E86B">SETH</A>      
 FB2A  A9 01                LDA #$01      
 FB2C  8D 12 10             STA x1012     
 FB2F  A5 80                LDA DRVNUM    
 FB31  09 E0                ORA #$E0       ; or with EXEC
 FB33  8D 03 10             STA JOBS      
 FB36  AD 03 10  <A NAME="FB36">iFB36</A>      LDA JOBS      
 FB39  30 FB                BMI <A HREF="#FB36">iFB36</A>     
 FB3B  C9 01                CMP #$01      
 FB3D  F0 07                BEQ <A HREF="#FB46">iFB46</A>     
 FB3F  A9 03                LDA #$03      
 FB41  A2 00                LDX #$00      
 FB43  4C B3 E6             JMP <A HREF="#E6B3">ERROR</A>     
 FB46  60        <A NAME="FB46">iFB46</A>      RTS <A HREF="#E6B3"></A>          

; DSKCPY CHECK FOR TYPE AND PARSES SPECIAL CASE

 FB47  20 AD F1  <A NAME="FB47">DSKCPY</A>     JSR <A HREF="#F1AD">ALLDRS</A>    
 FB4A  20 4A F2             JSR <A HREF="#F24A">OPTSCH</A>    
 FB4D  20 99 F2             JSR <A HREF="#F299">LOOKUP</A>    
 FB50  A5 A8                LDA FILDAT+1  
 FB52  4A                   LSR           
 FB53  29 0F                AND #$0F      
 FB55  85 DC                STA xDC       
 FB57  20 16 FC             JSR <A HREF="#FC16">CHKIO</A>     
 FB5A  A5 A7                LDA FILDAT    
 FB5C  29 01                AND #$01      
 FB5E  85 80                STA DRVNUM    
 FB60  A9 00                LDA #$00      
 FB62  85 9B                STA F1PTR     
 FB64  20 42 EE             JSR <A HREF="#EE42">iEE42</A>     
 FB67  20 82 F4             JSR <A HREF="#F482">iF482</A>     
 FB6A  A4 83                LDY LINDX     
 FB6C  8C EB 10             STY x10EB     
 FB6F  A6 9B                LDX F1PTR     
 FB71  B5 A2                LDA FILENT,X  
 FB73  99 E1 10             STA CHNDAT+8,Y
 FB76  A5 80                LDA DRVNUM    
 FB78  4A                   LSR           
 FB79  A5 DC                LDA xDC       
 FB7B  2A                   ROL           
 FB7C  99 B6 00             STA FILTYP,Y  
 FB7F  A6 99                LDX F1CNT     
 FB81  86 9C     <A NAME="FB81">iFB81</A>      STX F2PTR     
 FB83  B5 B1                LDA FILSEC,X  
 FB85  85 82                STA SECTOR    
 FB87  B5 AC                LDA FILTRK,X  
 FB89  29 3F                AND #$3F      
 FB8B  85 81                STA TRACK     
 FB8D  B5 A7                LDA FILDAT,X  
 FB8F  29 01                AND #$01      
 FB91  85 80                STA DRVNUM    
 FB93  20 36 EE             JSR <A HREF="#EE36">OPNIRD</A>    
 FB96  A5 83                LDA LINDX     
 FB98  8D EC 10             STA x10EC     
 FB9B  10 11                BPL <A HREF="#FBAE">iFBAE</A>     
 FB9D  AD EB 10  <A NAME="FB9D">iFB9D</A>      LDA x10EB     
 FBA0  85 83                STA LINDX     
 FBA2  68                   PLA           
 FBA3  20 35 EA             JSR <A HREF="#EA35">WRTBYT</A>    
 FBA6  20 0A EF             JSR <A HREF="#EF0A">SETLDS</A>    
 FBA9  AD EC 10             LDA x10EC     
 FBAC  85 83                STA LINDX     
 FBAE  20 F3 E9  <A NAME="FBAE">iFBAE</A>      JSR <A HREF="#E9F3">RDBYT</A>     
 FBB1  48                   PHA <A HREF="#E9F3"></A>          
 FBB2  20 0A EF             JSR <A HREF="#EF0A">SETLDS</A>    
 FBB5  A6 83                LDX LINDX     
 FBB7  B5 BE                LDA CHNRDY,X  
 FBB9  C9 80                CMP #$80      
 FBBB  D0 E0                BNE <A HREF="#FB9D">iFB9D</A>     
 FBBD  AD EB 10             LDA x10EB     
 FBC0  85 83                STA LINDX     
 FBC2  68                   PLA           
 FBC3  20 35 EA             JSR <A HREF="#EA35">WRTBYT</A>    
 FBC6  A6 9C                LDX F2PTR     
 FBC8  E8                   INX           
 FBC9  E4 9A                CPX R0        
 FBCB  90 B4                BCC <A HREF="#FB81">iFB81</A>     
 FBCD  20 0F EC             JSR <A HREF="#EC0F">CLOSE</A>     
 FBD0  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; RENAME FILE NAME IN DIRECTORY

 FBD3  20 AD F1  <A NAME="FBD3">RENAME</A>     JSR <A HREF="#F1AD">ALLDRS</A>     ; SET BOTH DRIVE #'S
 FBD6  A5 A8                LDA FILDAT+1  
 FBD8  29 01                AND #$01      
 FBDA  85 A8                STA FILDAT+1  
 FBDC  C5 A7                CMP FILDAT    
 FBDE  F0 02                BEQ <A HREF="#FBE2">iFBE2</A>      ; SAME DRIVE #'S
 FBE0  09 80                ORA #$80       ; CHECK BOTH DRIVES FOR NAME
 FBE2  85 A7     <A NAME="FBE2">iFBE2</A>      STA FILDAT    
 FBE4  20 4A F2             JSR <A HREF="#F24A">OPTSCH</A>    
 FBE7  20 99 F2             JSR <A HREF="#F299">LOOKUP</A>     ; LOOK UP BOTH NAMES
 FBEA  20 16 FC             JSR <A HREF="#FC16">CHKIO</A>      ; CHECK FOR EXISTENCE
 FBED  A5 A8                LDA FILDAT+1  
 FBEF  29 01                AND #$01      
 FBF1  85 80                STA DRVNUM    
 FBF3  A5 A3                LDA xA3       
 FBF5  48                   PHA           
 FBF6  29 1F                AND #$1F      
 FBF8  85 82                STA SECTOR    
 FBFA  20 1D EE             JSR <A HREF="#EE1D">DRTRD</A>      ; in 4040 different code with comment "POSIBLE BUG"
 FBFD  68                   PLA <A HREF="#EE1D"></A>          
 FBFE  29 E0                AND #$E0       ; SET SECTOR INDEX
 FC00  09 05                ORA #$05       ; ;+5
 FC02  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 FC05  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 FC08  A8                   TAY <A HREF="#E89D"></A>          
 FC09  A6 9D                LDX FILTBL    
 FC0B  A9 10                LDA #$10      
 FC0D  20 4D F4             JSR <A HREF="#F44D">TRNAME</A>     ; TRANSFER NAME
 FC10  20 21 EE             JSR <A HREF="#EE21">DRTWRT</A>     ; WRITE SECTOR OUT
 FC13  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; CHECK I/O FILE FOR EXIST
; this is different from 4040

 FC16  A6 9A     <A NAME="FC16">CHKIO</A>      LDX R0        
 FC18  CA        <A NAME="FC18">iFC18</A>      DEX           
 FC19  E4 99                CPX F1CNT     
 FC1B  90 0B                BCC <A HREF="#FC28">iFC28</A>     
 FC1D  B5 AC                LDA FILTRK,X  
 FC1F  29 7F                AND #$7F      
 FC21  D0 F5                BNE <A HREF="#FC18">iFC18</A>     
 FC23  A9 62                LDA #$62      
 FC25  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 FC28  B5 AC     <A NAME="FC28">iFC28</A>      LDA FILTRK,X  
 FC2A  29 7F                AND #$7F      
 FC2C  F0 05                BEQ <A HREF="#FC33">iFC33</A>     
 FC2E  A9 63                LDA #$63      
 FC30  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 FC33  CA        <A NAME="FC33">iFC33</A>      DEX <A HREF="#F090"></A>          
 FC34  10 F2                BPL <A HREF="#FC28">iFC28</A>     
 FC36  60                   RTS <A HREF="#FC28"></A>          

; VALIDATE FILES WITH BAM
; CREATE NEW BAM ACCORDING TO
; CONTENTS OF FILES ENTERED IN DIR

 FC37  20 99 F0  <A NAME="FC37">VERDIR</A>     JSR <A HREF="#F099">SIMPRS</A>     ; EXTRACT DRIVE #
 FC3A  20 0A EF             JSR <A HREF="#EF0A">SETLDS</A>    
 FC3D  20 C1 E8             JSR <A HREF="#E8C1">INITDR</A>     ; INIT THE DRIVE FOR NAME, ID
 FC40  20 A1 FC             JSR <A HREF="#FCA1">NEWMAP</A>     ; SET NEW BAM
 FC43  A9 00                LDA #$00      
 FC45  85 D6                STA DELIND    
 FC47  20 CE F3             JSR <A HREF="#F3CE">SRCHST</A>     ; SEARCH FOR FIRST FILE
 FC4A  D0 23                BNE <A HREF="#FC6F">iFC6F</A>      ; FOUND ONE
 FC4C  A9 00     <A NAME="FC4C">iFC4C</A>      LDA #$00       ; SET DIRECTORY SECTORS...
 FC4E  85 82                STA SECTOR     ; ... IN BAM
 FC50  A9 12                LDA #$12      
 FC52  85 81                STA TRACK     
 FC54  20 79 FC             JSR <A HREF="#FC79">MRKBAM</A>    
 FC57  20 87 EC             JSR <A HREF="#EC87">MAPOUT</A>     ; WRITE OUT BAM
 FC5A  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    
 FC5D  C8        <A NAME="FC5D">iFC5D</A>      INY <A HREF="#F075"></A>          
 FC5E  B1 93                LDA (DIRBUF),Y
 FC60  85 81                STA TRACK     
 FC62  C8                   INY           
 FC63  B1 93                LDA (DIRBUF),Y
 FC65  85 82                STA SECTOR     ; in 4040 here is inserted PHA .... REL-File Side Sector code ... PLA; NOW DO DATA BLOCKS
 FC67  20 79 FC             JSR <A HREF="#FC79">MRKBAM</A>     ; SET BIT USED IN BAM
 FC6A  20 19 F4  <A NAME="FC6A">iFC6A</A>      JSR <A HREF="#F419">SRRE</A>       ; SEARCH FOR MORE
 FC6D  F0 DD                BEQ <A HREF="#FC4C">iFC4C</A>      ; NO MORE FILES
 FC6F  B1 93     <A NAME="FC6F">iFC6F</A>      LDA (DIRBUF),Y
 FC71  30 EA                BMI <A HREF="#FC5D">iFC5D</A>     
 FC73  20 DE F9             JSR <A HREF="#F9DE">DELDIR</A>     ; NOT CLOSED DELETE DIR
 FC76  4C 6A FC             JMP <A HREF="#FC6A">iFC6A</A>     

; MARK BAM WITH FILE SECTORS

 FC79  20 5F E5  <A NAME="FC79">MRKBAM</A>     JSR <A HREF="#E55F">SETBMP</A>    
 FC7C  20 A0 E7             JSR <A HREF="#E7A0">USEDTS</A>    
 FC7F  20 36 EE             JSR <A HREF="#EE36">OPNIRD</A>    
 FC82  A9 00     <A NAME="FC82">iFC82</A>      LDA #$00      
 FC84  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 FC87  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 FC8A  85 81                STA TRACK     
 FC8C  20 D4 E9             JSR <A HREF="#E9D4">GETBYT</A>    
 FC8F  85 82                STA SECTOR    
 FC91  A5 81                LDA TRACK     
 FC93  D0 03                BNE <A HREF="#FC98">iFC98</A>     
 FC95  4C 32 EB             JMP <A HREF="#EB32">FRECHN</A>    
 FC98  20 A0 E7  <A NAME="FC98">iFC98</A>      JSR <A HREF="#E7A0">USEDTS</A>    
 FC9B  20 F3 ED             JSR <A HREF="#EDF3">NXTBUF</A>    
 FC9E  4C 82 FC             JMP <A HREF="#FC82">iFC82</A>     

 FCA1  A5 80     <A NAME="FCA1">NEWMAP</A>     LDA DRVNUM     ; create BAM
 FCA3  18                   CLC           
 FCA4  69 42                ADC #$42      
 FCA6  85 31                STA IP+1       ; buffer is $4200 for drive 0 or $4300 for drive 1
 FCA8  A9 00                LDA #$00      
 FCAA  85 30                STA IP        
 FCAC  A5 82     <A NAME="FCAC">iFCAC</A>      LDA SECTOR     ; track(!) count, not sector
 FCAE  48                   PHA           
 FCAF  A2 00                LDX #$00      
 FCB1  A0 00                LDY #$00       ; start with track=0 (=illegal), place for link address
 FCB3  84 82                STY SECTOR    
 FCB5  BD 22 E0  <A NAME="FCB5">iFCB5</A>      LDA <A HREF="#E022">TRKTBL,X</A>  
 FCB8  91 30                STA (IP),Y     ; fill buffer with data (sector/track, #$ff, #$ff, e02a+x) for each track
 FCBA  C8                   INY            ; i.e. about 35*4=140 bytes, where x is number of speedzone
 FCBB  A9 FF                LDA #$FF      
 FCBD  91 30                STA (IP),Y    
 FCBF  C8                   INY           
 FCC0  91 30                STA (IP),Y    
 FCC2  C8                   INY           
 FCC3  BD 2A E0             LDA <A HREF="#E02A">BAMEND,X</A>   ; lookup, do not compute (as in later DOS versions) last entry in BAM sector map for track
 FCC6  91 30                STA (IP),Y    
 FCC8  C8                   INY           
 FCC9  E6 82                INC SECTOR    
 FCCB  BD 26 E0             LDA <A HREF="#E026">CHGTRACKS,X</A>                ; check track with track where speed zone changes
 FCCE  C5 82                CMP SECTOR    
 FCD0  B0 E3                BCS <A HREF="#FCB5">iFCB5</A>      ; if not new speed zone, go to next track
 FCD2  E8                   INX <A HREF="#FCB5"></A>          
 FCD3  E0 04                CPX #$04       ; compare with number of speed zones
 FCD5  90 DE                BCC <A HREF="#FCB5">iFCB5</A>     
 FCD7  A0 00                LDY #$00       ; write track link address
 FCD9  A9 12                LDA #$12       ; track 18
 FCDB  91 30                STA (IP),Y    
 FCDD  C8                   INY           
 FCDE  98                   TYA            ; sector 1
 FCDF  91 30                STA (IP),Y    
 FCE1  C8                   INY           
 FCE2  91 30                STA (IP),Y     ; version 1
 FCE4  C8                   INY           
 FCE5  A9 00                LDA #$00       ; fill byte 0
 FCE7  91 30                STA (IP),Y    
 FCE9  68                   PLA           
 FCEA  85 82                STA SECTOR    
 FCEC  60                   RTS           

; MEMORY ACCESS COMMANDS
; "-" MUST BE 2ND CHAR

 FCED  A5 01     <A NAME="FCED">MEM</A>        LDA CMDBUF+1  
 FCEF  C9 2D                CMP #$2D       ; "-"
 FCF1  D0 30                BNE <A HREF="#FD23">MEMERR</A>    
 FCF3  A5 02                LDA CMDBUF+2  
 FCF5  C9 57                CMP #$57       ; "W"
 FCF7  F0 2F                BEQ <A HREF="#FD28">MEMWRT</A>     ; WRITE
 FCF9  C9 52                CMP #$52       ; "R"
 FCFB  F0 12                BEQ <A HREF="#FD0F">MEMRD</A>      ; READ
 FCFD  C9 45                CMP #$45       ; "E"
 FCFF  D0 22                BNE <A HREF="#FD23">MEMERR</A>     ; ERROR
 FD01  20 38 FD             JSR <A HREF="#FD38">iFD38</A>      ; copy address
 FD04  20 0C FD             JSR <A HREF="#FD0C">MEMEX</A>      ; EXECUTE
 FD07  A9 00     <A NAME="FD07">iFD07</A>      LDA #$00      
 FD09  85 5B                STA x5B       
 FD0B  60                   RTS           
 FD0C  6C 2A 00  <A NAME="FD0C">MEMEX</A>      JMP (TEMP)    
 FD0F  20 38 FD  <A NAME="FD0F">MEMRD</A>      JSR <A HREF="#FD38">iFD38</A>      ; copy address
 FD12  B1 2A                LDA (TEMP),Y  
 FD14  8D B4 42             STA NAMBUF    
 FD17  8D E0 10             STA CHNDAT+7  
 FD1A  A9 B4                LDA #$B4      
 FD1C  85 5D                STA x5D       
 FD1E  85 CD                STA LSTCHR+7  
 FD20  4C 07 FD             JMP <A HREF="#FD07">iFD07</A>     
 FD23  A9 31     <A NAME="FD23">MEMERR</A>     LDA #$31       ; BADCMD
 FD25  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 FD28  20 38 FD  <A NAME="FD28">MEMWRT</A>     JSR <A HREF="#FD38">iFD38</A>      ; WRITE; copy address
 FD2B  B9 06 00  <A NAME="FD2B">iFD2B</A>      LDA CMDBUF+6,Y
 FD2E  91 2A                STA (TEMP),Y   ; TRANSFER FROM CMDBUF
 FD30  C8                   INY           
 FD31  C4 05                CPY CMDBUF+5   ; # OF BYTES TO WRITE
 FD33  90 F6                BCC <A HREF="#FD2B">iFD2B</A>     
 FD35  4C 07 FD             JMP <A HREF="#FD07">iFD07</A>     

 FD38  A5 03     <A NAME="FD38">iFD38</A>      LDA CMDBUF+3   ; copy address from command to tmp
 FD3A  85 2A                STA TEMP      
 FD3C  A5 04                LDA CMDBUF+4  
 FD3E  85 2B                STA TEMP+1    
 FD40  A0 00                LDY #$00      
 FD42  60                   RTS           

; ROM 1.1 ADDITIONS
; USER COMMANDS

 FD43  A4 01     <A NAME="FD43">USER</A>       LDY CMDBUF+1  
 FD45  C0 30                CPY #$30      
 FD47  D0 09                BNE <A HREF="#FD52">iFD52</A>      ; "0" RESETS PNTR
 FD49  A9 EA     <A NAME="FD49">USRINT</A>     LDA #$EA       ; #&lt;UBLOCK; SET DEFAULT BLOCK ADD
 FD4B  85 DD                STA USRJMP    
 FD4D  A9 FF                LDA #$FF       ; #&gt;UBLOCK
 FD4F  85 DE                STA USRJMP+1  
 FD51  60                   RTS           
 FD52  20 58 FD  <A NAME="FD52">iFD52</A>      JSR <A HREF="#FD58">USREXC</A>     ; EXECUTE CODE BY TABLE
 FD55  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

 FD58  88        <A NAME="FD58">USREXC</A>     DEY <A HREF="#F075"></A>           ; ENTRY IS (((INDEX-1)AND$F)*2)
 FD59  98                   TYA <A HREF="#F075"></A>          
 FD5A  29 0F                AND #$0F      
 FD5C  0A                   ASL           
 FD5D  A8                   TAY           
 FD5E  B1 DD                LDA (USRJMP),Y
 FD60  85 30                STA IP        
 FD62  C8                   INY           
 FD63  B1 DD                LDA (USRJMP),Y
 FD65  85 31                STA IP+1      
 FD67  6C 30 00             JMP (IP)      

; OPEN DIRECT ACCESS BUFFER
; FROM OPEN "#"

 FD6A  A6 95     <A NAME="FD6A">OPNBLK</A>     LDX CMDSIZ    
 FD6C  CA                   DEX           
 FD6D  D0 0D                BNE <A HREF="#FD7C">iFD7C</A>     
 FD6F  A9 01                LDA #$01       ; GET ANY BUFFER
 FD71  20 F3 EA             JSR <A HREF="#EAF3">GETRCH</A>    
 FD74  4C BA FD             JMP <A HREF="#FDBA">iFDBA</A>     
 FD77  A9 70     <A NAME="FD77">iFD77</A>      LDA #$70       ; NOCHNL
 FD79  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 FD7C  A0 01     <A NAME="FD7C">iFD7C</A>      LDY #$01       ; BUFFER # IS REQUESTED
 FD7E  20 41 FE             JSR <A HREF="#FE41">iFE41</A>     
 FD81  A6 B1                LDX FILSEC    
 FD83  E0 0D                CPX #$0D       ; BAMJOB; MUST BE LESS THAN 13
 FD85  B0 F0                BCS <A HREF="#FD77">iFD77</A>     
 FD87  A9 00                LDA #$00      
 FD89  85 2A                STA TEMP      
 FD8B  85 2B                STA TEMP+1    
 FD8D  38                   SEC           
 FD8E  26 2A     <A NAME="FD8E">iFD8E</A>      ROL TEMP      
 FD90  26 2B                ROL TEMP+1    
 FD92  CA                   DEX           
 FD93  10 F9                BPL <A HREF="#FD8E">iFD8E</A>     
 FD95  A5 2A                LDA TEMP      
 FD97  25 8B                AND BUFUSE    
 FD99  D0 DC                BNE <A HREF="#FD77">iFD77</A>      ; BUFFER IS USED
 FD9B  A5 2B                LDA TEMP+1    
 FD9D  25 8C                AND BUFUSE+1  
 FD9F  D0 D6                BNE <A HREF="#FD77">iFD77</A>      ; BUF IS USED
 FDA1  A5 2A                LDA TEMP      
 FDA3  05 8B                ORA BUFUSE     ; SET BUFFER AS USED
 FDA5  85 8B                STA BUFUSE    
 FDA7  A5 2B                LDA TEMP+1    
 FDA9  05 8C                ORA BUFUSE+1  
 FDAB  85 8C                STA BUFUSE+1  
 FDAD  A9 00                LDA #$00       ; SET UP CHANNEL
 FDAF  20 F3 EA             JSR <A HREF="#EAF3">GETRCH</A>    
 FDB2  A5 83                LDA LINDX     
 FDB4  0A                   ASL           
 FDB5  AA                   TAX           
 FDB6  A5 B1                LDA FILSEC    
 FDB8  95 5F                STA BUFNUM,X  
 FDBA  A5 84     <A NAME="FDBA">iFDBA</A>      LDA SA        
 FDBC  0A                   ASL           
 FDBD  AA                   TAX           
 FDBE  BD B7 10             LDA LINTAB,X   ; SET LINDX TABLE
 FDC1  9D B8 10             STA LINTAB+1,X ; the 4040 has LINTAB and LINTAB+1 folded together by ORing with #$40
 FDC4  A8                   TAY           
 FDC5  A9 FF                LDA #$FF      
 FDC7  99 C6 00             STA LSTCHR,Y  
 FDCA  A9 89                LDA #$89       ; RNDRDY
 FDCC  99 BE 00             STA CHNRDY,Y   ; SET CHANNEL READY
 FDCF  98                   TYA           
 FDD0  0A                   ASL           
 FDD1  AA                   TAX           
 FDD2  B5 5F                LDA BUFNUM,X  
 FDD4  99 D9 10             STA CHNDAT,Y   ; BUFFER # AS 1ST CHAR
 FDD7  0A                   ASL           
 FDD8  AA                   TAX           
 FDD9  A9 01                LDA #$01      
 FDDB  95 3D                STA BUFTAB,X  
 FDDD  A9 08                LDA #$08       ; DIRTYP+DIRTYP
 FDDF  99 B6 00             STA FILTYP,Y   ; SET DIRECT FILE TYPE
 FDE2  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; BLOCK COMMANDS

 FDE5  A0 00     <A NAME="FDE5">BLOCK</A>      LDY #$00      
 FDE7  A2 00                LDX #$00      
 FDE9  A9 2D                LDA #$2D       ; "-" SEPARATES CMD FROM SUBCMD
 FDEB  20 17 F1             JSR <A HREF="#F117">PARSE</A>      ; LOCATE SUB-CMD
 FDEE  D0 0A                BNE <A HREF="#FDFA">iFDFA</A>     
 FDF0  A9 31     <A NAME="FDF0">iFDF0</A>      LDA #$31       ; BADCMD
 FDF2  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 FDF5  A9 30     <A NAME="FDF5">iFDF5</A>      LDA #$30       ; BADSYN
 FDF7  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 FDFA  8A        <A NAME="FDFA">iFDFA</A>      TXA <A HREF="#F090"></A>          
 FDFB  D0 F8                BNE <A HREF="#FDF5">iFDF5</A>     
 FDFD  A2 05                LDX #$05       ; NBCMDS-1; FIND COMMAND
 FDFF  B9 00 00             LDA CMDBUF,Y  
 FE02  DD 22 FE  <A NAME="FE02">iFE02</A>      CMP <A HREF="#FE22">BCTAB,X</A>   
 FE05  F0 05                BEQ <A HREF="#FE0C">iFE0C</A>     
 FE07  CA                   DEX <A HREF="#FE0C"></A>          
 FE08  10 F8                BPL <A HREF="#FE02">iFE02</A>     
 FE0A  30 E4                BMI <A HREF="#FDF0">iFDF0</A>     
 FE0C  86 96     <A NAME="FE0C">iFE0C</A>      STX CMDNUM     ; found command
 FE0E  20 34 FE             JSR <A HREF="#FE34">BLKPAR</A>     ; PARSE PARAMS
 FE11  A5 96                LDA CMDNUM    
 FE13  0A                   ASL           
 FE14  AA                   TAX           
 FE15  BD 29 FE             LDA <A HREF="#FE28">BCJMP+1,X</A> 
 FE18  85 2B                STA TEMP+1    
 FE1A  BD 28 FE             LDA <A HREF="#FE28">BCJMP,X</A>   
 FE1D  85 2A                STA TEMP      
 FE1F  6C 2A 00             JMP (TEMP)     ; GOTO COMMAND

 FE22  <A NAME="FE22">BCTAB</A>      .byte $41, $46, $52, $57, $45, $50            ;afrwep


; NBCMDS = *-BCTAB
; BLOCK-ALLOCATE, BLOCK-FREE, BLOCK-READ, BLOCK-WRITE, BLOCK-EXECUTE, BLOCK-POINTER 

 FE28  <A NAME="FE28">BCJMP</A>      .word <A HREF="#FEBB">BLKALC</A>  
<A NAME="FE29">xFE29</A>      = * - 1 ;   referenced;
 FE2A             .word <A HREF="#FEB2">BLKFRE</A>  , <A HREF="#FF09">BLKRD</A>   , <A HREF="#FF41">BLKWT</A>   , <A HREF="#FF71">BLKEXC</A>  
 FE32             .word <A HREF="#FF88">BLKPTR</A>  


; PARSE BLOCK PARMS


 FE34  A0 00     <A NAME="FE34">BLKPAR</A>     LDY #$00       ; PARSE BLOCK PARMS
 FE36  A2 00                LDX #$00      
 FE38  A9 3A                LDA #$3A       ; ":"
 FE3A  20 17 F1             JSR <A HREF="#F117">PARSE</A>     
 FE3D  D0 02                BNE <A HREF="#FE41">iFE41</A>      ; FOUND ":"
 FE3F  A0 03                LDY #$03       ; ELSE CHAR #3 IS BEGINNING
 FE41  B9 00 00  <A NAME="FE41">iFE41</A>      LDA CMDBUF,Y  
 FE44  C9 20                CMP #$20       ; " "
 FE46  F0 08                BEQ <A HREF="#FE50">iFE50</A>     
 FE48  C9 1D                CMP #$1D       ; SKIP CHARACTER
 FE4A  F0 04                BEQ <A HREF="#FE50">iFE50</A>     
 FE4C  C9 2C                CMP #$2C       ; ","
 FE4E  D0 06                BNE <A HREF="#FE56">iFE56</A>     
 FE50  C8        <A NAME="FE50">iFE50</A>      INY <A HREF="#FE56"></A>          
 FE51  C4 95                CPY CMDSIZ    
 FE53  90 EC                BCC <A HREF="#FE41">iFE41</A>     
 FE55  60                   RTS <A HREF="#FE41"></A>           ; THAT'S ALL
 FE56  20 63 FE  <A NAME="FE56">iFE56</A>      JSR <A HREF="#FE63">ASCHEX</A>    
 FE59  E6 99                INC F1CNT     
 FE5B  A4 9C                LDY F2PTR     
 FE5D  E0 04                CPX #$04       ; MXFILS-1
 FE5F  90 EF                BCC <A HREF="#FE50">iFE50</A>     
 FE61  B0 92                BCS <A HREF="#FDF5">iFDF5</A>      ; BAD SYNTAX

; CONVERT ASCII TO HEX (BINARY)
; &amp; STORE CONVERSION IN TABLES
; .Y=PTR INTO CMDBUF

 FE63  A9 00     <A NAME="FE63">ASCHEX</A>     LDA #$00      
 FE65  85 2A                STA TEMP      
 FE67  85 2B                STA TEMP+1    
 FE69  85 2D                STA TEMP+3    
 FE6B  A2 FF                LDX #$FF      
 FE6D  B9 00 00  <A NAME="FE6D">iFE6D</A>      LDA CMDBUF,Y   ; TEST FOR DEC #
 FE70  C9 40                CMP #$40      
 FE72  B0 17                BCS <A HREF="#FE8B">iFE8B</A>      ; NON-NUMERIC TERMINATES
 FE74  C9 30                CMP #$30      
 FE76  90 13                BCC <A HREF="#FE8B">iFE8B</A>      ; NON-NUMERIC
 FE78  29 0F                AND #$0F      
 FE7A  48                   PHA           
 FE7B  A5 2B                LDA TEMP+1     ; SHIFT DIGITS (*10)
 FE7D  85 2C                STA TEMP+2    
 FE7F  A5 2A                LDA TEMP      
 FE81  85 2B                STA TEMP+1    
 FE83  68                   PLA           
 FE84  85 2A                STA TEMP      
 FE86  C8                   INY           
 FE87  C4 95                CPY CMDSIZ    
 FE89  90 E2                BCC <A HREF="#FE6D">iFE6D</A>      ; STILL IN STRING
 FE8B  84 9C     <A NAME="FE8B">iFE8B</A>      STY F2PTR      ; CONVERT DIGITS TO...
 FE8D  18                   CLC            ; ...BINARY BY DEC TABLE
 FE8E  A9 00                LDA #$00      
 FE90  E8        <A NAME="FE90">iFE90</A>      INX           
 FE91  E0 03                CPX #$03      
 FE93  B0 0F                BCS <A HREF="#FEA4">iFEA4</A>     
 FE95  B4 2A                LDY TEMP,X    
 FE97  88        <A NAME="FE97">iFE97</A>      DEY           
 FE98  30 F6                BMI <A HREF="#FE90">iFE90</A>     
 FE9A  7D AF FE             ADC <A HREF="#FEAF">DECTAB,X</A>  
 FE9D  90 F8                BCC <A HREF="#FE97">iFE97</A>     
 FE9F  18                   CLC <A HREF="#FE97"></A>          
 FEA0  E6 2D                INC TEMP+3    
 FEA2  D0 F3                BNE <A HREF="#FE97">iFE97</A>     
 FEA4  48        <A NAME="FEA4">iFEA4</A>      PHA <A HREF="#FE97"></A>          
 FEA5  A6 99                LDX F1CNT     
 FEA7  A5 2D                LDA TEMP+3    
 FEA9  95 AC                STA FILTRK,X   ; STORE RESULT IN TABLE
 FEAB  68                   PLA           
 FEAC  95 B1                STA FILSEC,X  
 FEAE  60                   RTS           


; DECIMAL TABLE

 FEAF  <A NAME="FEAF">DECTAB</A>     .byte $01, $0A, $64                           ;ajD

; BLOCK-FREE


 FEB2  20 B9 FF  <A NAME="FEB2">BLKFRE</A>     JSR <A HREF="#FFB9">BLKTST</A>    
 FEB5  20 DD EE             JSR <A HREF="#EEDD">FRETS</A>     
 FEB8  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; BLOCK-ALLOCATE

 FEBB  20 B9 FF  <A NAME="FEBB">BLKALC</A>     JSR <A HREF="#FFB9">BLKTST</A>    
 FEBE  A6 80                LDX DRVNUM    
 FEC0  BD 40 E5             LDA <A HREF="#E540">IPBM,X</A>    
 FEC3  85 29                STA BMPNT+1   
 FEC5  20 6B E5  <A NAME="FEC5">iFEC5</A>      JSR <A HREF="#E56B">AVAIL</A>     
 FEC8  20 87 E5  <A NAME="FEC8">iFEC8</A>      JSR <A HREF="#E587">AV2</A>       
 FECB  B0 25                BCS <A HREF="#FEF2">iFEF2</A>     
 FECD  A6 82                LDX SECTOR    
 FECF  E8                   INX           
 FED0  86 82                STX SECTOR    
 FED2  8E E9 10             STX ERWORD     ; SET NOT AVAIL FLAG
 FED5  E4 9A                CPX R0        
 FED7  90 EF                BCC <A HREF="#FEC8">iFEC8</A>     
 FED9  A9 00                LDA #$00      
 FEDB  85 82                STA SECTOR    
 FEDD  A6 81                LDX TRACK     
 FEDF  E8                   INX           
 FEE0  86 81                STX TRACK     
 FEE2  E0 24                CPX #$24      
 FEE4  B0 05                BCS <A HREF="#FEEB">iFEEB</A>     
 FEE6  20 C9 FF             JSR <A HREF="#FFC9">iFFC9</A>      ; similar to TSCHK in 4040
 FEE9  90 DA                BCC <A HREF="#FEC5">iFEC5</A>     
 FEEB  85 81     <A NAME="FEEB">iFEEB</A>      STA TRACK     
 FEED  A9 65     <A NAME="FEED">iFEED</A>      LDA #$65       ; NOBLK
 FEEF  4C D4 E6             JMP <A HREF="#E6D4">CMDER2</A>    
 FEF2  AE E9 10  <A NAME="FEF2">iFEF2</A>      LDX ERWORD     ; FINISHED SEARCH
 FEF5  D0 F6                BNE <A HREF="#FEED">iFEED</A>      ; BLOCK WASN'T AVAILABLE
 FEF7  20 A0 E7             JSR <A HREF="#E7A0">USEDTS</A>     ; BLOCK AVAIL, SET AS USED
 FEFA  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

 FEFD  20 E4 FF  <A NAME="FEFD">BLKRD2</A>     JSR <A HREF="#FFE4">BKOTST</A>     ; TEST PARAMS
 FF00  4C 1D EE             JMP <A HREF="#EE1D">DRTRD</A>      ; GET BYTE W/O INC

 FF03  20 CC E9  <A NAME="FF03">GETSIM</A>     JSR <A HREF="#E9CC">GETPRE</A>    
 FF06  A1 3D                LDA (BUFTAB,X)
 FF08  60                   RTS           

; BLOCK READ

 FF09  20 FD FE  <A NAME="FF09">BLKRD</A>      JSR <A HREF="#FEFD">BLKRD2</A>    
 FF0C  A9 00                LDA #$00      
 FF0E  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 FF11  20 03 FF             JSR <A HREF="#FF03">GETSIM</A>     ; Y=LINDX
 FF14  20 1D FF             JSR <A HREF="#FF1D">iFF1D</A>     
 FF17  20 2C ED             JSR <A HREF="#ED2C">RNGET1</A>    
 FF1A  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

 FF1D  99 C6 00  <A NAME="FF1D">iFF1D</A>      STA LSTCHR,Y  
 FF20  A9 89                LDA #$89       ; RNDRDY
 FF22  99 D9 10             STA CHNDAT,Y  
 FF25  60                   RTS           

; USER DIRECT READ, LSTCHR=$FF

 FF26  20 34 FE  <A NAME="FF26">UBLKRD</A>     JSR <A HREF="#FE34">BLKPAR</A>    
 FF29  20 FD FE             JSR <A HREF="#FEFD">BLKRD2</A>    
 FF2C  A4 83                LDY LINDX     
 FF2E  B9 C6 00             LDA LSTCHR,Y  
 FF31  99 D9 10             STA CHNDAT,Y  
 FF34  A9 FF                LDA #$FF      
 FF36  20 1D FF             JSR <A HREF="#FF1D">iFF1D</A>     
 FF39  A9 00                LDA #$00      
 FF3B  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 FF3E  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>     ; (RTS)

; BLOCK WRITE

 FF41  20 E4 FF  <A NAME="FF41">BLKWT</A>      JSR <A HREF="#FFE4">BKOTST</A>    
 FF44  20 B0 EE             JSR <A HREF="#EEB0">GETPNT</A>    
 FF47  A8                   TAY <A HREF="#EEB0"></A>          
 FF48  88                   DEY <A HREF="#EEB0"></A>          
 FF49  C9 02                CMP #$02      
 FF4B  B0 02                BCS <A HREF="#FF4F">iFF4F</A>     
 FF4D  A0 01                LDY #$01      
 FF4F  A9 00     <A NAME="FF4F">iFF4F</A>      LDA #$00       ; SET RECORD SIZE
 FF51  20 89 EE             JSR <A HREF="#EE89">SETPNT</A>    
 FF54  98                   TYA <A HREF="#EE89"></A>          
 FF55  20 89 E8             JSR <A HREF="#E889">PUTBYT</A>    
 FF58  8A                   TXA <A HREF="#E889"></A>          
 FF59  48                   PHA <A HREF="#E889"></A>          
 FF5A  20 21 EE             JSR <A HREF="#EE21">DRTWRT</A>     ; WRITE BLOCK
 FF5D  68                   PLA <A HREF="#EE21"></A>          
 FF5E  AA                   TAX <A HREF="#EE21"></A>          
 FF5F  20 2E ED             JSR <A HREF="#ED2E">RNGET2</A>    
 FF62  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; USER DIRECT WRITE, NO LSTCHR

 FF65  20 34 FE  <A NAME="FF65">UBLKWT</A>     JSR <A HREF="#FE34">BLKPAR</A>    
 FF68  20 E4 FF             JSR <A HREF="#FFE4">BKOTST</A>    
 FF6B  20 21 EE             JSR <A HREF="#EE21">DRTWRT</A>    
 FF6E  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; BLOCK-EXECUTE

 FF71  20 FD FE  <A NAME="FF71">BLKEXC</A>     JSR <A HREF="#FEFD">BLKRD2</A>     ; READ BLOCK &amp; EXECUTE
 FF74  A9 00                LDA #$00      
 FF76  85 2A                STA TEMP      
 FF78  A6 8D                LDX JOBNUM    
 FF7A  BD CE EE             LDA <A HREF="#EECE">BUFIND,X</A>  
 FF7D  85 2B                STA TEMP+1    
 FF7F  20 85 FF             JSR <A HREF="#FF85">iFF85</A>      ; INDIRECT JSR
 FF82  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

 FF85  6C 2A 00  <A NAME="FF85">iFF85</A>      JMP (TEMP)    

; BUFFER-POINTER, SET BUFFER POINTER

 FF88  20 9A FF  <A NAME="FF88">BLKPTR</A>     JSR <A HREF="#FF9A">BUFTST</A>    
 FF8B  A5 8D                LDA JOBNUM    
 FF8D  0A                   ASL           
 FF8E  AA                   TAX           
 FF8F  A4 B2                LDY FILSEC+1  
 FF91  88                   DEY           
 FF92  94 3D                STY BUFTAB,X  
 FF94  20 1A ED             JSR <A HREF="#ED1A">iED1A</A>      ; in 4040 JSR GETPRE, JSR RNDGET2; SET UP GET
 FF97  4C 75 F0             JMP <A HREF="#F075">ENDCMD</A>    

; TEST FOR ALLOCATED BUFFER..
; ..RELATED TO SA

 FF9A  A6 9B     <A NAME="FF9A">BUFTST</A>     LDX F1PTR     
 FF9C  E6 9B                INC F1PTR     
 FF9E  B5 B1                LDA FILSEC,X  
 FFA0  A8                   TAY           
 FFA1  88                   DEY           
 FFA2  88                   DEY           
 FFA3  C0 0D                CPY #$0D       ; BAMJOB
 FFA5  90 05                BCC <A HREF="#FFAC">iFFAC</A>     
 FFA7  A9 70     <A NAME="FFA7">iFFA7</A>      LDA #$70       ; NOCHNL
 FFA9  4C 90 F0             JMP <A HREF="#F090">CMDERR</A>    
 FFAC  85 84     <A NAME="FFAC">iFFAC</A>      STA SA        
 FFAE  20 B0 E9             JSR <A HREF="#E9B0">FNDRCH</A>    
 FFB1  B0 F4                BCS <A HREF="#FFA7">iFFA7</A>     
 FFB3  20 9D E8             JSR <A HREF="#E89D">GETACT</A>    
 FFB6  85 8D                STA JOBNUM    
 FFB8  60                   RTS           

; TEST FOR LEGAL BLOCK &amp;..
; ..SET UP DRV, TRK, SEC

 FFB9  A6 9B     <A NAME="FFB9">BLKTST</A>     LDX F1PTR     
 FFBB  B5 B1                LDA FILSEC,X  
 FFBD  29 01                AND #$01      
 FFBF  85 80                STA DRVNUM    
 FFC1  B5 B3                LDA FILSEC+2,X
 FFC3  85 82                STA SECTOR    
 FFC5  B5 B2                LDA FILSEC+1,X
 FFC7  85 81                STA TRACK     
 FFC9  A5 81     <A NAME="FFC9">iFFC9</A>      LDA TRACK      ; in 4040 separated out into TSCHK
 FFCB  AA                   TAX           
 FFCC  CA                   DEX           
 FFCD  E0 23                CPX #$23      
 FFCF  B0 0E                BCS <A HREF="#FFDF">iFFDF</A>     
 FFD1  20 B1 E5             JSR <A HREF="#E5B1">MAXSEC</A>    
 FFD4  85 9A                STA R0        
 FFD6  A5 82                LDA SECTOR    
 FFD8  C5 9A                CMP R0        
 FFDA  B0 03                BCS <A HREF="#FFDF">iFFDF</A>     
 FFDC  4C 0A EF             JMP <A HREF="#EF0A">SETLDS</A>    
 FFDF  A9 22     <A NAME="FFDF">iFFDF</A>      LDA #$22      
 FFE1  4C D4 E6             JMP <A HREF="#E6D4">CMDER2</A>    

 FFE4  20 9A FF  <A NAME="FFE4">BKOTST</A>     JSR <A HREF="#FF9A">BUFTST</A>     ; TEST BLOCK OPERATION PARAMS
 FFE7  4C B9 FF             JMP <A HREF="#FFB9">BLKTST</A>    

 FFEA  <A NAME="FFEA">xFFEA</A>      .word <A HREF="#FF26">UBLKRD</A>  , <A HREF="#FF65">UBLKWT</A>  , BUFS+512 , BUFS+515 
 FFF2             .word BUFS+518 , DIAGROM+8 , DIAGROM+11 , DIAGROM+14 

 FFFA             .word DIAGROM+213 , <A HREF="#E18E">DSKINT</A>  , <A HREF="#E2D6">ATNIRQ</A>  


; Misassembly source 4.08 15 May 2005   Generated  Sun May 15 20:12:16 CEST 2005


</PRE>
<P><HR>
<P>Formatted to HTML by <EM>recomment 4.08 15 May 2005</EM> reassembler.</P>
<P>Misassembled from <EM>dos1</EM> by <EM>fachat@newton</EM> using header file <EM>dos1.hdr</EM> in a 2-pass run at Sun May 15 20:12:16 CEST 2005
.</P>
</BODY></HTML>

