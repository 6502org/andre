<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
<meta name="author" content="Andr&eacute;  Fachat">

<meta name="description" content="6502 16bit 32bit expansion">
<meta name="keywords" content="6502 16bit 32bit expansion">
<link rev="made" href="mailto:afachat@gmx.de">
<link rel="stylesheet" title="Default" type="text/css" href="../style2.css"><link rel="alternate stylesheet" title="Advanced" type="text/css" href="../advanced.css">
<title>65k Design Notes</title></head>
<body><div id="mainbox"><a name="top"></a><div id="topsearch"><form method="get" action="http://www.google.com/search" target="_blank"><input alt="search" name="q" size="10" maxlength="255" type="text"><input class="advbutton" value="Search site" type="submit"><div id="srchprov">(by Google)</div><input name="sitesearch" value="www.6502.org/users/andre" type="hidden"></form><div id="topfind"></div></div><div id="menubox">


<div id="menu1" class="mclose">
<div id="twist1" class="twisty"></div>
<div class="hdrtxt"><a href="../index.html">Home&nbsp;&gt;</a></div>
<ul class="nav1">
<li>
<ul class="nav2">
<li class="navhdr"><a href="../index.html">Home</a></li>
<li><a href="../contact.html">Contact</a></li>
<li><a href="../design.html">Web design</a></li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Hardware</span></li>
<li><ul class="nav2" >
<li><a href="../65k/index.html">The 65k Project</a>
</li>
<li><a href="../csa/index.html">CS/A65</a>
</li>
<li><a href="../cbmhw/index.html">CBM mods</a>
</li>
<li><a href="../spi65b/index.html">SPI65B</a>
</li>
<li><a href="../mischw/index.html">Other hardware</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Software</span></li>
<li><ul class="nav2" >
<li><a href="../osa/index.html">GeckOS</a>
</li>
<li><a href="../lib6502/index.html">lib6502 </a>
</li>
<li><a href="../o65/index.html">o65</a>
</li>
<li><a href="../usb65/index.html">usb65</a>
</li>
<li><a href="../xd2031/index.html">XD2031</a>
</li>
<li><a href="../misc/index.html">Misc</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Library</span></li>
<li><ul class="nav2" >
<li><a href="../petindex/index.html">PETindex</a>
</li>
<li><a href="../adv65/index.html">Advanced 6502</a>
</li>
<li><a href="../hwinfo/index.html">ICs and Standards</a>
</li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Knowledge Bits</span></li>
<li><ul class="nav2" >
<li><a href="../icapos/index.html">Computer/OS Architecture</a>
</li>
<li><a href="../icaphw/index.html">6502 Hardware Bits</a>
</li>
</ul>
<div class="nend2"></div>
</li>
<div class="nend1"></div>
</ul>
</div>
<div id="menu2" class="mopen">
<div id="twist2" class="twisty"></div>
<div class="hdrtxt"><a href="index.html">The 65k Project&nbsp;&gt;</a></div>
<ul class="nav1">
<li>
<ul class="nav2">
<li class="navhdr"><a href="index.html">The 65k Project</a></li>
<li><a href="features.html">Feature Outline</a></li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Specification</span></li>
<li><ul class="nav2" >
<li><a href="specsprog.html">Programming Model</a></li>
<li><a href="future.html">Future Extensions</a></li>
<li><a href="af65002">&gt;65002</a></li>
<li><a href="designnotes.html">Design Notes</a></li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Tools</span></li>
<li><ul class="nav2" >
<li><a href="crossass.html">Cross-Assembler</a></li>
<li><a href="nativetools.html">Native Tools</a></li>
<div class="nend2"></div>
</ul>
</li>
<div class="nend1"></div>
</ul>
<ul class="nav1" >
<li><span>Implementation</span></li>
<li><ul class="nav2" >
<li><a href="arch.html">General architecture</a></li>
<li><a href="af65002/index.html">af65002 </a>
</li>
<li><a href="tests.html">Test setup</a></li>
</ul>
<div class="nend2"></div>
</li>
<div class="nend1"></div>
</ul>
</div>
	</div><div id="midcol"><div class="top" id="content"><div id="minmax"></div>

<h1>65k Design Notes</h1><p class="copyright">(C)
2010-2011 Andr&eacute;  Fachat</p> 
<div class="overview"><p>This page describes some discussion that I went through while
	doing the programming specification for the 65k. I started this process
	in 2010, but explicitely decided to leave it there until my hardware
	pipeline had run dry (i.e. after the USB and Blitter boards being done).</p>
	<p>
	During this time from time to time I thought about the 65k design. For example when
	I had to program some 6502 code I though how I could benefit from the 65k writing this
	piece of code. From this for example comes the "2s-complement" opcode, but also the
	prefix bit determining when to expand the opcode (so you can do a 64bit addition
	with a byte immediate operand). 
	On the other I also thought about how to implement it, where I found the most
	complexity in the decode area, that also has to work with different bus width options.
	</p><p>
	Some of the decisions made here may very well be premature optimizations. I will
	revisit these and may change them in the further process.
	</p>
  </div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="news">News:</a></h2></div><div class="h2c"><ul class="news"><li><div>&nbsp;</div><small>2011-12-23</small>
	Addded some discussion about the ZE/EE and LE prefixes
    </li><li><div>&nbsp;</div><small>2011-05-01</small>
	Started this page
    </li></ul></div></div><div id="toc" class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2>Table of content</h2></div><div class="h2c"><ul><li><a href="#irq">Interrupt Compatibility</a></li><li><a href="#extends">Extension Prefixes</a></li><li style="list-style-type:none;"><ul><li><a href="#ZE">The ZE prefix</a></li><li><a href="#EE">The EE prefix</a></li><li><a href="#LE">The LE prefix</a></li></ul></li><li><a href="#placement">Placing opcodes in the opcode map</a></li><li style="list-style-type:none;"><ul><li><a href="#extpage">Placing opcodes on the Extension page</a></li><li><a href="#absy">Absolute y-indexed addressing</a></li></ul></li><li><a href="#redundancy">Elimination of Redundancy</a></li><li style="list-style-type:none;"><ul><li><a href="#ade">(Quick) Add/Substract to E/B</a></li></ul></li><li><a href="#convenience">Convenience Opcodes</a></li><li style="list-style-type:none;"><ul><li><a href="#inv">2s complement</a></li><li><a href="#shiftxy">Shift X and Y</a></li></ul></li></ul></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="irq">Interrupt Compatibility</a></h2></div><div class="h2c"><p>
	TODO
     </p></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="extends">Extension Prefixes</a></h2></div><div class="h2c"><p>
	When providing wider registers than before, of course there must be a way to 
	access those registers in a wide way. This is given with the RS prefix. 
	However, what is the best way to manage transfers between different register widths?
	</p><p>
	There should be a way to load for example a byte and extend it to a wider size.
	Or the result of an operation should be automatically extended. 
	And how can a value be truncated?
	What about loading X and Y with short values when they are always used full width in the
	addressing modes?
     </p><h3><a name="ZE">The ZE prefix</a></h3><p>
	  The first attempt was the ZE prefix. Without the prefix all stores to a register
	  would be zero-extended. I.e. when, after a load or another operation, the value was
	  written to a register, the value was zero-extended to full width.
	  This accommodated for the X/Y loads fine, and provided some automation for AC. As
	  each operation was sized by RS anyway, zero-extending them was not a problem.
	  However, to add an 8-bit value to AC with a full width operation, the ADC would
	  still need to load the full width value, even though the value was only 8 bit.
	</p><h3><a name="EE">The EE prefix</a></h3><p>
	  Therefore the EE prefix - Early Extension means that the value is loaded on RS width,
	  and the zero-extension is done "early": before the operation, that then happens on full width.
	  This solves the problem of loading a narrow value for a wide operation.
	  However ...
	</p><h3><a name="LE">The LE prefix</a></h3><p>
	  ... there is only the ability to extend with zeros. And can a register not be extended after having been
	  set with a separate opcode?
	  So now there is an LE prefix, that extends a value when loaded from memory (or another register).
	  I.e. instead of extending a value when it is written like in the original approach, 
	  it is now extended when loaded. With the EXT opcode it can then be truncated to the relevant number
	  of bits - or the value could just be stored to memory with a narrow STA instead of a full-width one.
	</p><p>	
	  There are two ways of behaviour with the LE prefix.
	</p><ul>
	<li>Load/Transfer operations: Here the value is zero-extended by default, flags are set from the original width given
		by RS. This allows to simply clear an index register with LDY #$00, no matter the processor width and 
		no matter what was left over in Y from previous code. As flags are set from the RS-width value, this
		is also compatible with the 6502. Also it provides more information, as for example the sign of the value
		would be masked by a zero-extension would the flags be taken from the full width value.</li>
	<li>Other operations: In other operations the extension takes place before the operation. I.e. RS determines the 
		load width, but the operation is done on full width.
		The flags are taken from the result of the operation - which is 
		full width in case of an extension. So flags represent the true result of the operation.
		However, to avoid accidently extending to a full operation - which is most certainly not wanted in
		e.g. ADC - the default here is to not extend.</li>
	</ul>
	<p>	
	  The default operation on a load of X and Y thus is to zero-extend the registers, as they are always used full-width
	  in the addressing modes. Flags would be set from the original size. 
	  This implements the "least surprise" strategy. Not-extending could be done
	  with an explicit LE prefix saying so. 
	</p><p>	
	  For the AC it is less important, as every operation on AC is explicitely sized
	  (using RS) or 8-bit only - so upper bits do not matter on such operations and can be left by default.
	  Therefore AC is not extended by default.
	</p></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="placement">Placing opcodes in the opcode map</a></h2></div><div class="h2c"><p>
	When thinking about the opcode decoding I learned that in the FPGA you can save
	"chip space" when you can combine opcodes. I.e. if you have a large case switch
	for opcodes, it pays out to say, select all "LDA" opcodes in a single case, and
	not have a case switch for each addressing mode.
	</p><p>
	Therefore, for the decoding, I decided to implement a two-stage process:
	first decode the opcode into something like "Operation" and "Addressing Mode" and "Options"
	bits, then in the second step do a micro-sequence for the addressing mode and 
	in the execution phase continue with the operation micro-sequence. This way
	many logic parts can be shared - between same opcodes with different addressing modes
	and between different opcodes with the same addressing mode.
	</p><p>
	The consequences of this decision are described below:
     </p><h3><a name="extpage">Placing opcodes on the Extension page</a></h3><p>
	You might have noticed that the LEA and PEA opcodes are distributed over the extension page.
	This is done with the above decision in mind. If you look closely you will see that the
	LEA and PEA addressing modes mirror those of the LDA and STA opcodes in the standard
	opcode page!
	</p><p>
	In the original opcode map, column $8 (Low opcode nibble) holds opcodes without
	operand, i.e. one-byte opcodes like CLC. I have mirrored this in the extension page.
	</p><h3><a name="absy">Absolute y-indexed addressing</a></h3><p>
	Some of the opcodes in the original 6502 show an asymmetry in that compared to 
	similar opcodes even though they have an absolute x-indexed addressing mode, 
	they don't have the absolute y-indexed addressing mode. Examples
	are ASL, ROL, LSR, ROR but also DEC, INC or STZ. STX would also profit from 
	an absolute y-indexed addressing mode. So I have put them into colum $f,
	at their "logical" places in the opcode map. I.e. when <code>ASL abs,X</code> is opcode $1E,
	then <code>ASL abs,Y</code> is opcode $1F.
	</p></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="redundancy">Elimination of Redundancy</a></h2></div><div class="h2c"><p>
	Another point when designing the opcode set is to not introduce redundancy,
	i.e. two opcodes that basically do the same. Thinking about such redundancy 
	reduction may even lead to new features...
     </p><h3><a name="ade">(Quick) Add/Substract to E/B</a></h3><p>
	While revisiting the opcode set I found that I had two opcodes that basically do the same,
	INE (quick increment by 1-8) and ADE immediate, plus similar combinations for substract/decrement
	and the B register.
	</p><p>
	Some comments on E register suggest that it is always used full-size. I.e. an immediate
	add of an 8-bit value would overflow up to the full size if necessary. So instead of a
	quick INE #8 an equivalent ADE #8 could be used (although the latter has 3 instead of 2 bytes
	total length).
	</p><p>
	So the first thing to do is to remove the INE/INB/DEE/DEB quick opcodes. 
	</p><p>
	But wouldn't it be nice if I could add an 8-bit value (like from an immediate addressing mode
	or when read from an 8-bit variable) to a 32-bit AC without having to do clever tricks?
	With only the RS prefix bits the "register size" also determines the width of the data in memory,
	so it is not possible to have an 8-bit variable and use it in a wider operation.
	</p><p>
	Here another prefix bit would probably be useful to implement the "early" extension.
	</p></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="convenience">Convenience Opcodes</a></h2></div><div class="h2c"><p>This section describes some convenient opcodes that I found missing during my
	recent 6502 programming.
     </p><h3><a name="inv">2s complement</a></h3><p>
		When I programmed my USB stack for the 6502 I found that I had to substract two
		values, but that the one to substract was in the AC, not the one to substract from.
		So I could not just use SEC/SBC to do the substraction. Instead I found I had
		to invert - in the sense of doing the 2s-complement - AC, then add to the second
		value, to substract the first from the second value.
		</p><p>
		To make this process easier, I added the INV opcode.
	</p><h3><a name="shiftxy">Shift X and Y</a></h3><p>
		When I programmed access to the data structure in the USB driver, I was wondering
		how to access tabular structure data using the index registers. I had to actually compute
		an index by multiplying with the structure size. 
		</p><p>
		To make this process easier, I added the shift left/right x/y register quick opcodes 
		(SLX/SRX/SLY/SRY). These allow to quickly compute at least power-of-2 offsets
		for aligned data structures.
	</p></div></div><hr>
<p>Return to <a href="../index.html">Homepage</a></p>

  </div></div><div id="rightcol"><div class="top" id="twitter"><div class="tophead">follow</div><div>
		            Follow my 8-bit tweets on<br><a class="extlink" target="_blank" href="https://twitter.com/#!/search/realtime/afachat%20%238bit">Twitter</a><br> (In new window)
		</div></div><div class="top" id="forum"><div class="tophead">discuss</div><div><p>Discuss my site on <a class="extlink" target="_blank" href="http://forum.6502.org/viewtopic.php?t=956">this 6502.org forum thread</a></p><p>(Forum registration required to post)</p></div></div><div class="top" id="hot"><div class="tophead">Hot!</div><div>
<p>Dive into the retro feeling and build yourself a <a href="../cbmhw/ryofat40/index.html">Commodore PET replica</a></p>
<p>Need more speed? Speed up your 6502 computer with this <a href="../adv65/pet816/index.html">10&nbsp;MHz 6502 CPU replacement board</a></p>
<p>Interested in electronics design? Look at the <a href="../icaphw/design.html">design lesson</a> I got from Bil Herd, the hardware designer of the C128</p>
<p>Want 64bit? - pimp the 6502 with the <a href="../65k/index.html">65k processor design!</a></p>

		</div></div></div><div id="footer">&nbsp;</div></div><script type="text/javascript">myUp="../";</script><script type="text/javascript" src="../scripts2-all.js"></script></body></html> 
