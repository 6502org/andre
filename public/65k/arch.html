<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="author" content="Andr&#xE9;  Fachat" />

<meta name="description" content="6502 16bit 32bit expansion" />
<meta name="keywords" content="6502 16bit 32bit expansion" />
<link rev="made" href="mailto:afachat@gmx.de" />
<link rel="stylesheet" title="Default" type="text/css" href="../style-min.css" /><link rel="alternate stylesheet" title="Advanced" type="text/css" href="../advanced.css" />
<title>The 65k Project - Architecture Overview</title></head>
<body><div id="mainbox"><a name="top" id="top"></a><div id="leftcol"><div id="menu" class="top"><div class="tophead">navigate</div><div id="filter"><form action="#"><table id="filterbox"><tr><td><input alt="menu filter" size="8" name="filter" value="filter" type="text" /></td><td><div id="cancel" class="i_cancel"> </div></td></tr></table><table id="expcol"><tr><td><div id="expand" class="i_expand"> </div></td><td><div id="collapse" class="i_collapse"> </div></td></tr></table></form></div>
<div id="mtree">
<a id="m_homepage" href="../index.html">Homepage</a>
<ul class="menu0" >
<li class="separator">Commodore</li>
<li class="dir" id="m_petindex"><div class="i_dir">&nbsp;</div><a href="../petindex/index.html">CBM PETindex</a>
</li>
<li class="dir" id="m_cbmhw"><div class="i_dir">&nbsp;</div><a href="../cbmhw/index.html">CBM hardware and mods</a>
</li>
<li class="separator">Hardware</li>
<li class="dir" id="m_65k"><div class="i_dir">&nbsp;</div><a href="../65k/index.html">The 65k Project</a>
<ul class="menu1" >
<li><div class="i_file">&nbsp;</div><a href="features.html">Features</a></li>
<li><div class="i_file">&nbsp;</div><a href="specsprog.html">Programming Model</a></li>
<li><div class="i_file">&nbsp;</div><a href="arch.html" class="mcurrent">Architecture Overview</a></li>
<li><div class="i_file">&nbsp;</div><a href="tests.html">Test setup</a></li>
</ul>
</li>
<li class="dir" id="m_csa"><div class="i_dir">&nbsp;</div><a href="../csa/index.html">CS/A65 Caspaer and Gecko computer</a>
</li>
<li class="dir" id="m_adv65"><div class="i_dir">&nbsp;</div><a href="../adv65/index.html">Advanced 6502</a>
</li>
<li class="dir" id="m_hwinfo"><div class="i_dir">&nbsp;</div><a href="../hwinfo/index.html">ICs and Standards Info</a>
</li>
<li class="dir" id="m_mischw"><div class="i_dir">&nbsp;</div><a href="../mischw/index.html">Other hardware (e.g. tools)</a>
</li>
<li class="separator">Software</li>
<li><div class="i_file">&nbsp;</div><a href="../osa/index.html">GeckOS operating system</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../lib6502/index.html">Lib6502 standard</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../o65/index.html">O65 file format</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../misc/index.html">Misc software</a>
</li>
<li class="separator">Knowledge Bits</li>
<li class="dir" id="m_icapos"><div class="i_dir">&nbsp;</div><a href="../icapos/index.html">Computer/OS Architecture</a>
</li>
<li class="dir" id="m_icaphw"><div class="i_dir">&nbsp;</div><a href="../icaphw/index.html">6502 Hardware Bits</a>
</li>
<li class="separator">Misc</li>
<li><div class="i_file">&nbsp;</div><a href="../contact.html">Contact</a></li>
<li><div class="i_file">&nbsp;</div><a href="../sneak.html">Sneak preview</a></li>
<li><div class="i_file">&nbsp;</div><a href="../design.html">Web design</a></li>
</ul>

</div>
		</div><div class="top" id="browser"><div class="tophead">browser</div><div>
			Site has been tested with a number of browsers and systems. Javascript required for advanced menu, but degrades gracefully without Javascript. IE6 not fully supported anymore!
			</div></div></div><div id="rightcol"><div class="top" id="google"><div class="tophead">search</div><div><form method="get" action="http://www.google.com/search" target="_blank"><input alt="search parameters" type="text" name="q" size="10" maxlength="255" value="" /><input class="advbutton" type="submit" value="Search my site" /><br />(Google, in new window)
	                        <input type="hidden" name="sitesearch" value="www.6502.org/users/andre" /></form></div></div><div class="top" id="twitter"><div class="tophead">follow</div><div>
		            Follow my 8-bit tweets on<br /><a target="_blank" href="http://search.twitter.com/search?q=&amp;ands=&amp;phrase=&amp;ors=&amp;nots=&amp;tag=8bit&amp;lang=all&amp;from=afachat&amp;to=&amp;ref=&amp;near=&amp;within=15&amp;units=mi&amp;since=&amp;until=&amp;rpp=15">Twitter</a><br /> (In new window)
		</div></div><div class="top" id="forum"><div class="tophead">discuss</div><div><p>Discuss my site on <a class="extlink" target="_blank" href="http://forum.6502.org/viewtopic.php?t=956">this 6502.org forum thread</a></p><p>(Forum registration required to post)</p></div></div><div class="top" id="hot"><div class="tophead">Hot!</div><div>
<p>Dive into the retro feeling and build yourself a <a href="../cbmhw/ryofat40/index.html">Commodore PET replica</a></p>
<p>Need more speed? Speed up your 6502 computer with this <a href="../adv65/pet816/index.html">10&nbsp;MHz 6502 CPU replacement board</a></p>
<p>Interested in electronics design? Look at the <a href="../icaphw/design.html">design lesson</a> I got from Bil Herd, the hardware designer of the C128</p>

		</div></div></div><div id="midcol"><div class="top" id="ie6warn">
You are using an old MS Internet Explorer as browser. This version is not supported anymore. Please use a 
more modern browser, like Internet Explorer 8 or later, 
<a target="_blank" class="extlink" href="http://www.firefox.com">Firefox</a>,
<a target="_blank" class="extlink" href="http://www.google.com/chrome">Google Chrome</a>, or
<a target="_blank" class="extlink" href="http://www.opera.com">Opera</a>.
</div><div class="top" id="content"><div id="minmax"></div>
<div id="breadcrumbs">
<a href="../index.html">Homepage</a>
&gt;&gt;  <a href="index.html">The 65k Project
</a>&gt;&gt;  Architecture Overview</div>
<h1>The 65k Project - Architecture Overview</h1><p class="copyright">(C)
2010- André  Fachat</p> 
<div class="overview">
	<p>
	This page describes an overview on the 65k architecture.
	</p><p>
	</p>
  </div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="news" id="news">News:</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><ul class="news"><li><div> </div><small>2010-10-14</small>
	Started this page
    </li></ul></div></div><div id="toc" class="h2"><div class="h2h"><div class="h2t"> </div><h2>Table of content</h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><ul><li><a href="#general">General Considerations</a></li><li style="list-style-type:none;"><ul><li><a href="#genrwseq">Read/Write Sequencers</a></li><li><a href="#smt">Simultaneous Multithreading</a></li></ul></li><li><a href="#top">Top Level Architecture</a></li><li style="list-style-type:none;"><ul><li><a href="#topcore">Core</a></li><li><a href="#toprwseq">Read / Write Data Sequencer, Read Arbiter</a></li><li><a href="#topmmu">Memory Management Unit</a></li><li><a href="#topbusif">Bus Interface</a></li></ul></li><li><a href="#core">Core</a></li><li><a href="#mmu">MMU</a></li><li><a href="#busif">Bus Interface</a></li></ul></div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="general" id="general">General Considerations</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c">
      <p>
	This section describes general considerations for the processor design.
      </p>
    <h3><a name="genrwseq" id="genrwseq">Read/Write Sequencers</a></h3>
	<p>
	The processor has one problem: addresses are at byte level, bus and register
	widths are in general more than one byte wide - so misaligned accesses can happen:
	</p>
	<table border="1">
	<tr><th>Access Type</th><th>Bus width</th><th>Alignment</th><th>Comment</th></tr>
	<tr><td>Byte data read</td><td>any width</td><td>yes/no</td><td>The data can be read in any width from
									the bus, and the relevant byte be picked
									from it and given to the bus</td></tr>
	<tr><td>Byte data write</td><td>byte width</td><td>automatic</td><td>just write the byte</td></tr>
	<tr><td>Byte data write</td><td>word or larger width</td><td>yes/no</td><td>If the data can not be written
									as byte width but must use a larger width,
									the original data must be read, the relevant
									byte be modified, and the data word be 
									written back</td></tr>
	<tr><td>word or larger data read/write access</td><td>byte width</td><td>automatic</td>
									<td>The data access can just be executed
									one after the other</td></tr>
	<tr><td>word data read/write access</td><td>word width</td><td>aligned</td>
									<td>Just do the access</td></tr>
	<tr><td>word data read/write access</td><td>word width</td><td>misaligned</td>
									<td>The word access must be broken up into
									two byte accesses, and executed as 
									byte acces on a word bus as described above.
									</td></tr>
	<tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
	</table>
	<p>
	The table only shows a subset of possible combinations. To resolve this problem, specific 
	components are used, read and write sequencers. These components take a read or write request from the
	core and break them up into accesses that the external bus can execute.
	</p><p>
	If some address area is accessed as byte-wide I/O, and other parts of the address area as word-wide or wider
	memory, the processor must have multiple read and write sequencer, one per address width (or a sequencer
	that can handle multiple widths).
	</p><p>
	Doing misaligned accesses slows the processor down from its optimum speed. In general wider bus width
	is still faster than narrower bus widths.
	</p>
      <h3><a name="smt" id="smt">Simultaneous Multithreading</a></h3>
	  <p>
	The 6502 - as well as the 65k - is very efficient concerning bus cycles per opcode.
	If, however, a misaligned wide access is broken down into two or more smaller memory
	accesses, the core is waiting.
	  </p><p>
	In this case the core could switch to a separate set of registers, and execute 
	code for a second processor - what is called these days as SMT, simultaneous multithreading.
	  </p><p>
	But as the processor is very memory access efficient, a second thread may not have time
	for many memory accesses on its own. 
	  </p><p>
	This is a topic for a later version though anyway.
	  </p>
       	</div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="top" id="top">Top Level Architecture</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><p>This section describes the top level architecture, i.e. the top level
	building blocks of the processor and their relations. Compared to the 6502
	there are more such building blocks, the processor is more complex. The 6502
	basically compares to the core - which is described in more detail below.</p>
	<div class="rightimg"><a href="archtop.svg"><img width="300" src="archtop.png" /></a>The top level
	architecture</div>
	<p>
	The following sections describe the components.
	</p>
     <h3><a name="topcore" id="topcore">Core</a></h3>
	<p>
	The core is the actual processor. It contains registers, ALU, and so on. With the 
	rest of the system it communicates using three bus interfaces:
	</p>
	<ol>
	<li>Instruction fetch bus - read the next instruction</li>
	<li>Data read bus - read some data word</li>
	<li>Data write bus - write some data word </li>
	</ol>
	<p>
	</p>
       	<h3><a name="toprwseq" id="toprwseq">Read / Write Data Sequencer, Read Arbiter</a></h3>
	  <p>
	  The read and write sequencers break down misaligned memory accesses
	  into accesses that can be executed on the external bus.
	  </p><p>
	  The separate read data and instruction fetch sequencers may look like overkill.
	  But this approach has the advantage that the instruction fetch sequencer can
	  cache data it has already been read but has not yet been used by the CPU - without
	  it being flushed by a data read.
	  </p><p>
	  The place between the read sequencers and the read arbiter can be a good place
	  for a L1 cache - separate for data and instructions - in later versions.
	  On the other hand the place between read arbiter and MMU can be used for a L1
	  cache. Both places must be connected to the write bus, to invalidate modified 
	  cache lines - to allow for self-modifying code.
	  </p><p>
	  Note that the sequencers must be before the MMU, as each of the broken
	  down accesses may result in a different mapping.
	  </p>
	<h3>Write Data Sequencer</h3>
	  <p>
	  The write data sequencer takes a write request from the core, then checks 
	  if the access is aligned or not. If it is not aligned, the access is broken
	  into two separate accesses and forwarded to the MMU.
	  </p>
	<h3>Read Data Sequencer</h3>
	  <p>
	  The read data sequencer takes a read request from the core, then checks 
	  if the access is aligned or not. If it is not aligned, the access is broken
	  into two separate accesses and forwarded to the read arbiter.
	  The result is consolidated and sent to the CPU when the whole data has been read.
	  </p>
	<h3>Instruction Fetch Sequencer</h3>
	  <p>
	  The instruction fetch sequencer takes a fetch request from the CPU,
	  then tries to fulfill as much of it as possible. As the CPU does not know
	  how many bytes an instruction takes, the CPU requests as many bytes as possible,
	  but accepts less bytes than requested. The CPU then decides if it needs more
	  instruction data. 
	  </p>
	<h3>Read Arbiter</h3>
	  <p>
	  The read arbiter takes requests from the read data sequencer and the instruction fetch
	  sequencer, then decides which one to forward to the MMU. 
	  </p>
       	<h3><a name="topmmu" id="topmmu">Memory Management Unit</a></h3>
	  <p>
	The memory management unit is an optional feature. It translates the
	read and write requests from the CPU (actually from the read arbiter and from the
	write sequencer) from effective to physical addresses.
	  </p><p>
	More details are described below.
	  </p>
       	<h3><a name="topbusif" id="topbusif">Bus Interface</a></h3>
	  <p>
	The bus interface takes the read and write requests from the MMU and executes
	them on the physical - external - bus interface. 
	  </p><p>
	For a misaligned bus write access (e.g. a byte write to a word wide bus) the bus
	interface also implements read-modify-write cycles. I.e. the wide bus memory data
	is read, the narrower data from the CPU is set into this memory word, and the 
	data is written back.
	  </p><p>
	Also the bus interface does a bus snoop in case the external bus allows this. The
	bus snooping is used to invalidate cache lines. It also detects accesses that
	invalidates Load-linked/Store-conditional sequences.
	  </p>
       	</div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="core" id="core">Core</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><p>
	
	</p>
     </div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="mmu" id="mmu">MMU</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><p>
	
	</p>
     </div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2><a name="busif" id="busif">Bus Interface</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><p>
	
	</p>
     </div></div><div class="h2"><div class="h2h"><div class="h2t"> </div><h2></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c">
        No warranty! 
	Subject to change without notice!
	There is no guarantee that this specification will actually work,
        or will ever be implemented
  </div></div><hr />
<p>Return to <a href="../index.html">Homepage</a></p>

  </div></div><div id="footer"> </div></div><script type="text/javascript">myUp="../";</script><script type="text/javascript" src="../scripts-all.js"></script></body></html> 

