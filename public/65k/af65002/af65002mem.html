<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="author" content="">

<meta name="description" content="65002 documentation">
<meta name="keywords" content="8-bit,6502,65002">
<link rev="made" href="mailto:">
<link rel="stylesheet" title="Default" type="text/css" href="../../style-min.css"><link rel="alternate stylesheet" title="Advanced" type="text/css" href="../../advanced.css">
<title>65002 Memory Management</title></head>
<body><div id="mainbox"><a name="top"></a><div id="leftcol"><div id="menu" class="top"><div class="tophead">navigate</div><div id="filter"><form action="#"><table id="filterbox"><tr><td><input alt="menu filter" size="8" name="filter" value="filter" type="text"></td><td><div id="cancel" class="i_cancel">&nbsp;</div></td></tr></table><table id="expcol"><tr><td><div id="expand" class="i_expand">&nbsp;</div></td><td><div id="collapse" class="i_collapse">&nbsp;</div></td></tr></table></form></div>
<div id="mtree">
<a id="m_homepage" href="../../index.html">Homepage</a>
<ul class="menu0" >
<li class="separator">Commodore</li>
<li class="dir" id="m_petindex"><div class="i_dir">&nbsp;</div><a href="../../petindex/index.html">CBM PETindex</a>

</li>
<li class="dir" id="m_cbmhw"><div class="i_dir">&nbsp;</div><a href="../../cbmhw/index.html">CBM hardware and mods</a>

</li>
<li class="separator">Hardware</li>
<li class="dir" id="m_65k"><div class="i_dir">&nbsp;</div><a href="../../65k/index.html">The 65k Project</a>

<ul class="menu1" >
<li><div class="i_file">&nbsp;</div><a href="../features.html">Features</a></li>
<li class="separator">Specification</li>
<li><div class="i_file">&nbsp;</div><a href="../specsprog.html">Programming Model</a></li>
<li><div class="i_file">&nbsp;</div><a href="../future.html">Future Extensions</a></li>
<li><div class="i_link">&nbsp;</div><a href="../af65002">65002</a></li>
<li><div class="i_file">&nbsp;</div><a href="../designnotes.html">Design Notes</a></li>
<li class="separator">Tools</li>
<li><div class="i_file">&nbsp;</div><a href="../crossass.html">Cross-Assembler</a></li>
<li><div class="i_file">&nbsp;</div><a href="../nativetools.html">Native Tools</a></li>
<li class="separator">Implementation</li>
<li><div class="i_file">&nbsp;</div><a href="../arch.html">General architecture</a></li>
<li class="dir" id="m_65k_af65002"><div class="i_dir">&nbsp;</div><a href="../af65002/index.html">af65002 </a>

<ul class="menu2" >
<li class="separator">Specification</li>
<li><div class="i_file">&nbsp;</div><a href="af65002front.html">Overview</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002regs.html">Register Set</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002opstruct.html">Opcode Structure</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002admodes.html">Addressing Modes</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002prefixes.html">Prefixes</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002opcodes.html">Opcodes Overview</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002opdesc.html">Opcode Description</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002int.html">Reset, Traps and Interrupts</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002hyper.html">User- and Hypervisor Mode</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002mem.html" class="mcurrent">Memory Management</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002config.html">Configuration Registers</a></li>
<li><div class="i_file">&nbsp;</div><a href="af65002compat.html">Compatibility</a></li>
<li class="separator">Implementation</li>
<li><div class="i_file">&nbsp;</div><a href="af65002arch.html">Architecture Overview</a></li>
</ul>
</li>
<li><div class="i_file">&nbsp;</div><a href="../tests.html">Test setup</a></li>
</ul>
</li>
<li class="dir" id="m_csa"><div class="i_dir">&nbsp;</div><a href="../../csa/index.html">CS/A65 Caspaer and Gecko computer</a>

</li>
<li class="dir" id="m_adv65"><div class="i_dir">&nbsp;</div><a href="../../adv65/index.html">Advanced 6502</a>

</li>
<li class="dir" id="m_hwinfo"><div class="i_dir">&nbsp;</div><a href="../../hwinfo/index.html">ICs and Standards Info</a>

</li>
<li class="dir" id="m_mischw"><div class="i_dir">&nbsp;</div><a href="../../mischw/index.html">Other hardware (e.g. tools)</a>

</li>
<li class="separator">Software</li>
<li><div class="i_file">&nbsp;</div><a href="../../osa/index.html">GeckOS operating system</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../../lib6502/index.html">Lib6502 standard</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../../o65/index.html">O65 file format</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../../usb65/index.html">usb65 USB drivers</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../../xd2031/index.html">XD2031 firmware</a>
</li>
<li><div class="i_file">&nbsp;</div><a href="../../misc/index.html">Misc software</a>
</li>
<li class="separator">Knowledge Bits</li>
<li class="dir" id="m_icapos"><div class="i_dir">&nbsp;</div><a href="../../icapos/index.html">Computer/OS Architecture</a>

</li>
<li class="dir" id="m_icaphw"><div class="i_dir">&nbsp;</div><a href="../../icaphw/index.html">6502 Hardware Bits</a>

</li>
<li class="separator">Misc</li>
<li><div class="i_file">&nbsp;</div><a href="../../contact.html">Contact</a></li>
<li><div class="i_file">&nbsp;</div><a href="../../sneak.html">Sneak preview</a></li>
<li><div class="i_file">&nbsp;</div><a href="../../design.html">Web design</a></li>
</ul>

</div>
		</div><div class="top" id="browser"><div class="tophead">browser</div><div>
			Site has been tested with a number of browsers and systems. Javascript required for advanced menu, but degrades gracefully without Javascript. IE6 not supported anymore!
			</div></div></div><div id="rightcol"><div class="top" id="google"><div class="tophead">search</div><div><form method="get" action="http://www.google.com/search" target="_blank"><input alt="search parameters" type="text" name="q" size="10" maxlength="255" value=""><input class="advbutton" type="submit" value="Search my site"><br>(Google, in new window)
	                        <input type="hidden" name="sitesearch" value="www.6502.org/users/andre"></form></div></div><div class="top" id="share"><div class="tophead">share</div><div><div id="socialshareprivacy"></div></div></div><div class="top" id="twitter"><div class="tophead">follow</div><div>
		            Follow my 8-bit tweets on<br><a class="extlink" target="_blank" href="https://twitter.com/#!/search/realtime/afachat%20%238bit">Twitter</a><br> (In new window)
		</div></div><div class="top" id="forum"><div class="tophead">discuss</div><div><p>Discuss my site on <a class="extlink" target="_blank" href="http://forum.6502.org/viewtopic.php?t=956">this 6502.org forum thread</a></p><p>(Forum registration required to post)</p></div></div><div class="top" id="hot"><div class="tophead">Hot!</div><div>
<p>Dive into the retro feeling and build yourself a <a href="../../cbmhw/ryofat40/index.html">Commodore PET replica</a></p>
<p>Need more speed? Speed up your 6502 computer with this <a href="../../adv65/pet816/index.html">10&nbsp;MHz 6502 CPU replacement board</a></p>
<p>Interested in electronics design? Look at the <a href="../../icaphw/design.html">design lesson</a> I got from Bil Herd, the hardware designer of the C128</p>
<p>Want 64bit? - pimp the 6502 with the <a href="../../65k/index.html">65k processor design!</a></p>

		</div></div></div><div id="midcol"><div class="top" id="ie6warn">
You are using an old MS Internet Explorer as browser. This version is not supported anymore. Please use a 
more modern browser, like Internet Explorer 8 or later, 
<a target="_blank" class="extlink" href="http://www.firefox.com">Firefox</a>,
<a target="_blank" class="extlink" href="http://www.google.com/chrome">Google Chrome</a>, or
<a target="_blank" class="extlink" href="http://www.opera.com">Opera</a>.
</div><div class="top" id="content"><div id="minmax"></div>
<div id="breadcrumbs">
<a href="../../index.html">Homepage</a>
&gt;&gt; <a href="../index.html">The 65k Project</a>&gt;&gt;  <a href="index.html">af65002
</a>&gt;&gt;  Memory Management</div>
<h1>65002 Memory Management</h1><div class="overview">
	<p>
	The 65k always has simple memory management capabilities.
	</p>
  </div><div id="toc" class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2>Table of content</h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><ul><li><a href="#mem">Memory Management</a></li><li style="list-style-type:none;"><ul><li><a href="#match">Match code</a></li></ul></li><li><a href="#con">Container Management</a></li><li style="list-style-type:none;"><ul><li><a href="#cont">Container</a></li><li><a href="#regmem">Memory Management Register</a></li><li><a href="#ctrl">Control bits</a></li></ul></li><li><a href="#mmu">Paged Memory Management Unit (MMU)</a></li></ul></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="mem">Memory Management</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><p>
        This section describes the memory management features of the 65k. Those features are
        optional. They are decoupled from the main core by the means of "match codes".
    </p><h3><a name="match">Match code</a></h3><p>
        The match code is an 8&nbsp; bit value set by the core, for every memory access.
        It is used by the MMU to select which translation should be used to translate from
        effective to physical address.
      </p></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="con">Container Management</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><p>This section describes the basic memory management containers</p>
    <h3><a name="cont">Container</a></h3><p>
        A container confines the processor into a defined address area. This is done by ANDing the
        effective address of the opcode with a bit mask, then comparing it with an address value.
        When the masked address equals the address value, the container address matches.
        Then a fixed offset is ORd with the
        result, to get the "confined address". The smallest memory area that can be confined is
        256 byte.
      </p><p>
        The processor has a number of such container definitions. Each definition is matched against
        the current effective address coming from the CPU. As the matchable memory area is
        at least 256 byte, the lowest 8&nbsp; bit in the mask and address value are used to match the matchcode:
        the 8&nbsp; bit matchcode is ANDed with the lowest 8 mask bits, then compared to the
        lowest 8 offset bits. If they are equal, then the container definition matches.
      </p><p>
        If multiple containers are matching the address and match code, then the container
        definition with the lowest number is effective.
        If no container matches (e.g. upon reset) then the effective address becomes the confined
        address without any translation.
      </p>
     <h3><a name="regmem">Memory Management Register</a></h3><p>The container management has a number of register sets. Each set contains three full size (W bits)
        registers:</p>
    <table border="1">
        <tr><th>Container-Register</th><th>Definition</th><th>Comment</th></tr>
        <tr><td>Addr/matchcode mask</td><td>0-7: matchcode mask<br>
                                        8-W: address mask</td><td></td></tr>
        <tr><td>Addr/matchcode compare value</td><td>0-7: matchcode compare value<br>
                                        8-W: address compare value</td><td></td></tr>
        <tr><td>Addr offset/container control</td><td>0-7: Container control<br>
                                        8-W: address offset value</td><td></td></tr>
    </table><p>
        There can be any number of register sets. The number can be read from a configuration register.
        If there are register sets, there must be at least four sets.
        For a full explanation see below.
    </p>
    <h3><a name="ctrl">Control bits</a></h3>
 	<p>
        In addition to mask and offset the container definition has an extra byte in the
        low 8&nbsp; bit of the address offset that determines memory mapping metadata: </p>
        <table border="1">
        <tr><th>Bit</th><th>Name</th><th>Function</th></tr>
        <tr><td>0</td><td>VALID</td><td>If set, the address mapping is valid. If the container
                                becomes effective, but the valid bit is not set, a Bus error condition
                                occurs</td></tr>
        <tr><td>1</td><td>HYPERVISOR</td><td>If set, the address mapping is only available in hypevisor
                                mode. If hypervisor mode is off, this mapping never matches</td></tr>
        <tr><td>2</td><td>READONLY</td><td>If set, the memory area mapped here is read-only, writes are ignored if TRAPWRITE
                                is not set</td></tr>
        <tr><td>3</td><td>TRAPWRITE</td><td>If set, and READONLY is set, then a bus error condition occurs on writes</td></tr>
        <tr><td>4</td><td>NOEXECUTE</td><td>If set, a bus error condition occurs when the processor
                                tries to read an opcode from this mapping</td></tr>
        <tr><td>5</td><td>TRANSIENT</td><td>If set, the memory address cannot be cached</td></tr>
        <tr><td>6/7</td><td>WIDTH</td><td>Memory access width. 00=8&nbsp; bit, 01=16&nbsp; bit, 10=32&nbsp; bit, 11=64&nbsp; bit.
                        If the width selected here is wider than the physical width, the upper bits are ignored on writes
                        and zero on reads.</td></tr>
        </table>
      <p>
        A memory management setup to emulate a Commodore PET would for example look like (in a 32&nbsp; bit option) the
        table below, where the matchcode $12 is assumed to be the PET's matchcode, the system's I/O is at $E0000000,
        Video memory at $D0000000 and normal bus is 16&nbsp; bit. The "PET emulator" memory is at $100000000.
        </p>
      <table border="1">
        <tr><th>Container#</th><th>Addr/Matchcode Mask</th><th>Addr/Matchcode value</th><th>Addr Offset/Container Control</th></tr>
        <tr><td>0</td><td>$FFFFFF/$FF</td><td>$0000E8/$12 (256 byte at $0000E800)</td><td>$E00000/%00110001 (8 Bit, TRANSIENT, NOEXECUTE, VALID)</td></tr>
        <tr><td>1</td><td>$FFFFF0/$FF</td><td>$000080/$12 (4kB at $00008000)</td><td>$D00000/%01110001 (16 Bit, TRANSIENT, NOEXECUTE, VALID)</td></tr>
        <tr><td>2</td><td>$FFFF80/$FF</td><td>$000000/$12 (32kB at $00000000)</td><td>$100000/%01000001 (16 Bit, VALID)</td></tr>
        <tr><td>3</td><td>$FFFF80/$FF</td><td>$000080/$12 (32kB at $00008000)</td><td>$100000/%01000101 (16 Bit, READONLY, VALID)</td></tr>
      </table><p>
        Using a matchcode mask of $FE instead of $FF in the first mapping would for example allow to share the
        mapping of container #0 between matchcode $12 and $13. This allows for shared memory segments.
      </p><p>
        Also note that the matching memory areas overlap. Here the preference rule says the one with the lower container
        number is effective.
      </p><p>
        The table shows that this type of mapping has some restrictions, it is not possible to arbitrarily map memory
        areas around, but it can still be used flexibly. The effective addresses for this approach are all
        starting at zero - you could for example emulate an 8k-only 6504 - but the address offset then
        translates the address to the correct physical address space.
      </p><p>
        Note: this section must be further worked over. There is no way to define a write-through cache (e.g. video memory
        could be written (slowly) to a video board, but mirrored and cached in fast memory. On the other hand is this
        situation very common? Writes to read-only memory could always trap, so TRAPWRITE would not be needed.
        Are there two WIDTH bits required? Would not one bit be enough to indicate 8&nbsp; bit access. This would
        suffice for compatibility. Also it would allow to have the default to "native" width - in the current
        proposal above the processor must know which memory access width it actually uses to write the correct
        width value.
      </p></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2><a name="mmu">Paged Memory Management Unit (MMU)</a></h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c"><p>
	The 65002 does not have an MMU.
      </p></div></div><div class="h2"><div class="h2h"><div class="h2t">&nbsp;</div><h2>Disclaimer</h2><div class="toplink"><a href="#top">Top</a></div></div><div class="h2c">
All Copyrights are acknowledged.
The information here is provided under the terms as described
in <a href="af65002front.html#lic">the license section</a>.
    </div></div><hr>
Last updated 2012-04-29.
  </div></div><div id="footer">&nbsp;</div></div><script type="text/javascript">myUp="../../";</script><script type="text/javascript" src="../../scripts-all.js"></script><script type="text/javascript" src="../../jquery.socialshareprivacy.js"></script><script type="text/javascript">
          jQuery(document).ready(function($){
                  if($('#socialshareprivacy').length != 0){
                            $('#socialshareprivacy').socialSharePrivacy();
                  }
          });
  </script></body></html> 
